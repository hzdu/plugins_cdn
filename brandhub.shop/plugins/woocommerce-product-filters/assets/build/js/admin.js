(()=>{"use strict";function e(e){return jQuery(e)}class t{constructor(){this.objectContainer=new Map,this.componentRegister=new Map,this.packageRegister=new Map}get bodyElement(){return e(document.body)}get windowElement(){return e(window)}initialization(){}}class n{constructor(){this.defaultContext=null,this.callbacks=[]}subscribe(e,t){!t&&this.defaultContext&&(t=this.defaultContext),t||(t=e);let n=this,o={callback:e,event:n,unsubscribe:function(){n.unsubscribe(e)}};return this.callbacks.push({callback:e,subscriber:t}),o}unsubscribe(e,t){!t&&this.defaultContext&&(t=this.defaultContext),t||(t=e);let n=[];for(let o=0;o<this.callbacks.length;o++)this.callbacks[o].callback!==e&&this.callbacks[o].subscriber!==t&&n.push(this.callbacks[o]);this.callbacks=n}trigger(e,t){for(let n=0;n<this.callbacks.length;n++)this.callbacks[n].callback.apply(this.callbacks[n].subscriber,[e,t])}}const o=class{constructor(){this.componentList=new Set,this.subpackageList=new Set,this.collectAfter=new n}initialProperties(){}getInitialSubpackages(){return[]}};class i{buildByClass(e,t,n){let o=this.createPackageByClass(e,t,n);return this.build(o,t,n)}build(e,t,n){return e.app=t,e.parentPackage=n,this.createInteraction(e,t,n),this.afterInteractionBuilding(e,t),this.packageInitialProperties(e),this.packageAttachEvents(e),e.collectAfter.trigger(e),e}packageAttachEvents(e){e.componentList.forEach((e=>{e.attachEvents(e.eventManager)})),e.subpackageList.forEach((e=>{this.packageAttachEvents(e)}))}packageInitialProperties(e){e.initialProperties(),e.componentList.forEach((e=>{e.initialProperties()})),e.subpackageList.forEach((e=>{this.packageInitialProperties(e)}))}createInteraction(e,t,n){let i=e.getInitialSubpackages(),r=e.getInitialComponents();r&&r.forEach((t=>{t.package=e,e.componentList.add(t)})),i&&(i.forEach((n=>{let i=null;n instanceof o?(i=n,i.app=t,i.parentPackage=e):i=this.createPackageByClass(n,e.app,e),e.subpackageList.add(i)})),e.subpackageList.forEach((e=>{this.createInteraction(e,e.app,e.parentPackage)})))}createPackageByClass(e,t,n){if(!(e.prototype instanceof o))throw new TypeError('Ð¡lass does not implement class "PackageAbstract"');let i=new e;return i.app=t,i.parentPackage=n,i}afterInteractionBuilding(e,t){e.afterInteractionBuilding&&e.afterInteractionBuilding(t),e.componentList.size&&e.componentList.forEach((e=>{e.afterInteractionBuilding&&e.afterInteractionBuilding(t)})),e.subpackageList.size&&e.subpackageList.forEach((e=>{this.afterInteractionBuilding(e,t)}))}}class r{build(e,t){let n=new e;return t&&this.implementation(n,t),n}implementation(e,t){e.package=t,e.initialProperties(),e.attachEvents(e.eventManager)}}function s(e,t){let n="";for(;;){let t=e.getParentEntity();if(!e.rootSelector){if(t){e=t;continue}break}if(n=0==n.length?e.rootSelector:e.rootSelector+" "+n,!t)break;e=t}return t&&(0==n.length?n=t:n+=" "+t),n}function a(e,t){return jQuery.proxy(e,t)}class l{constructor(t){this.component=t,this.rootElement=e(document.documentElement)}addWindowHandler(t,n,o){this.applyElementHandler(!0,{element:e(window),event:t,eventSelector:null,eventHandler:n,context:o})}removeWindowHandler(t,n,o){this.applyElementHandler(!1,{element:e(window),event:t,eventSelector:null,eventHandler:n,context:o})}addSystemHandler(e,t,n){n=this.getContext(n),e.subscribe(t,n)}removeSystemHandler(e,t,n){n=this.getContext(n),e.unsubscribe(t,n)}addElementHandler(e,t,n,o,i){this.applyElementHandler(!0,{element:e,event:t,eventSelector:n,eventHandler:o,context:i})}removeElementHandler(e,t,n,o,i){this.applyElementHandler(!1,{element:e,event:t,eventSelector:n,eventHandler:o,context:i})}applyElementHandler(e,t){t.context=this.getContext(t.context),t.eventSelector instanceof Function&&!t.eventHandler&&(t.eventHandler=t.eventSelector,t.eventSelector=""),t.context&&(t.eventHandler=a(t.eventHandler,t.context)),t.element instanceof Element&&(t.element=jQuery(t.element)),e?t.eventSelector?t.element.on(t.event,t.eventSelector,t.eventHandler):t.element.on(t.event,t.eventHandler):t.eventSelector?t.element.off(t.event,t.eventSelector,t.eventHandler):t.element.off(t.event,t.eventHandler)}getContext(e){return!e&&this.component&&(e=this.component),e}addEntityHandler(e,t,n,o,i){let r="",l=n;"string"==typeof n&&o instanceof Function&&(r=n,l=o),i||!o||o instanceof Function||(i=o),(i=this.getContext(i))&&(l=a(l,i));let p=s(e,r);this.rootElement.on(t,p,l)}removeEntityHandler(e,t,n,o,i){let r="",l=n;"string"==typeof n&&o instanceof Function&&(r=n,l=o),i||!o||o instanceof Function||(i=o),(i=this.getContext(i))&&(l=a(l,i));let p=s(e,r);this.rootElement.off(t,p,l)}addComponentHandler(e,t,n,o){this.addEntityHandler(this.component,e,t,n,o)}removeComponentHandler(e,t,n,o){this.removeEntityHandler(this.component,e,t,n,o)}addPackageHandler(e,t,n,o){this.addEntityHandler(this.component.package,e,t,n,o)}removePackageHandler(e,t,n,o){this.removeEntityHandler(this.component.package,e,t,n,o)}addPageElementHandler(e,t,n,o){this.applyElementHandler(!0,{element:this.rootElement,event:e,eventSelector:t,eventHandler:n,context:o})}removePageElementHandler(e,t,n,o){this.applyElementHandler(!1,{element:this.rootElement,event:e,eventSelector:t,eventHandler:n,context:o})}}const p=class{constructor(e){this.eventManager=e||new l(this)}get app(){return this.package.app}initialProperties(){}};function c(e,t){return jQuery.extend(e,t)}class d{}var h;!function(e){e.remove="remove",e.virtual="virtual",e.published="published"}(h||(h={}));const u=h;class m extends p{get register(){return this.app.objectContainer.get("Entity/Register")}initialProperties(){this.app.componentRegister.set("Entity/Collector",this)}attachEvents(e){}collectVirtualEntityByKey(e){let t=null;if(!this.register.has(e))throw new Error(`Entry by key '${e}' in register not found`);let n=this.register.get(e);return t=new d,t.status=u.virtual,t.entityId=this.createUniqueID(),t.parentId=0,t.entityKey=n.id,t.order=0,t.options=c({},n.defaultOptions),t.title=n.label,t.childEntities=[],t}collectEntityByStructure(e){let t=null;if(t=new d,t.status=u.published,t.entityId=e.entityId,t.parentId=e.parentId,t.entityKey=e.entityKey,t.order=Number(e.order),t.options=c({},e.options),t.title=e.title,t.childEntities=[],e.childEntities&&e.childEntities.hasOwnProperty("length")&&e.childEntities.length)for(let n in e.childEntities){if(!e.childEntities.hasOwnProperty(n))continue;let o=e.childEntities[n],i=this.collectEntityByStructure(o);t.childEntities.push(i)}return t}createUniqueID(){let e=()=>Math.random().toString(16).slice(-4);return"virtual-"+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}}class g extends o{initialProperties(){let e=new Map;this.app.objectContainer.set("Entity/Register",e)}getInitialComponents(){return[new m]}}class y extends p{initialProperties(){this.options={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"},this.app.componentRegister.set("TemplateLoader",this)}attachEvents(e){}loadTemplate(e,t){return null==t&&(t={}),window._.template(e,this.options)(t)}}class E extends o{getInitialComponents(){return[new y]}}class f extends o{initialProperties(){this.app.objectContainer.set("Editor/Component/Prototypes",new Map)}getInitialComponents(){return[]}}class v extends o{initialProperties(){this.app.objectContainer.set("Editor/Panel/Prototypes",new Map)}getInitialComponents(){return[]}}const C=class extends p{constructor(e){super(),e&&(e instanceof Element&&(e=jQuery(e)),this.componentElement=e)}addElementHandler(e,t,n,o){this.eventManager.addElementHandler(this.componentElement,e,t,n,o)}removeElementHandler(e,t,n,o){this.eventManager.removeElementHandler(this.componentElement,e,t,n,o)}replaceComponentElementKeepFocus(e){const t=this.buildFocusedElementSelector();this.componentElement.replaceWith(e),this.refocusElement(t)}buildFocusedElementSelector(){const e=[];let t=document.activeElement;for(;t&&t!==document.body&&"div.wcpf-filter"!==e[e.length-1];)e.push(this.buildSelector(t)),t=t.parentElement;return 0===e.length?null:e.reverse().join(" > ")}buildSelector(e){return e.tagName.toLowerCase()+Array.from(e.attributes).map((t=>{if("class"===t.name.toLowerCase()){const e=t.value.replace(" ui-state-focus","");return`[${t.name}*="${e}"]`}if("style"===t.name.toLowerCase()&&e.classList.contains("ui-slider-handle")){const e=t.value.replace(/(\d+)\.?\d*%;/g,"$1");return`[${t.name}*="${e}"]`}if("style"!==t.name.toLowerCase())return`[${t.name}="${t.value.replace(/"/g,'\\"')}"]`})).join("")}refocusElement(e){if(null===e)return;let t=0;const n=function(){t++;try{const t=document.querySelector(e);t&&(t.focus(),clearInterval(o))}catch(e){}t>=20&&clearInterval(o)},o=setInterval(n,50);n()}},P=class extends C{get prototypes(){return{projection:this.app.objectContainer.get("Editor/Projection/Prototypes"),panelLayout:this.app.objectContainer.get("Editor/PanelLayout/Prototypes"),panel:this.app.objectContainer.get("Editor/Panel/Prototypes"),component:this.app.objectContainer.get("Editor/Component/Prototypes"),control:this.app.objectContainer.get("Editor/Control/Prototypes"),controlSource:this.app.objectContainer.get("Editor/Control/Source/Prototypes")}}get register(){return{panelStructures:this.app.objectContainer.get("Editor/Panel/Structures"),components:this.app.objectContainer.get("Editor/Components"),entityTypes:this.app.objectContainer.get("Entity/Register"),componentPresets:this.app.objectContainer.get("Editor/Component/Presets"),controlRulesOperations:this.app.objectContainer.get("Editor/Control/RulesOperation")}}get builders(){return{control:this.app.componentRegister.get("Editor/Builder/Control"),panel:this.app.componentRegister.get("Editor/Builder/Panel"),panelLayout:this.app.componentRegister.get("Editor/Builder/PanelLayout"),projection:this.app.componentRegister.get("Editor/Builder/Projection"),component:this.app.componentRegister.get("Editor/Builder/Component")}}get projectEditorComponent(){return this.app.objectContainer.get("Editor/ProjectComponent")}get projectEntity(){return this.app.objectContainer.get("Editor/ProjectEntity")}get componentBuilder(){return this.app.objectContainer.get("ComponentBuilder")}get entityCollector(){return this.app.componentRegister.get("Entity/Collector")}get editorPackage(){return this.app.packageRegister.get("Editor/Package")}get localizedMessages(){return this.app.objectContainer.get("Messages")}get panelManager(){return this.app.componentRegister.get("Editor/PanelManager")}get projectionManager(){return this.app.componentRegister.get("Editor/ProjectionManager")}get templateLoader(){return this.app.componentRegister.get("TemplateLoader")}},w=class extends P{constructor(){super(),this.isControlsSavedProp=!0,this.controls=new Map,this.isControlsSavedChangedEvent=new n}get isControlsSaved(){return this.isControlsSavedProp}set isControlsSaved(e){let t=this.isControlsSavedProp;this.isControlsSavedProp=e,t!=e&&this.isControlsSavedChangedEvent.trigger({panelLayout:this,value:e})}get controlBuilder(){return this.app.componentRegister.get("Editor/Control/Builder")}get panelAutoSave(){return this.panelStructure.panelAutoSave}get panelId(){return this.panelStructure.panelId}get panelTitle(){return this.panelStructure.panelTitle}get controlElements(){return this.componentElement.find(".control[data-control-type]")}createControl(e){let t=this.builders.control.createControl(e,this),n=this.getControlElement(e.controlKey,e.optionKey);if(!n.length)throw new Error(`Element for option '${e.optionKey}' not found`);return t.componentElement=n,this.componentBuilder.implementation(t.controlSource,this.package),this.componentBuilder.implementation(t,this.package),this.eventManager.addSystemHandler(t.valueChangedEvent,this.onControlValueChanged),this.controls.set(t.optionKey,t),t}getControlElement(e,t){return this.controlElements.filter(`[data-control-type="${e}"][data-option-key="${t}"]`)}onControlValueChanged(e){this.panelAutoSave?(e.control.controlSource.saveValue(),this.isControlsSaved=!0):this.isControlsSaved=!1}attachEvents(e){}};function b(e){return jQuery(e.currentTarget)}class j extends w{attachEvents(e){super.attachEvents(e),e.addElementHandler(this.componentElement,"click",".tabs-heading-wrapper .tab-heading:not(.active-tab)",this.onTabClick),"validate"in this.panel&&this.panel.hasOwnProperty("validateEvent")&&e.addSystemHandler(this.panel.validateEvent,this.onValidatePanel)}onValidatePanel(){this.componentElement.find(".tab-content").each(((t,n)=>{let o=e(n),i=o.data("tab-id"),r=this.componentElement.find(`.tab-heading[data-tab-id="${i}"]`),s=!1;for(let t of o.find(".error:not(.control-element)"))if(e(t).html().length){s=!0;break}s?r.addClass("exists-errors"):r.removeClass("exists-errors")}))}onTabClick(e){let t=b(e),n=t.data("tab-id");this.componentElement.find(".tab-heading.active-tab,.tab-content.active-tab").removeClass("active-tab"),t.addClass("active-tab"),this.componentElement.find(`.tab-content[data-tab-id="${n}"]`).addClass("active-tab")}assembleControls(e){let t=e.tabs;for(let e in t){let n=t[e];if(n.length)for(let e in n){let t=n[e];this.createControl(t)}}}}class O extends w{assembleControls(e){let t=e.controls;for(let e of t)this.createControl(e)}}class k extends o{initialProperties(){this.app.objectContainer.set("Editor/PanelLayout/Prototypes",new Map([["Tabs",j],["List",O]])),this.app.objectContainer.set("Editor/Panel/Structures",new Map)}getInitialComponents(){return[]}}class S extends o{initialProperties(){this.app.objectContainer.set("Editor/Projection/Prototypes",new Map)}getInitialComponents(){return[]}}var I;!function(e){e[e.Launched=0]="Launched",e[e.Active=1]="Active",e[e.Inactive=2]="Inactive",e[e.Destroyed=3]="Destroyed",e[e.None=4]="None"}(I||(I={}));const V=I;function R(e){return class extends e{constructor(){super(...arguments),this.needReloadControl=!1}get controlLoader(){return this.app.componentRegister.get("Editor/Control/ControlLoader")}initialProperties(){super.initialProperties(),this.panel.status!=V.None&&this.initializeReloadRules()}checkDisplayRules(){super.checkDisplayRules(),this.needReloadControl&&this.isActiveControl&&(this.controlLoader.reloadControl(this),this.needReloadControl=!1)}onPanelStatusChanged(e){super.onPanelStatusChanged(e),e.status==V.Launched&&this.initializeReloadRules()}initializeReloadRules(){let t=this.controlStructure;if(t.reloadAfterInit&&(this.checkRules(this.controlStructure.displayRules)?this.controlLoader.reloadControl(this,(()=>{this.restoreOptionValue()})):this.needReloadControl=!0),t.optionsDepends)for(let e of t.optionsDepends.values()){let t=this.getControlByOptionKey(e);t&&this.eventManager.addSystemHandler(t.valueChangedEvent,(()=>{this.checkRules(this.controlStructure.displayRules)?(this.controlLoader.reloadControl(this,(()=>{"afterReloadDependentOption"in this?this.afterReloadDependentOption():this.optionValue=this.getEmptyValue()})),this.needReloadControl=!1):this.needReloadControl=!0}))}"initializeReloadRules"in e.prototype&&super.initializeReloadRules()}}}function x(e,t){return Object.getPrototypeOf(e)===Object.getPrototypeOf(t)&&void 0!==e.length&&e.length===t.length&&Array.prototype.every.call(e,((e,n)=>e===t[n]))}function K(e,t){for(let n in e){if(e.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;let o=typeof e[n];if("object"==o){if(!K(e[n],t[n]))return!1}else if("function"==o){if(void 0===t[n]||e[n].toString()!=t[n].toString())return!1}else if(e[n]!=t[n])return!1}for(let n in t)if(void 0===e[n])return!1;return!0}class L extends P{constructor(){super(...arguments),this.parentControl=null,this.contextControls=new Map,this.valueChangedEvent=new n}get panel(){return this.panelLayout.panel}get controlKey(){return this.controlStructure.controlKey}get controlLabel(){return this.controlStructure.controlLabel}get optionKey(){return this.controlStructure.optionKey}get optionValue(){return this.optionValueProp}set optionValue(e){let t=this.optionValueProp,n=!0;this.optionValueProp=e,typeof t!=typeof e||t&&Array.isArray(t)&&!x(t,e)?n=!1:!t||Array.isArray(t)||"object"!=typeof t||K(t,e)?"object"!=typeof t&&t!=e&&(n=!1):n=!1,n||this.valueChangedEvent.trigger({oldValue:t,value:e,control:this})}get isActiveControl(){return!this.componentElement.hasClass("control-inactive")}set isActiveControl(e){e?(this.componentElement.removeClass("control-inactive"),this.showControlElement()):(this.componentElement.addClass("control-inactive"),this.hideControlElement())}showControlElement(){this.componentElement.slideDown(400)}hideControlElement(){this.componentElement.slideUp(400)}getEmptyValue(){return null}saveOptionValue(){this.controlSource.saveValue()}restoreOptionValue(){this.optionValueProp=this.controlSource.getValue()}initialProperties(){this.restoreOptionValue(),this.panel.status!=V.None&&this.initializeDisplayRules()}attachEvents(e){e.addSystemHandler(this.panel.statusChangedEvent,this.onPanelStatusChanged)}restoreDefaultOptionValue(e){this.controlStructure.defaultValue&&(e&&null==this.optionValue||!e)&&(this.optionValue=this.controlStructure.defaultValue)}initializeDisplayRules(){"object"==typeof this.controlStructure.displayRules&&Object.keys(this.controlStructure.displayRules).length?(this.attachObserversAccordingToRules(this.controlStructure.displayRules),this.checkDisplayRules()):this.restoreDefaultOptionValue(!0)}onPanelStatusChanged(e){e.status==V.Launched&&this.initializeDisplayRules()}attachObserversAccordingToRules(e){if(!(e.hasOwnProperty("relation")&&e.length-1==0||!e.hasOwnProperty("relation")&&0===e.length))for(let t in e){let n=e[t];if("relation"!=t)if(n.hasOwnProperty("relation")||!n.hasOwnProperty("optionKey"))this.attachObserversAccordingToRules(n);else{let e=this.getControlByOptionKey(n.optionKey);if(!e)continue;this.eventManager.addSystemHandler(e.valueChangedEvent,this.checkDisplayRules)}}}checkDisplayRules(){this.isActiveControl=this.checkRules(this.controlStructure.displayRules),this.isActiveControl&&this.restoreDefaultOptionValue(!0)}checkRules(e){let t="AND",n=Object.keys(e).length;if(e.hasOwnProperty("relation")&&(t=e.relation,n--),!n)return!0;for(let n in e){if("relation"==n)continue;let o=e[n],i=null;if(o.hasOwnProperty("relation")||!o.hasOwnProperty("optionKey"))i=this.checkRules(o);else{let e=this.getControlByOptionKey(o.optionKey);if(!e)continue;let t=e.optionValue,n=o.operation;if(!this.register.controlRulesOperations.has(n))continue;i=this.register.controlRulesOperations.get(n)(t,o)}if("AND"==t&&!i)return!1;if("OR"==t&&i)return!0}return"AND"==t}getControlByOptionKey(e){if(this.contextControls.has(e))return this.contextControls.get(e);if(this.parentControl instanceof L){let t=this.parentControl,n=null;for(;t;){if(n=t.getControlByOptionKey(e),n instanceof L)return n;if(!(t.parentControl instanceof L))break;t=t.parentControl}}return this.panelLayout.controls.has(e)?this.panelLayout.controls.get(e):null}}const M=L,H=class extends M{constructor(){super(...arguments),this.isAttached=!1}get controlElement(){return this.componentElement.find(".control-element")}attachEvents(e){super.attachEvents(e),e.addSystemHandler(this.valueChangedEvent,this.onValueChangedEvent),this.isAttached=!0}restoreDefaultOptionValue(e){super.restoreDefaultOptionValue(e),!this.isAttached&&this.optionValue&&this.setElementValue(this.optionValue)}onValueChangedEvent(e){this.setElementValue(e.value)}restoreOptionValue(){super.restoreOptionValue(),this.setElementValue(this.optionValueProp)}updateValueFromElement(){this.optionValue=this.getElementValue()}};let T=class extends H{attachEvents(e){super.attachEvents(e),e.addElementHandler(this.componentElement,"change",".control-element",this.updateValueFromElement)}getEmptyValue(){return""}setElementValue(e){"string"!=typeof e&&(e=""),this.controlElement.val(e)}getElementValue(){return this.controlElement.val()}reloadControl(e){let t=e.controlElement.find(".control-element");this.controlElement.html(t.html())}};T=function(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}([R],T);const A=T;class B extends H{attachEvents(e){super.attachEvents(e),e.addElementHandler(this.controlElement,"change paste keyup",this.updateValueFromElement)}getEmptyValue(){return""}setElementValue(e){"string"!=typeof e&&(e=""),this.controlElement.val(e)}getElementValue(){return this.controlElement.val()}}class $ extends H{attachEvents(e){super.attachEvents(e),e.addPageElementHandler("change",".control-element",this.updateValueFromElement)}getEmptyValue(){return[]}setElementValue(e){this.controlElement.filter(":checked").prop("checked",!1),"string"==typeof e&&this.controlElement.filter(`[value="${e}"]`).prop("checked",!0)}getElementValue(){let e=this.controlElement.filter(":checked");if(e.length)return e.val()}}class q extends H{get unitSelectElement(){return this.componentElement.find(".select-unit")}attachEvents(e){super.attachEvents(e),e.addElementHandler(this.controlElement,"change paste keyup",this.updateValueFromElement),e.addElementHandler(this.unitSelectElement,"change",this.updateValueFromElement)}updateValueFromElement(){let e=this.controlElement.val();e=e.replace(/[^0-9\.]/g,""),this.controlElement.val(e),super.updateValueFromElement()}setElementValue(e){if("number"==typeof e&&(e+=""),"string"==typeof e&&e.length){let t=this.parseUnit(e);"string"!=typeof t[0]&&"number"!=typeof t[0]||isNaN(t[0])||this.controlElement.val(t[0]),this.unitSelectElement.val(t[1])}else this.controlElement.val(""),this.unitSelectElement.val("")}getElementValue(){let e=this.controlElement.val(),t=this.unitSelectElement.val();return e.length&&(e=parseFloat(e)),e+t}parseUnit(e){return"string"!=typeof e?[0,""]:[parseFloat(e),e.match(/[\d.\-\+]*\s*(.*)/)[1]||""]}}class F extends H{get firstOption(){return this.controlStructure.firstOption}get secondOption(){return this.controlStructure.secondOption}attachEvents(e){super.attachEvents(e),e.addElementHandler(this.controlElement,"change",this.updateValueFromElement)}setElementValue(e){e==this.firstOption.value?this.controlElement.prop("checked",!0):this.controlElement.prop("checked",!1)}getElementValue(){return this.controlElement.prop("checked")?this.firstOption.value:this.secondOption.value}}function D(e){let t=[];for(let n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}let Q=class extends H{attachEvents(e){super.attachEvents(e),e.addElementHandler(this.componentElement,"change",".control-element",this.updateValueFromElement)}getEmptyValue(){return[]}setElementValue(e){if(null==e||null==e?e=[]:"string"==typeof e?e=[e]:Array.isArray(e)||"object"!=typeof e||(e=D(e)),this.controlElement.filter(":checked").prop("checked",!1),Array.isArray(e))for(let t of e.values())this.controlElement.filter(`[value="${t}"]`).prop("checked",!0)}getElementValue(){let t=[];return this.controlElement.filter(":checked").map(((n,o)=>{let i=e(o);t.push(i.val())})),t}reloadControl(e){let t=e.controlElement.find(".check-box-list");this.componentElement.find(".check-box-list").html(t.html())}};Q=function(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}([R],Q);const _=Q;function z(e){return JSON.parse(JSON.stringify(e))}let U=class extends M{constructor(){super(...arguments),this.childControls=[],this.reloadControlsQueue=[]}get controlLoader(){return this.app.componentRegister.get("Editor/Control/ControlLoader")}get itemsElement(){return this.listElement.find("> .repeater-item")}get listElement(){return this.componentElement.find(".repeater-list:first")}initialProperties(){super.initialProperties(),this.listElement.sortable({items:"> .repeater-item",handle:".sorting-repeater-item-handle",update:(e,t)=>{this.onItemMove()}})}restoreOptionValue(){let e=this.controlSource.getValue();"object"!=typeof e&&(e=[]),this.optionValueProp=e,this.changeValue(e)}initializeReloadRules(){let e=this.controlStructure.itemOptionsDepends,t=[];if(Object.keys(e).length)for(let n in e){let o=e[n];for(let e of o.values()){if(-1!==t.indexOf(e))continue;t.push(e);let n=this.getControlByOptionKey(e);n&&this.eventManager.addSystemHandler(n.valueChangedEvent,this.onItemDependChange)}}}attachEvents(e){super.attachEvents(e),this.panel.hasOwnProperty("afterInitValidationEvent")&&e.addSystemHandler(this.panel.afterInitValidationEvent,this.addRulesToRepeaterItems),e.addElementHandler(this.componentElement,"click",".repeater-bottom-navigation .add-item",this.onAddItemClick),e.addElementHandler(this.componentElement,"click",`.navigation-repeater-item[data-repeater-key="${this.optionKey}"] .add-empty-item`,this.onAddBeforeItemClick),e.addElementHandler(this.componentElement,"click",`.navigation-repeater-item[data-repeater-key="${this.optionKey}"] .remove-item`,this.onRemoveItemClick),e.addSystemHandler(this.valueChangedEvent,this.onValueChangedEvent)}onItemMove(){let t=[],n=[];this.itemsElement.each(((o,i)=>{let r=e(i),s=r.attr("data-index");r.hasClass("ui-sortable-placeholder")||(t.push(this.optionValue[s]),n.push(this.childControls[s]))})),this.childControls=n,this.optionValue=z(t)}onValueChangedEvent(e){this.changeValue(e.value)}onRemoveItemClick(t){let n=e(t.currentTarget).parents(".repeater-item:first"),o=parseInt(n.attr("data-index")),i=z(this.optionValue);n.remove(),this.optionValue.splice(o,1),this.childControls.splice(o,1),this.refreshIndexes(),this.changeEventWithoutProcessing({oldValue:i,newValue:this.optionValue})}onAddBeforeItemClick(t){let n=e(t.currentTarget).parents(".repeater-item:first"),o=parseInt(n.attr("data-index")),i=z(this.optionValue);this.optionValue.splice(o,0,{}),this.childControls.splice(o,0,{}),this.createItem(o,{refreshIndexes:!0}),this.changeEventWithoutProcessing({oldValue:i,newValue:this.optionValue})}onAddItemClick(e){this.createItem(-1)}changeValue(e){if(null==e||null==e?e=[]:Array.isArray(e)||"object"!=typeof e||(e=D(e),this.optionValueProp=e),Array.isArray(e)){if(e.length<this.childControls.length){for(let t=e.length;t<this.childControls.length;t++){let e=Object.keys(this.childControls[t])[0];this.childControls[t][e].componentElement.parents(".repeater-item:first").remove()}this.childControls.splice(e.length)}this.refreshIndexes();for(let[t,n]of e.entries())if(this.childControls.length-1>=t)for(let e in this.childControls[t]){let o=this.childControls[t][e];n.hasOwnProperty(e)?o.optionValue=n[e]:o.controlStructure.defaultValue?o.optionValue=o.controlStructure.defaultValue:o.optionValue=o.getEmptyValue()}else this.createItem(t,{reloadAfterInit:!1});this.reloadControlsQueue.length&&(this.controlLoader.reloadControls(this.reloadControlsQueue,(e=>{for(let t of e)t.restoreOptionValue()})),this.reloadControlsQueue=[])}}refreshIndexes(){for(let[e,t]of this.optionValue.entries()){let t=this.itemsElement.eq(e);t.attr("data-index",e),t.find(`.sorting-repeater-item-handle[data-repeater-key="${this.optionKey}"] .index`).html(e+1+"");for(let t in this.childControls[e]){let n=this.childControls[e][t],o=n.optionKey,i=this.optionKey+"."+e+"."+t;n.componentElement.attr("data-option-key",i),n.controlStructure.optionKey=i,n.controlSource.optionKey=e+"."+t,n.componentElement.find(`[name="${o}"]`).attr("name",i),n instanceof $&&n.setElementValue(n.optionValue)}}let e=this.panel.formElement.data("validator");if(e&&Object.keys(e.invalid).length)for(let t in e.invalid)this.panel.formElement.find(`[id="${t}-error"]`).remove()}reloadControl(e){let t=this.controlStructure.resetValueOnReload;t&&(this.optionValue=[]);let n=e.controlElement.find("> .control-content > .repeater-item-template");this.componentElement.find("> .control-content > .repeater-item-template").html(n.html()),t||this.changeValue(this.optionValue)}renderRepeaterItem(e){return`\n            <div class="repeater-item" data-index="${e}">\n                <div class="repeater-item-handle sorting-repeater-item-handle" data-repeater-key="${this.optionKey}">\n                    <span class="index">${e+1}</span>\n                </div>\n                <div class="repeater-item-controls"></div>\n                <div class="repeater-item-handle navigation-repeater-item" data-repeater-key="${this.optionKey}">\n                    <div class="add-empty-item"></div>\n                    <div class="remove-item"></div>\n                </div>\n            </div>\n        `}addRulesToRepeaterItems(){let e=this.panel.formElement.data("validator");if(!e)return;let t=e.settings.rules,n=!1;if(t.hasOwnProperty(this.optionKey))n=t[this.optionKey];else for(let e in t){if(-1!==e.indexOf("*"))continue;let o=e.replace(/\./g,"\\.").split("*").join("([a-zA-Z\\d]+)");if(new RegExp(o).test(this.optionKey)){n=t[e];break}}if(n&&"object"==typeof n&&n.hasOwnProperty("repeaterItem")&&"object"==typeof n.repeaterItem)for(let e in this.childControls)for(let o in this.childControls[e]){let i=this.childControls[e][o];n.repeaterItem.hasOwnProperty(o)&&(t[i.optionKey]=n.repeaterItem[o])}}createItem(t,n){n=Object.assign({reloadAfterInit:!0,refreshIndexes:!1},n),-1==t&&(t=this.childControls.length),this.childControls[t]={};let o=new Map,i=this.controlStructure.controlStructures,r=e(this.renderRepeaterItem(t)),s=r.find(".repeater-item-controls"),a=this.componentElement.find(".repeater-list > .repeater-item").eq(t);t!=this.childControls.length&&a.length?a.before(r):this.componentElement.find(".repeater-list").append(r),n.refreshIndexes&&this.refreshIndexes();for(let e in i){let r=Object.assign({},i[e]),a=this.optionKey+"."+t+"."+e,l=r.optionKey;r.optionKey=a,r.controlSource="container";let p=this.builders.control.createControl(r,this.panelLayout),c=this.componentElement.find(`.repeater-item-template .control[data-control-type="${r.controlKey}"][data-option-key="${l}"]`);c.length&&(!n.reloadAfterInit&&r.hasOwnProperty("reloadAfterInit")&&r.reloadAfterInit&&(r.reloadAfterInit=!1,this.reloadControlsQueue.push(p)),o.set(this.optionKey+".repeaterItem."+e,p),o.set("repeaterItem."+e,p),p.contextControls=o,c=c.clone(),c.attr("data-option-key",a),c.find(`[name="${l}"]`).attr("name",a),p.parentControl=this,p.componentElement=c,p.controlSource.optionsContainer=this.optionValueProp,p.controlSource.optionKey=t+"."+e,s.append(c),this.componentBuilder.implementation(p.controlSource,this.package),this.eventManager.addSystemHandler(p.valueChangedEvent,this.onChildControlValueChanged),this.childControls[t][e]=p)}for(let e in this.childControls[t]){let n=this.childControls[t][e];this.componentBuilder.implementation(n,this.package)}this.panel.status==V.Active&&this.addRulesToRepeaterItems()}onChildControlValueChanged(e){let t=z(this.optionValue),n=e.control.controlSource,o=n.optionsContainer;Array.isArray(t)||(t=D(this.optionValue));let i=z(t);n.optionsContainer=i,n.saveValue(),this.optionValueProp=i,n.optionsContainer=o,x(t,this.optionValue)||this.changeEventWithoutProcessing({oldValue:t,newValue:this.optionValue})}changeEventWithoutProcessing(e){this.eventManager.removeSystemHandler(this.valueChangedEvent,this.onValueChangedEvent),this.valueChangedEvent.trigger({oldValue:e.oldValue,value:e.newValue,control:this}),this.eventManager.addSystemHandler(this.valueChangedEvent,this.onValueChangedEvent)}onItemDependChange(e){let t=this.controlStructure.itemOptionsDepends,n=e.control.optionKey,o=[],i=[];if(Object.keys(t).length)for(let e in t)-1===t[e].indexOf(n)||o.push(e);for(let e of o.values())for(let[t,n]of this.childControls.entries())n.hasOwnProperty(e)&&i.push(n[e]);i.length&&this.controlLoader.reloadControls(i,(e=>{for(let t of e)t.optionValue=t.getEmptyValue()}))}};U=function(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}([R],U);const W=U;class G extends H{showControlElement(){this.componentElement.show()}hideControlElement(){this.componentElement.hide()}get colorPickerElement(){return this.componentElement.find(".color-picker-element")}initialProperties(){let e=()=>{this.updateValueFromElement()};this.colorPickerElement.wpColorPicker({hide:!0,change:e,clear:e}),super.initialProperties()}setElementValue(e){"string"!=typeof e&&(e=""),e.length?this.colorPickerElement.wpColorPicker("color",e):this.colorPickerElement.iris("color","")}getElementValue(){return this.colorPickerElement.wpColorPicker("color")}}class N extends M{constructor(){super(...arguments),this.isAttached=!1,this.attachmentQuery=null}initialProperties(){super.initialProperties(),this.mediaFrame=wp.media({multiple:!1,library:{type:"image"}})}attachEvents(e){super.attachEvents(e),e.addSystemHandler(this.valueChangedEvent,this.onValueChangedEvent),e.addElementHandler(this.componentElement,"click",".upload-container .upload-image",this.onUpdateButtonClick),e.addElementHandler(this.componentElement,"click",".image-container .delete-image",this.onRemoveButtonClick),this.mediaFrame.on("select",a(this.onSelectImage,this))}onRemoveButtonClick(){this.optionValue=null}onUpdateButtonClick(){this.mediaFrame.open()}onSelectImage(){let e=this.mediaFrame.state().get("selection").first().toJSON();this.optionValue=e.id,this.eventManager.removeSystemHandler(this.valueChangedEvent,this.onValueChangedEvent),this.updateOptionValue({id:e.id,url:e.url}),this.eventManager.addSystemHandler(this.valueChangedEvent,this.onValueChangedEvent)}restoreDefaultOptionValue(e){super.restoreDefaultOptionValue(e),!this.isAttached&&this.optionValue&&this.updateOptionValue({id:this.optionValue})}onValueChangedEvent(e){this.updateOptionValue({id:e.value})}restoreOptionValue(){super.restoreOptionValue(),this.updateOptionValue({id:this.optionValueProp})}updateOptionValue(e){let t=e.id,n=this.componentElement.find(".control-input-element"),o=this.componentElement.find(".upload-container"),i=this.componentElement.find(".image-container");if(this.attachmentQuery&&this.attachmentQuery.abort(),!t)return n.val(""),this.updatePreviewImage(""),o.removeClass("woocommerce-product-filter-hidden"),void i.addClass("woocommerce-product-filter-hidden");if(o.addClass("woocommerce-product-filter-hidden"),i.removeClass("woocommerce-product-filter-hidden"),e.hasOwnProperty("url"))this.updatePreviewImage(e.url);else{let e=wp.media.attachment(t);this.attachmentQuery=e.sync("read"),this.attachmentQuery.done((e=>{this.updatePreviewImage(e.url)})).fail((()=>{this.updatePreviewImage("")}))}n.val(t)}updatePreviewImage(e){this.componentElement.find(".image-element").attr("src",e)}}let J=class extends M{constructor(){super(...arguments),this.isRestoredOption=!1,this.images={},this.attachmentQuery={}}get controlLoader(){return this.app.componentRegister.get("Editor/Control/ControlLoader")}initialProperties(){super.initialProperties(),this.mediaFrame=wp.media({multiple:!1,library:{type:"image"}}),this.mediaFrame.on("select",a(this.onSelectImage,this))}getEmptyValue(){return{}}restoreOptionValue(){super.restoreOptionValue();let e=this.controlStructure.taxonomiesColors;if(Array.isArray(this.optionValue)||"object"!=typeof this.optionValue){if(!e.hasOwnProperty(this.optionKey))return void(this.optionValueProp={});this.optionValueProp=z(e[this.optionKey])}else if(!Array.isArray(this.optionValue)&&"object"==typeof this.optionValue&&e.hasOwnProperty(this.optionKey)){let t=z(e[this.optionKey]);this.optionValueProp=jQuery.extend(t,this.optionValueProp)}this.isRestoredOption=!0;for(let e in this.optionValue){let t=this.optionValue[e],n=this.componentElement.find(`.color-item[data-term=${e}]`);t.image&&n.find(".image-element").attr("src")&&(this.images[t.image]=n.find(".image-element").attr("src")),this.changeMarkerStyleSwitch(t.term,t.markerStyle),this.changeTypeSwitch(t.term,t.type),this.changeBorderColorElement(t.term,t.borderColor,!0),this.changeColorElement(t.term,t.color,!0),this.changeImageElement(t.term,t.image)}this.isRestoredOption=!1}onSelectImage(){let e=this.mediaFrame.$el.data("term"),t=this.mediaFrame.state().get("selection").first().toJSON();this.images[t.id]=t.url,this.changeImageElement(e,t.id)}changeImageElement(e,t){let n=this.componentElement.find(`.color-item[data-term=${e}]`).find(".image-container");if(this.attachmentQuery.hasOwnProperty(e)&&this.attachmentQuery[e]&&this.attachmentQuery[e].abort(),this.changeColorOption(e,"image",t),n.find(".image-element").attr("src",""),t&&!this.images.hasOwnProperty(t)){let o=wp.media.attachment(t);this.attachmentQuery[e]=o.sync("read"),this.attachmentQuery[e].done((e=>{this.images[t]=e.url,n.find(".image-element").attr("src",e.url)})).always((()=>{this.updatePreviewColor(e)}))}else t&&this.images.hasOwnProperty(t)&&n.find(".image-element").attr("src",this.images[t]);this.updatePreviewColor(e)}changeColorElement(e,t,n=!1){let o=this.componentElement.find(`.color-item[data-term=${e}]`),i=o.find(".color-picker-element"),r=o.find(".preview-color");!n||(i.wpColorPicker("color",t),t&&t.length)||i.parents(".wp-picker-container").find(".wp-color-result").css("background-color",""),"color"==this.optionValue[e].type&&r.css("background",t),this.changeColorOption(e,"color",t)}changeBorderColorElement(e,t,n=!1){let o=this.componentElement.find(`.color-item[data-term=${e}]`),i=o.find(".border-picker-element"),r=o.find(".preview-color");!n||(i.wpColorPicker("color",t),t&&t.length)||i.parents(".wp-picker-container").find(".wp-color-result").css("background-color",""),r.css("border-color",t),this.changeColorOption(e,"borderColor",t)}changeMarkerStyleSwitch(e,t){let n=this.componentElement.find(`.color-item[data-term=${e}]`).find('.switch-element[data-name="marker"]');this.changeSwitchElement(n,t),this.changeColorOption(e,"markerStyle",t)}changeTypeSwitch(e,t){let n=this.componentElement.find(`.color-item[data-term=${e}]`),o=n.find('.switch-element[data-name="type"]');this.changeSwitchElement(o,t),"color"==t?(n.find(".image-container").hide(),n.find(".color-picker-container").show()):"image"==t&&(n.find(".image-container").show(),n.find(".color-picker-container").hide()),this.changeColorOption(e,"type",t),this.updatePreviewColor(e)}updatePreviewColor(e){let t=this.componentElement.find(`.color-item[data-term=${e}]`),n=t.find(".preview-color"),o=this.optionValue[e].image;if("color"==this.optionValue[e].type)n.css("background-image",""),n.css("background",this.optionValue[e].color);else if("image"==this.optionValue[e].type){let e=t.find(".image-container .preview-image-container"),i=t.find(".image-container .upload-container");n.css("background",""),o&&this.images.hasOwnProperty(o)?(n.css("background-image",`url(${this.images[o]})`),e.removeClass("woocommerce-product-filter-hidden"),i.addClass("woocommerce-product-filter-hidden")):(n.css("background-image",""),e.addClass("woocommerce-product-filter-hidden"),i.removeClass("woocommerce-product-filter-hidden"))}}changeSwitchElement(e,t){e.find(".option.active").removeClass("active"),e.find(`.option[data-value="${t}"]`).addClass("active")}reloadControl(e){this.componentElement.find(".control-content").html(e.controlElement.find(".control-content").html()),this.initialElementProperties(),this.attachElementEvents(this.eventManager)}afterReloadDependentOption(){this.restoreOptionValue()}initialElementProperties(){let e=e=>{setTimeout((()=>{let t=jQuery(e.target),n=t.parents(".color-item:first"),o=t.hasClass("wp-picker-clear")?"":t.val();this.changeColorElement(n.data("term"),o)}),1)},t=e=>{setTimeout((()=>{let t=jQuery(e.target),n=t.parents(".color-item:first"),o=t.hasClass("wp-picker-clear")?"":t.val();this.changeBorderColorElement(n.data("term"),o)}),1)};this.componentElement.find(".color-picker-element").wpColorPicker({hide:!0,palettes:!0,change:e,clear:e}),this.componentElement.find(".border-picker-element").wpColorPicker({hide:!0,palettes:!0,change:t,clear:t})}attachEvents(e){super.attachEvents(e),e.addElementHandler(this.componentElement,"click",".image-container .upload-container .upload-image",this.onUpdateImageClick),e.addElementHandler(this.componentElement,"click",".image-container .delete-image",this.onRemoveImageClick),e.addElementHandler(this.componentElement,"mouseenter",'.switch-element[data-name="marker"] .option',this.onMarkerMouseEnter),e.addElementHandler(this.componentElement,"mouseleave",'.switch-element[data-name="marker"] .option',this.onMouseLeaveEnter)}attachElementEvents(e){e.addElementHandler(this.componentElement.find(".switch-element"),"click",".option:not(.active)",this.onSwitchClick)}onMarkerMouseEnter(e){let t=jQuery(e.currentTarget);t.parents(".color-item:first").addClass("marker-preview").addClass(`marker-preview-${t.data("value")}`)}onMouseLeaveEnter(e){let t=jQuery(e.currentTarget);t.parents(".color-item:first").removeClass("marker-preview").removeClass(`marker-preview-${t.data("value")}`)}onRemoveImageClick(e){let t=jQuery(e.currentTarget).parents(".color-item:first");this.changeImageElement(t.data("term"),"")}onUpdateImageClick(e){let t=jQuery(e.currentTarget).parents(".color-item:first");this.mediaFrame.open(t),this.mediaFrame.$el.data("term",t.data("term"))}onSwitchClick(e){let t=jQuery(e.currentTarget),n=t.parents(".color-item:first"),o=t.parents(".switch-element").data("name"),i=t.data("value");"type"==o?this.changeTypeSwitch(n.data("term"),i):"marker"==o&&this.changeMarkerStyleSwitch(n.data("term"),i)}changeColorOption(e,t,n){if(this.optionValue[e][t]==n)return;let o=z(this.optionValue);this.optionValue[e][t]=n,this.isRestoredOption||this.valueChangedEvent.trigger({oldValue:o,value:this.optionValue,control:this})}};J=function(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}([R],J);const Z=J;class Y extends M{constructor(){super(...arguments),this.isRestoredOption=!1}getEmptyValue(){return[]}getGroupPosition(e){for(let t in this.optionValue)if(this.optionValue[t].id==e)return t;return-1}getRulePosition(e,t){let n=this.getGroupOption(e).rules;for(let e in n)if(n[e].id==t)return e;return-1}getGroupOption(e){for(let t in this.optionValue){let n=this.optionValue[t];if(n.id==e)return n}return null}getRuleOption(e,t){let n=this.getRulePosition(e,t),o=this.getGroupOption(e);return-1!==n?o.rules[n]:null}setRuleOption(e,t,n,o){let i=this.getRulePosition(e,t),r=this.getGroupOption(e);-1!==i?r.rules[i]={id:t,rule:n}:o?r.rules.splice(o,0,{id:t,rule:n}):r.rules.push({id:t,rule:n})}hasRuleOption(e,t){let n=this.getGroupOption(e).rules;for(let e in n)if(n[e].id==t)return!0;return!1}hasGroupOption(e){for(let t in this.optionValue)if(this.optionValue[t].id==e)return!0;return!1}deleteRuleOption(e,t){let n=this.getGroupOption(e),o=this.getRulePosition(e,t);-1!==o&&n.rules.splice(o,1)}deleteGroupOption(e){let t=this.getGroupPosition(e);-1!==t&&this.optionValue.splice(t,1)}restoreOptionValue(){this.isRestoredOption=!0,super.restoreOptionValue(),"object"==typeof this.optionValue&&this.optionValue&&this.hasGroupOption("group_0")&&this.hasRuleOption("group_0","rule_0")||("object"==typeof this.optionValue&&this.optionValue||(this.optionValueProp=[]),this.hasGroupOption("group_0")||this.optionValueProp.push({id:"group_0",rules:[]}),this.getGroupOption("group_0").rules.push({id:"rule_0",rule:{param:this.controlStructure.useEntries[0],operator:"==",value:null}}));let e=null;for(let t in this.optionValue){let n=this.optionValue[t],o=this.getGroupElement(n.id);if(!o.length&&n.rules)this.createEmptyGroup(n.id,e),o=this.getGroupElement(n.id);else if(o.length&&!n.rules){this.deleteGroupOption(n.id);continue}let i=null;for(let e in n.rules){let t=n.rules[e],o=this.getRuleElement(n.id,t.id);o.length||(this.createEmptyRule(n.id,t.id,i),o=this.getRuleElement(n.id,t.id)),this.setRuleOptions(n.id,t.id,t.rule),i=o}e=o}this.componentElement.find(".rule-group[data-id]").each(((e,t)=>{let n=jQuery(t),o=n.data("id");this.hasGroupOption(o)?n.find(".rule-row[data-id]").each(((e,t)=>{let n=jQuery(t),i=n.data("id");this.hasRuleOption(o,i)||n.remove()})):n.remove()})),this.initSelect2(),this.isRestoredOption=!1}initSelect2(){this.componentElement.find(".value-select").select2({width:"100%",closeOnSelect:!0})}setRuleOptions(e,t,n,o){let i=this.getRuleElement(e,t);i.find(".operator-select").val(n.operator),i.find(".param-select").val(n.param);let r=z(this.optionValue);this.setRuleOption(e,t,n,o),this.isRestoredOption||this.valueChangedEvent.trigger({oldValue:r,value:this.optionValue,control:this}),this.reloadEntries(e,t)}attachEvents(e){super.attachEvents(e),e.addElementHandler(this.componentElement,"change",".rule-row .param-select",this.onParamChange),e.addElementHandler(this.componentElement,"change",".rule-row .operator-select",this.onOperatorChange),e.addElementHandler(this.componentElement,"change",".rule-row .value-select",this.onEntryValueChange),e.addElementHandler(this.componentElement,"click",".rule-row .add-rule.button",this.onAddRuleButtonClick),e.addElementHandler(this.componentElement,"click",".rule-row .remove-rule.button",this.onRemoveRuleButtonClick),e.addElementHandler(this.componentElement,"click",".rule-groups .add-rule-group.button",this.onAddGroupButtonClick)}compileTemplate(e,t){return window._.template(e,{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"})(t)}getRuleElement(e,t){return this.componentElement.find(`.rule-group[data-id="${e}"] .rule-row[data-id="${t}"]`)}getGroupElement(e){return this.componentElement.find(`.rule-group[data-id="${e}"]`)}generateUniqueId(){return"_"+Math.random().toString(36).substr(2,9)}onRemoveRuleButtonClick(e){let t=jQuery(e.currentTarget).parents(".rule-row:first"),n=t.data("id"),o=t.parents(".rule-group:first").data("id"),i=t.parents(".rules-table-body"),r=z(this.optionValue);"rule_0"==n&&"group_0"==o||(i.find(".rule-row").length<=1&&"group_0"!=o?(this.getGroupElement(o).remove(),this.deleteGroupOption(o)):(t.remove(),this.deleteRuleOption(o,n)),this.valueChangedEvent.trigger({oldValue:r,value:this.optionValue,control:this}))}onAddGroupButtonClick(e){let t=this.generateUniqueId(),n=this.compileTemplate(this.controlStructure.groupRuleTemplateHtml,{groupId:t}),o=jQuery(n),i=this.generateUniqueId();this.componentElement.find(".rule-group").length?o.insertAfter(this.componentElement.find(".rule-group:last")):this.componentElement.find(".rule-groups").prepend(o);let r={param:this.controlStructure.useEntries[0],operator:"==",value:null};this.optionValue.push({id:t,rules:[]}),this.createEmptyRule(t,i),this.setRuleOptions(t,i,r)}createEmptyGroup(e,t){let n=this.compileTemplate(this.controlStructure.groupRuleTemplateHtml,{groupId:e}),o=jQuery(n);t?o.insertAfter(t):this.componentElement.find(".rule-group").length?o.insertAfter(this.componentElement.find(".rule-group:last")):this.componentElement.find(".rule-groups").prepend(o)}createEmptyRule(e,t,n){let o=this.compileTemplate(this.controlStructure.ruleTemplateHtml,{groupId:e,ruleId:t}),i=jQuery(o);n?i.insertAfter(n):this.getGroupElement(e).find(".rules-table-body").append(i),this.initSelect2()}onAddRuleButtonClick(e){let t=jQuery(e.currentTarget),n=t.parents(".rule-row:first").data("id"),o=t.parents(".rule-group:first").data("id"),i=this.getRuleElement(o,n),r=this.generateUniqueId();this.createEmptyRule(o,r,i);let s=this.getGroupOption(o),a=this.getRulePosition(o,n),l={param:this.controlStructure.useEntries[0],operator:"==",value:null};s.rules.splice(a+1,0,{id:r,rule:l}),this.setRuleOptions(o,r,l,a+1)}onEntryValueChange(e){let t=jQuery(e.currentTarget),n=t.parents(".rule-row:first").data("id"),o=t.parents(".rule-group:first").data("id"),i=t.val();this.changeRuleOption(o,n,"value",i)}onOperatorChange(e){let t=jQuery(e.currentTarget),n=t.parents(".rule-row:first").data("id"),o=t.parents(".rule-group:first").data("id"),i=t.val();this.changeRuleOption(o,n,"operator",i)}onParamChange(e){let t=jQuery(e.currentTarget),n=t.parents(".rule-row:first").data("id"),o=t.parents(".rule-group:first").data("id"),i=t.val();this.changeRuleOption(o,n,"param",i),this.reloadEntries(o,n)}reloadEntries(e,t){let n=this.getRuleOption(e,t).rule.param,o=this.getValueElementByRule(e,t);o.data("wcpf-loaded-options",!1),o.parents("td:first").block(),Y.optionsElements.hasOwnProperty(n)?this.updateElementsWithParams(n):(!Y.optionsQueries.hasOwnProperty(n)||4==Y.optionsQueries[n].readyState&&200!=Y.optionsQueries[n].status)&&(Y.optionsQueries[n]=wp.ajax.send("wcpf_editor_rules_builder_get_options",{type:"POST",dataType:"json",data:{param:n,wcpf_tabs_panel_nonce:wcpf_tabs.nonce_save}}).done((e=>{e&&e.hasOwnProperty("optionsHtml")?(Y.optionsElements[n]=jQuery(e.optionsHtml),this.updateElementsWithParams(n)):Y.optionsQueries.hasOwnProperty(n)&&delete Y.optionsQueries[n]})))}updateElementsWithParams(e){if("object"==typeof this.optionValue&&this.optionValue)for(let t in this.optionValue){let n=this.optionValue[t];for(let t in n.rules){let o=n.rules[t];if(o.rule.param!=e)continue;let i=this.getValueElementByRule(n.id,o.id);i.data("wcpf-loaded-options")||(i.html(Y.optionsElements[e].html()),i.data("wcpf-loaded-options",!0),i.parents("td:first").unblock()),this.isRestoredOption=!0,i.val(o.rule.value),i.trigger("change"),this.isRestoredOption=!1}}}getValueElementByRule(e,t){return this.componentElement.find(`.rule-group[data-id="${e}"] .rule-row[data-id="${t}"] .value-select`)}changeRuleOption(e,t,n,o){this.optionValue&&"object"==typeof this.optionValue||(this.optionValueProp=[]);let i=this.getRuleOption(e,t);if(i&&i.rule[n]==o)return;let r=z(this.optionValue);i.rule[n]=o,this.isRestoredOption||this.valueChangedEvent.trigger({oldValue:r,value:this.optionValue,control:this})}}Y.optionsElements={},Y.optionsQueries={};const X=class extends p{get prototypes(){return{projection:this.app.objectContainer.get("Editor/Projection/Prototypes"),panelLayout:this.app.objectContainer.get("Editor/PanelLayout/Prototypes"),panel:this.app.objectContainer.get("Editor/Panel/Prototypes"),component:this.app.objectContainer.get("Editor/Component/Prototypes"),control:this.app.objectContainer.get("Editor/Control/Prototypes"),controlSource:this.app.objectContainer.get("Editor/Control/Source/Prototypes")}}get register(){return{panelStructures:this.app.objectContainer.get("Editor/Panel/Structures"),components:this.app.objectContainer.get("Editor/Components"),entityTypes:this.app.objectContainer.get("Entity/Register"),componentPresets:this.app.objectContainer.get("Editor/Component/Presets"),controlRulesOperations:this.app.objectContainer.get("Editor/Control/RulesOperation")}}get builders(){return{control:this.app.componentRegister.get("Editor/Builder/Control"),panel:this.app.componentRegister.get("Editor/Builder/Panel"),panelLayout:this.app.componentRegister.get("Editor/Builder/PanelLayout"),projection:this.app.componentRegister.get("Editor/Builder/Projection"),component:this.app.componentRegister.get("Editor/Builder/Component")}}get projectEditorComponent(){return this.app.objectContainer.get("Editor/ProjectComponent")}get projectEntity(){return this.app.objectContainer.get("Editor/ProjectEntity")}get componentBuilder(){return this.app.objectContainer.get("ComponentBuilder")}get entityCollector(){return this.app.componentRegister.get("Entity/Collector")}get editorPackage(){return this.app.packageRegister.get("Editor/Package")}get localizedMessages(){return this.app.objectContainer.get("Messages")}get panelManager(){return this.app.componentRegister.get("Editor/PanelManager")}get projectionManager(){return this.app.componentRegister.get("Editor/ProjectionManager")}get templateLoader(){return this.app.componentRegister.get("TemplateLoader")}},ee=class extends X{get panel(){return this.control.panel}get optionKey(){return this.control.optionKey}get optionValue(){return this.control.optionValue}attachEvents(e){}};class te extends ee{saveValue(){let e=this.optionValue;"object"==typeof e&&(e=z(e)),this.panel.options.set(this.optionKey,e)}getValue(){let e=this.panel.options.has(this.optionKey)?z(this.panel.options.get(this.optionKey)):void 0;return"object"==typeof e&&(e=z(e)),e}}class ne extends ee{saveValue(){if(this.panel.hasOwnProperty("editorComponent")){let e=this.panel.editorComponent;(e.hasOwnProperty(this.optionKey)||this.optionKey in e)&&(e[this.optionKey]=this.optionValue)}}getValue(){if(this.panel.hasOwnProperty("editorComponent")){let e=this.panel.editorComponent;if(e.hasOwnProperty(this.optionKey)||this.optionKey in e)return e[this.optionKey]}}}class oe{constructor(){this.observers=new Map}add(e,t,n){this.observers.has(e)||this.observers.set(e,[]),t=n?a(t,n):t,this.observers.get(e).push(t)}remove(e,t,n){this.observers.has(e)&&(t=n||a(t,this),this.observers.get(e).filter((e=>e!==t)))}notify(e,t,n){this.observers.has(e)&&this.observers.get(e).forEach((o=>{o(t,n,e)}))}}function ie(e,t,n){if("string"==typeof t)return ie(e,t.split("."),n);if(1==t.length&&void 0!==n)return e[t[0]]=n;if(0==t.length)return z(e);if(!e.hasOwnProperty(t[0])){if(void 0===n)return;e[t[0]]={}}return ie(e[t[0]],t.slice(1),n)}class re{constructor(e){this.observable=new oe,e&&(this.container=e)}has(e){return void 0!==ie(this.container,e)}get(e){return ie(this.container,e)}set(e,t){let n=this.has(e)?this.get(e):null;ie(this.container,e,t),"string"==typeof e&&e.split(".").length&&(e=e.split(".")[0]),this.observable.notify(e,t,n)}}class se extends ee{constructor(e){super(),this.optionKeyProp=null,this.optionsRepository=new re,e&&(this.optionsRepository.container=e)}set optionsContainer(e){this.optionsRepository.container=e}get optionsContainer(){return this.optionsRepository.container}get optionKey(){return this.optionKeyProp?this.optionKeyProp:this.control.optionKey}set optionKey(e){this.optionKeyProp=e}saveValue(){this.optionsRepository.set(this.optionKey,this.optionValue)}getValue(){return this.optionsRepository.has(this.optionKey)?this.optionsRepository.get(this.optionKey):void 0}}class ae extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){let t=this.register.controlRulesOperations;t.set("==",this.isEqualToOperator),t.set("!=",this.isNotEqualToOperator),t.set(">",this.greaterThanOperator),t.set("<",this.lessThanOperator),t.set(">=",this.greaterThanOrEqualToOperator),t.set("<=",this.lessThanOrEqualToOperator),t.set("in",this.inOperator),t.set("inControl",this.inControlOperator),t.set("notIn",this.notInOperator),t.set("notInControl",this.notInControlOperator)}isEqualToOperator(e,t){return Array.isArray(e)?K(e=c({},e),t.value):e==t.value}isNotEqualToOperator(e,t){return!this.isEqualToOperator(e,t)}greaterThanOperator(e,t){return e>t.value}lessThanOperator(e,t){return!this.greaterThanOperator(e,t)}greaterThanOrEqualToOperator(e,t){return e>=t.value}lessThanOrEqualToOperator(e,t){return e<=t.value}inOperator(e,t){return-1!==t.value.indexOf(e)}inControlOperator(e,t){return Array.isArray(e)?-1!==e.indexOf(t.value):"object"==typeof e&&"hasOwnProperty"in e&&e.hasOwnProperty(t.value)}notInOperator(e,t){return!this.inOperator(e,t)}notInControlOperator(e,t){return!this.inControlOperator(e,t)}}class le extends X{constructor(){super(),this.controlRequests=new Map}initialProperties(){this.app.componentRegister.set("Editor/Control/ControlLoader",this)}attachEvents(e){}reloadControls(e,t){let n=[];for(let t of e.values())n.push(this.collectControlProps(t));this.reloadRequest(n,e,t)}reloadControl(e,t){this.reloadRequest([this.collectControlProps(e)],[e],t)}collectControlProps(e){let t=new re({});for(let n of e.panelLayout.controls.values())t.set(n.optionKey,n.optionValue);let n={},o={},i=[e],r=[],s=e.parentControl,a={};for(e.panel.hasOwnProperty("editorComponent")&&(a=e.panel.editorComponent.entity);s instanceof M;)i.push(s),s=s.parentControl;i.reverse();for(let e of i.values()){r.push(e.optionKey);for(let[t,n]of e.contextControls.entries())o[t]=n.optionValue;n[e.optionKey]=Object.assign({},o)}return{options:t.container,context:o,optionKey:e.optionKey,panelKey:e.panel.panelKey,controlPath:r,parentsContext:n,entity:a}}reloadRequest(t,n,o){for(let e of n.values())this.controlRequests.has(e)&&this.controlRequests.get(e).abort(),e.componentElement.block();let i=wp.ajax.send("wcpf_editor_control_reload",{type:"POST",dataType:"json",data:{controls:JSON.stringify(t),wcpf_tabs_panel_nonce:wcpf_tabs.nonce_save}}).done((t=>{if(t.items&&Array.isArray(t.items)){for(let[o,i]of t.items.entries()){if("object"!=typeof i)continue;let t=n[o],r={prevStructure:t.controlStructure,structure:i.structure,controlHtml:i.controlHtml,controlElement:e(i.controlHtml)};t.controlStructure=i.structure,"reloadControl"in t&&t.reloadControl(r)}o&&o(n)}})).always((()=>{for(let e of n.values())e.componentElement.unblock()}));for(let e of n.values())this.controlRequests.set(e,i)}}class pe extends o{initialProperties(){this.app.objectContainer.set("Editor/Control/Prototypes",new Map([["Select",A],["Text",B],["RadioList",$],["TextSize",q],["Switch",F],["CheckList",_],["Repeater",W],["ColorPicker",G],["Image",N],["ColorList",Z],["RulesBuilder",Y]])),this.app.objectContainer.set("Editor/Control/Source/Prototypes",new Map([["options",te],["entity",ne],["container",se]])),this.app.objectContainer.set("Editor/Control/RulesOperation",new Map)}getInitialComponents(){return[new ae,new le]}}class ce extends X{initialProperties(){this.app.componentRegister.set("Editor/Builder/Control",this)}attachEvents(e){}createControl(e,t){if(!this.prototypes.control.has(e.controlKey))throw new Error(`Control class not found by type '${e.controlKey}'`);let n=this.prototypes.control.get(e.controlKey),o=this.componentBuilder.build(n);if(!this.prototypes.controlSource.has(e.controlSource))throw new Error(`Control source by key '${e.controlSource}' not found`);let i=this.prototypes.controlSource.get(e.controlSource),r=this.componentBuilder.build(i);return r.control=o,o.controlSource=r,t&&(o.panelLayout=t),o.controlStructure=e,o}}class de extends X{initialProperties(){this.app.componentRegister.set("Editor/Builder/Panel",this)}attachEvents(e){}createPanel(e,t,n){if(!this.prototypes.panel.has(e))throw new Error(`Panel controller with id '${e}' not found`);if(n&&!this.register.components.has(n))throw new Error(`Editor element with id '${n}' not found`);let o=this.prototypes.panel.get(e),i=this.componentBuilder.build(o);if(i.panelKey=e,i.panelContext=t,!n&&i.hasOwnProperty("editorComponent"))throw new Error(`For controller of '${e}' panel, need entity`);if(n){let e=this.register.components.get(n);i.editorComponent=e,e.hasOwnProperty("panels")&&e.panels.add(i)}return i}}class he extends X{initialProperties(){this.app.componentRegister.set("Editor/Builder/PanelLayout",this)}attachEvents(e){}createPanelLayout(e){if(!this.register.panelStructures.has(e))throw new Error(`Panel structure with id '${e}' not found`);let t=this.register.panelStructures.get(e),n=this.prototypes.panelLayout.get(t.panelLayoutKey),o=this.componentBuilder.build(n);return o.panelStructure=t,o}}function ue(e,t){if(t.entityId==e)return t;let n=null,o=[];for(let i in t.childEntities){let r=t.childEntities[i];if(r.childEntities.length&&o.push(r),r.entityId==e){n=r;break}}if(null==n)for(let t in o){let i=ue(e,o[t]);if(i instanceof d){n=i;break}}return n}class me extends X{initialProperties(){this.app.componentRegister.set("Editor/Builder/Projection",this)}attachEvents(e){}createProjectionByEntityId(e){let t=ue(e,this.projectEntity);if(null==t)throw new Error(`Entity by id '${e}' not found`);return this.createProjectionByEntity(t)}createProjectionByEntity(e){if(!this.register.components.has(e.entityId))throw new Error(`Element by entity id '${e.entityId}' not found`);return this.createProjectionByComponent(this.register.components.get(e.entityId))}createProjectionByComponent(e){return this.createProjectionByKey(e.entityKey,e)}createProjectionByKey(e,t){if(!t.hasOwnProperty("projection"))throw new Error(`Element '#${t.entityId} - ${t.entityTitle}' does not have projection support`);if(!this.prototypes.projection.has(e))throw new Error(`Projection controller prototype by key '${e}' not found`);let n=this.prototypes.projection.get(e),o=this.componentBuilder.build(n);return t&&(o.editorComponent=t,t.projection=o),o.projectionKey=e,o.package=this.package,o}}class ge extends X{initialProperties(){this.app.componentRegister.set("Editor/Builder/Component",this)}attachEvents(e){}createComponentByEntityId(e){let t=ue(e,this.projectEntity);if(null==t)throw new Error(`Entity by id '${e}' not found`);return this.createComponentByEntity(t)}createComponentByEntity(e){if(!this.prototypes.component.has(e.entityKey))throw new Error(`Element prototype by entity key '${e.entityKey}' not found`);this.isNumeric(e.entityId)&&(e.entityId=parseFloat(e.entityId)),this.isNumeric(e.parentId)&&(e.parentId=parseFloat(e.parentId));let t=this.prototypes.component.get(e.entityKey),n=this.componentBuilder.build(t);if(n.entity=e,this.register.components.set(e.entityId,n),this.componentBuilder.implementation(n,this.package),e.childEntities.length)for(let t in e.childEntities){let n=e.childEntities[t];this.createComponentByEntity(n)}return n}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}}class ye extends o{getInitialComponents(){return[new ce,new de,new he,new me,new ge]}}class Ee extends P{constructor(){super(),this.optionsContainer={},this.statusProp=V.None,this.statusChangedEvent=new n}get options(){return this.optionsRepository}get status(){return this.statusProp}set status(e){let t=this.statusProp;this.statusProp=e,t!=e&&this.statusChangedEvent.trigger({panel:this,oldStatus:t,status:this.statusProp})}get isControlsSaved(){return this.panelLayout.isControlsSaved}set isControlsSaved(e){this.panelLayout.isControlsSaved=e}get formElement(){return this.componentElement.find("form.panel-form")}initialProperties(){this.optionsRepository=this.createOptionsRepository()}createOptionsRepository(){return new re(this.optionsContainer)}attachEvents(e){e.addSystemHandler(this.statusChangedEvent,this.onStatusChanged),this.panelLayout.panelAutoSave||(e.addSystemHandler(this.panelLayout.isControlsSavedChangedEvent,this.onIsControlsSavedChanged),this.addElementHandler("click",".panel-navigation .reset-panel-button",this.resetValuesOfControls),this.addElementHandler("click",".panel-navigation .apply-panel-button",this.saveValuesOfControls)),e.addElementHandler(this.formElement,"submit",this.onFormSubmit)}onFormSubmit(e){e.preventDefault()}onStatusChanged(e){let t=new Map([[V.Active,"onActive"],[V.Inactive,"onInactive"],[V.Launched,"onLaunched"],[V.Destroyed,"onDestroyed"]]);if(t.has(e.status)&&t.get(e.status)in e.panel){let n=e.panel[t.get(e.status)];n=a(n,this),n()}}onIsControlsSavedChanged(){let e=this.componentElement.find(".panel-navigation .reset-panel-button"),t=this.componentElement.find(".panel-navigation .apply-panel-button");this.panelLayout.isControlsSaved?(e.addClass("disabled"),t.addClass("disabled")):(e.removeClass("disabled"),t.removeClass("disabled"))}saveValuesOfControls(){if(!this.panelLayout.isControlsSaved){for(let e of this.panelLayout.controls.values())e.saveOptionValue();this.panelLayout.isControlsSaved=!0}}resetValuesOfControls(){if(!this.panelLayout.isControlsSaved){for(let e of this.panelLayout.controls.values())e.restoreOptionValue();this.panelLayout.isControlsSaved=!0}}getTemplateContext(e){return{}}}class fe extends Ee{attachEvents(e){super.attachEvents(e),this.options.observable.add("field",this.onElementSelect,this),this.options.observable.add("preset",this.onElementSelect,this),this.options.observable.add("layout",this.onElementSelect,this)}onElementSelect(e){let t=e.elementCode,n=e.defaultState;if(!this.register.entityTypes.has(t))return;let o=this.entityCollector.collectVirtualEntityByKey(t);"object"==typeof n&&(o=c(o,n)),o.parentId=this.projectEntity.entityId,this.projectEntity.childEntities.push(o);let i=this.builders.component.createComponentByEntity(o);i.hasOwnProperty("projection")&&this.projectionManager.addProjection(i),this.prototypes.panel.has(o.entityKey)?this.panelManager.openPanel(o.entityKey,o.entityId):(this.panelManager.backPanel(),i.hasOwnProperty("projection")&&this.projectionManager.scrollToProjection(i))}}class ve extends H{attachEvents(e){e.addElementHandler(this.componentElement,"click",".element-item[data-element-code]",this.onItemClick)}onItemClick(e){let t=b(e);this.setElementValue({elementCode:t.data("element-code"),defaultState:t.data("default-state")}),this.updateValueFromElement()}setElementValue(e){this.componentElement.find(".element-item[data-element-code].selected").removeClass("selected"),"object"==typeof e&&this.componentElement.find(`.element-item[data-element-code="${e.elementCode}"]`).addClass("selected")}getElementValue(){let e=this.componentElement.find(".element-item[data-element-code].selected");return e.length?{elementCode:e.data("element-code"),defaultState:e.data("default-state")}:null}}class Ce extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.panel.set("AddElement",fe),e.control.set("ElementList",ve)}}class Pe extends o{getInitialComponents(){return[new Ce]}}function we(e,t){var n=s(e,t);return n?jQuery(n):null}const be=class extends p{constructor(){super(...arguments),this.rootSelector=""}get rootElement(){return we(this)}getParentEntity(){return"rootSelector",(e=this.package)&&e.hasOwnProperty("rootSelector")?this.package:null;var e}getEntityElement(e){return we(this,e)}},je=class extends be{get prototypes(){return{projection:this.app.objectContainer.get("Editor/Projection/Prototypes"),panelLayout:this.app.objectContainer.get("Editor/PanelLayout/Prototypes"),panel:this.app.objectContainer.get("Editor/Panel/Prototypes"),component:this.app.objectContainer.get("Editor/Component/Prototypes"),control:this.app.objectContainer.get("Editor/Control/Prototypes"),controlSource:this.app.objectContainer.get("Editor/Control/Source/Prototypes")}}get register(){return{panelStructures:this.app.objectContainer.get("Editor/Panel/Structures"),components:this.app.objectContainer.get("Editor/Components"),entityTypes:this.app.objectContainer.get("Entity/Register"),componentPresets:this.app.objectContainer.get("Editor/Component/Presets"),controlRulesOperations:this.app.objectContainer.get("Editor/Control/RulesOperation")}}get builders(){return{control:this.app.componentRegister.get("Editor/Builder/Control"),panel:this.app.componentRegister.get("Editor/Builder/Panel"),panelLayout:this.app.componentRegister.get("Editor/Builder/PanelLayout"),projection:this.app.componentRegister.get("Editor/Builder/Projection"),component:this.app.componentRegister.get("Editor/Builder/Component")}}get projectEditorComponent(){return this.app.objectContainer.get("Editor/ProjectComponent")}get projectEntity(){return this.app.objectContainer.get("Editor/ProjectEntity")}get componentBuilder(){return this.app.objectContainer.get("ComponentBuilder")}get entityCollector(){return this.app.componentRegister.get("Entity/Collector")}get editorPackage(){return this.app.packageRegister.get("Editor/Package")}get localizedMessages(){return this.app.objectContainer.get("Messages")}get panelManager(){return this.app.componentRegister.get("Editor/PanelManager")}get projectionManager(){return this.app.componentRegister.get("Editor/ProjectionManager")}get templateLoader(){return this.app.componentRegister.get("TemplateLoader")}};function Oe(t,n){e("html,body").animate({scrollTop:t},n)}class ke extends je{constructor(){super(...arguments),this.rootSelector=".woocommerce-product-filter-manage-project-wrapper",this.rowModeWidth=1140}initialProperties(){jQuery.hasOwnProperty("blockUI")&&(jQuery.blockUI.defaults.message=null)}attachEvents(e){e.addWindowHandler("load",this.onWindowLoaded),e.addComponentHandler("click",".editor-panel .navigation .save-project",this.saveProject),e.addComponentHandler("click",".editor-panel .navigation .add-element",this.onAddElementClick),e.addComponentHandler("click",".panel.projections-panel .view-mode-toggle .view-mode",this.onViewModeClick),e.addWindowHandler("resize",this.onWindowResize)}onViewModeClick(e){let t=b(e).data("mode");this.setMode(t)}setMode(e){this.rootElement.find(".panel.editor-panel").attr("data-panel-mode",e),this.rootElement.find(".panel.projections-panel .view-mode-toggle .view-mode.active").removeClass("active"),this.rootElement.find(`.panel.projections-panel .view-mode-toggle .view-mode[data-mode="${e}"]`).addClass("active")}getMode(){return this.rootElement.find(".panel.editor-panel").attr("data-panel-mode")||(window.innerWidth<this.rowModeWidth?"row":"column")}onWindowResize(e){window.innerWidth<this.rowModeWidth&&this.setMode("row")}onWindowLoaded(e){if(!window.hasOwnProperty("ProductFilterData"))return;window.innerWidth<this.rowModeWidth?this.setMode("row"):this.setMode("column");let t=window.ProductFilterData,n=(this.builders.component,null);if("edit"!=t.pageAction&&"new"!=t.pageAction)return;this.app.objectContainer.set("PageLinks",{listProject:t.pageLinks.list_project,newProject:t.pageLinks.new_project,editProject:t.pageLinks.edit_project}),this.app.objectContainer.set("Messages",t.messages);for(let e in t.editor.panels){let n=t.editor.panels[e];this.register.panelStructures.set(e,n)}for(let e in t.registerEntities){let n=t.registerEntities[e];this.register.entityTypes.set(e,{id:n.id,label:n.label,isGrouped:n.is_grouped,defaultOptions:n.default_options})}if(this.editorPackage.initEditorEvent.trigger(this.prototypes),window.hasOwnProperty("ProductFilterProjectData")){let e=window.ProductFilterProjectData;n=this.entityCollector.collectEntityByStructure(e)}else n=this.entityCollector.collectVirtualEntityByKey("Project");"new"==t.pageAction&&t.postId&&(n.entityId=t.postId,n.status=u.published);let o=this.builders.component.createComponentByEntity(n);if(this.app.objectContainer.set("Editor/ProjectEntity",n),this.app.objectContainer.set("Editor/ProjectComponent",o),this.editorPackage.projectLoadedEvent.trigger(this.register),this.panelManager.openPanel(n.entityKey,n.entityId),this.panelManager.activePanels.length){let e=this.panelManager.activePanels[0];this.panelManager.checkCorrectnessOfOptions(e)}"new"==t.pageAction&&o.titleChangedEvent.trigger({title:o.entityTitle,oldTitle:o.entityTitle,entity:o.entity,editorComponent:o})}saveProject(){let e=this.app.bodyElement.find("#wpcontent"),t=this.panelManager.activePanels,n=this.app.bodyElement.find(".wcpf-notices-container");if(t.length)for(let e of t){if(!this.panelManager.checkCorrectnessOfOptions(e))return;if(this.panelManager.modalToSaveOptions(e),!this.panelManager.checkCorrectnessOfOptions(e))return}e.block(),wp.ajax.send("wcpf_save_project",{type:"POST",dataType:"json",data:{projectEntity:JSON.stringify(this.projectEntity),wcpf_tabs_panel_nonce:wcpf_tabs.nonce_save}}).fail((e=>{if(n.html(""),e.hasOwnProperty("messages")&&e.messages.length){for(let t of e.messages)n.append(this.getMessageTemplate(t));Oe(n.offset().top-window.innerHeight/2,400)}})).done((e=>{if(n.html(""),e.hasOwnProperty("projectId")){let t=this.app.objectContainer.get("PageLinks").editProject;t=t.replace(/\%project_id\%/g,e.projectId),location.href=t}})).always((()=>{e.unblock()}))}onAddElementClick(){this.panelManager.openPanel("AddElement")}getMessageTemplate(e){return`<div class="${e.level} ${e.level}-level-message">\n                <p class="text">${e.text}</p>\n            </div>`}}class Se extends je{constructor(){super(...arguments),this.rootSelector=".page-editor-container .panel.options-panel",this.activePanels=[]}initialProperties(){this.app.componentRegister.set("Editor/PanelManager",this)}attachEvents(e){e.addComponentHandler("click",".action-back-panel-on-click",this.backPanel)}checkIfPanelIsOpen(e,t,n){for(let o in this.activePanels){let i=this.activePanels[o];if(n&&i.hasOwnProperty("editorComponent")){if(i.editorComponent.entityId==n&&i.panelKey==e&&K(t,i.panelContext))return!0}else if(i.panelKey==e&&K(t,i.panelContext))return!0}return!1}getCurrentPanel(){return this.activePanels.length?this.activePanels[this.activePanels.length-1]:null}openPanel(t,n,o){if("string"!=typeof n&&"number"!=typeof n||(o=n,n={}),!t.length)throw new Error("Parameter panel key is empty");if(n||(n={}),this.checkIfPanelIsOpen(t,n,o))return;if(this.activePanels.length){let e=this.activePanels[this.activePanels.length-1];if(!this.checkCorrectnessOfOptions(e))return;if(this.modalToSaveOptions(e),!this.checkCorrectnessOfOptions(e))return}let i=this.getTemplate(t);if(null==i)throw new Error(`Panel template with id '${t}' not found`);let r=this.builders.panelLayout.createPanelLayout(t),s=this.builders.panel.createPanel(t,n,o);r.panel=s,s.panelLayout=r,s.package=this.package,s.initialProperties();let a=e(i(s.getTemplateContext(s.panelContext)));if(a.hide(),this.rootElement.append(a),s.componentElement=r.componentElement=a,this.componentBuilder.implementation(r,this.package),r.assembleControls(r.panelStructure),s.attachEvents(s.eventManager),s.status=V.Launched,this.activePanels.length){let e=this.activePanels[this.activePanels.length-1],t=e.componentElement;if(e.status=V.Inactive,this.activePanels.length>1){if(e.status=V.Destroyed,e.hasOwnProperty("editorComponent")){let t=e.editorComponent;t.hasOwnProperty("panels")&&t.panels.delete(e)}this.activePanels.pop(),this.animationOpen(t,a,((e,t)=>{e.remove()}))}else this.animationOpen(t,a)}else a.show(),a.addClass("status-active");s.status=V.Active,this.activePanels.push(s)}backPanel(e){if(e||(e={}),e=c({ignoreValidation:!1},e),this.activePanels.length<=1)return;let t=this.activePanels[this.activePanels.length-1],n=t.componentElement;if(!e.ignoreValidation&&!this.checkCorrectnessOfOptions(t))return;if(this.modalToSaveOptions(t),!e.ignoreValidation&&!this.checkCorrectnessOfOptions(t))return;let o=this.activePanels[this.activePanels.length-2],i=o.componentElement;if(t.status=V.Inactive,o.status=V.Active,t.status=V.Destroyed,t.hasOwnProperty("editorComponent")){let e=t.editorComponent;e.hasOwnProperty("panels")&&e.panels.delete(t)}this.activePanels.pop(),this.animationBack(n,i,((e,t)=>{e.remove()}))}checkCorrectnessOfOptions(e){return!("validate"in e)||e.validate()}modalToSaveOptions(e){if(!e.isControlsSaved){let t=this.localizedMessages.panel.shouldSaveOptionsOnPanel;t=t.replace(/--panel-title/g,e.panelLayout.panelTitle),confirm(t)?e.saveValuesOfControls():e.resetValuesOfControls()}}scrollToPanelElement(t){let n=e("#wpadminbar"),o=t.offset().top,i=window.scrollY-o;if(i>200||i<-200){let e=o-20;"fixed"==n.css("position")&&(e-=n.height()),Oe(e,500)}}animationOpen(e,t,n){t.addClass("status-launched"),t.show(),e.removeClass("status-active").addClass("status-inactive"),t.addClass("status-active"),setTimeout((()=>{t.removeClass("status-launched"),n&&n(e,t)}),600),this.scrollToPanelElement(t)}animationBack(e,t,n){e.removeClass("status-active").addClass("status-destroyed"),t.removeClass("status-inactive").addClass("status-active"),setTimeout((()=>{n&&n(e,t)}),600)}getTemplate(e){let t=this.app.bodyElement.find(`.wcpf-panel-template[data-panel-key=${e}]`);if(!t.length)return null;let n=t.attr("id");return n&&0===n.indexOf("tmpl-")?wp.template(n.slice(5)):null}}function Ie(e,t){for(let n in e.childEntities){let o=e.childEntities[n];t(o),o.childEntities.length&&Ie(o,t)}}var Ve;!function(e){e[e.inside=0]="inside",e[e.outside=1]="outside",e[e.same=2]="same"}(Ve||(Ve={}));const Re=Ve;class xe extends je{constructor(){super(...arguments),this.rootSelector=".page-editor-container .panel.projections-panel",this.activeProjectionsProp=[],this.sortableOptions={},this.sortingIsInitialized=!1}get activeProjections(){return this.activeProjectionsProp}get containerElement(){return this.rootElement.find(".projections-container")}initialProperties(){this.app.componentRegister.set("Editor/ProjectionManager",this),this.sortableSelectors=[".projections-container",".sort-list"],this.sortableRootSelectors=this.sortableSelectors.map((e=>".page-editor-container .projections-panel "+e)).join(","),this.sortableOptions={items:".sort-item",acceptFrom:this.sortableSelectors.join(", "),placeholder:'<div class="projection projection-placeholder"></div>',forcePlaceholderSize:!1}}attachEvents(e){e.addSystemHandler(this.editorPackage.projectLoadedEvent,this.onProjectLoaded),e.addWindowHandler("load",this.onWindowLoad)}onWindowLoad(e){this.attachSortableEvents(),sortable(this.sortableRootSelectors,this.sortableOptions),this.sortingIsInitialized=!0}reloadSortable(){if(!this.sortingIsInitialized)return;sortable(this.sortableRootSelectors,"destroy"),sortable(this.sortableRootSelectors,this.sortableOptions),this.attachSortableEvents();let t=sortable(this.sortableRootSelectors,"serialize");for(let n in t){let o=t[n];for(let t in o.items){let n=e(o.items[t].node).data("entity-id");this.register.components.has(n)&&(this.register.components.get(n).entityOrder=t)}}}attachSortableEvents(){let t=this.app.bodyElement.find(this.sortableRootSelectors),n="wcpf-is-attached-sortable-events";t.each(((t,o)=>{let i=e(o);i.data(n)||(o.addEventListener("sortupdate",a(this.onSortUpdate,this)),i.data(n,!0))}))}onSortUpdate(t){let n={node:t.detail.origin.container,items:t.detail.origin.items},o={node:t.detail.destination.container,items:t.detail.destination.items},i={node:t.detail.item},r=!1;for(let t of[o,n,i])t.editorComponent=null,t.projection=null,t.element=e(t.node),t.element.hasClass("sort-list")&&(t.element=t.element.parents(".sort-item:first")),t.element.hasClass("projections-container")?t.entityId=this.projectEntity.entityId:t.entityId=t.element.data("entity-id"),this.register.components.has(t.entityId)&&(t.editorComponent=this.register.components.get(t.entityId),t.editorComponent&&t.editorComponent.hasOwnProperty("projection")&&(t.projection=t.editorComponent.projection));o.element.get(0).isSameNode(n.element.get(0))&&(r=!0);let s={editorComponent:i.editorComponent,nextContainerComponent:o.editorComponent,prevContainerComponent:n.editorComponent};i.editorComponent&&(o.editorComponent?i.editorComponent.entityParentId=o.editorComponent.entityId:i.editorComponent.entityParentId=this.projectEntity.entityId),i.projection&&i.projection.moveProjectionEvent.trigger(c({isSameContainer:r},s)),r?o.projection&&o.projection.hasOwnProperty("moveChildProjectionEvent")&&o.projection.moveChildProjectionEvent.trigger(c({direction:Re.same},s)):(o.projection&&o.projection.hasOwnProperty("moveChildProjectionEvent")&&o.projection.moveChildProjectionEvent.trigger(c({direction:Re.inside},s)),n.projection&&n.projection.hasOwnProperty("moveChildProjectionEvent")&&n.projection.moveChildProjectionEvent.trigger(c({direction:Re.outside},s)));for(let t of r?[o]:[n,o])for(let n in t.items){let o=0;o=e(t.items[n]).data("entity-id"),this.register.components.has(o)&&(this.register.components.get(o).entityOrder=n)}}onProjectLoaded(){for(let e of this.register.components.values())this.prototypes.projection.has(e.entityKey)&&e.hasOwnProperty("projection")&&this.addProjection(e)}hasProjection(e){for(let t in this.activeProjections)if(this.activeProjections[t].editorComponent.entityId==e.entityId)return!0;return!1}addProjection(t){if(this.hasProjection(t))return;if(!this.prototypes.projection.has(t.entityKey))throw new Error(`Projection controller prototype with id '${t.entityKey}' not found`);if(!t.hasOwnProperty("projection"))throw new Error(`Element '#${t.entityId} - ${t.entityTitle}' does not have projection support`);let n=this.builders.projection.createProjectionByComponent(t),o=this.getTemplate(n.projectionKey);if(null==o)throw new Error(`Projection template with id '${n.projectionKey}' not found`);this.activeProjectionsProp.push(n),n.initialProperties();let i=e(o(n.getTemplateContext()));n.componentElement=i;let r=!0;if(t.entityParentId&&this.register.components.has(t.entityParentId)){let e=this.register.components.get(t.entityParentId),n=!1;for(;;){if(e.hasOwnProperty("projection")){n=!0;break}if(!this.register.components.has(e.entityParentId))break;e=this.register.components.get(e.entityParentId)}if(n){!e.projection&&this.prototypes.projection.has(e.entityKey)&&this.addProjection(e);let n=e.projection;n&&"insertChildComponentElement"in n&&(n.insertChildComponentElement(i,t),r=!1)}}if(r&&this.containerElement.append(i),n.initialProjection(),n.attachEvents(n.eventManager),t.entity.childEntities.length)for(let e in t.entity.childEntities){let n=t.entity.childEntities[e],o=this.register.components.get(n.entityId);o&&o.hasOwnProperty("projection")&&this.addProjection(o)}this.reloadSortable(),this.triggerZoneState()}moveProjection(e,t){if(!e.hasOwnProperty("projection"))throw new Error(`Element '#${e.entityId} - ${e.entityTitle}' does not have projection support`);let n=!0,o=(e.projection,this.containerElement),i=this.containerElement;if(this.register.components.has(e.entity.parentId)){let t=this.register.components.get(e.entity.parentId);t.hasOwnProperty("projection")&&t.projection&&(o=t.projection.componentElement)}if(t.hasOwnProperty("projection")){let o=t.projection;o&&"insertChildComponentElement"in o&&(o.insertChildComponentElement(e.projection.componentElement,e),i=o.componentElement,n=!1)}n&&this.containerElement.append(e.projection.componentElement);let r="> "+this.sortableSelectors.join(", > ");this.onSortUpdate({detail:{origin:{container:o.get(0),items:o.find(r).toArray()},destination:{container:i.get(0),items:i.find(r).toArray()},item:e.projection.componentElement.get(0)}})}removeProjection(e,t){if(!e.hasOwnProperty("projection"))throw new Error(`Element '#${e.entityId} - ${e.entityTitle}' does not have projection support`);if(!confirm(this.localizedMessages.projection.shouldRemoveElement))return;let n=e.projection;if(n){if(e.entity.childEntities.length)for(let t of e.entity.childEntities)this.register.components.has(t.entityId)&&this.moveProjection(this.register.components.get(t.entityId),this.projectEditorComponent);(void 0===t||t)&&(e.entityStatus=u.remove,e.entity.childEntities.length&&Ie(e.entity,(e=>{this.register.components.get(e.entityId).status=u.remove})));for(let t of this.panelManager.activePanels)if(t.hasOwnProperty("editorComponent")&&t.editorComponent.entityId==e.entityId){this.panelManager.backPanel({ignoreValidation:!0});break}n.componentElement.remove(),this.activeProjectionsProp=this.activeProjectionsProp.filter((t=>t.editorComponent.entityId!=e.entityId)),e.projection=null,this.reloadSortable(),this.triggerZoneState()}}scrollToProjection(e){e.hasOwnProperty("projection")&&Oe(e.projection.componentElement.offset().top-window.innerHeight/2,500)}triggerZoneState(){let e=this.rootElement.find(".projections-zone");this.activeProjections.length?e.removeClass("empty-state"):e.addClass("empty-state")}getTemplate(e){let t=this.app.bodyElement.find(`.wcpf-projection-template[data-projection-key=${e}]`);if(!t.length)return null;let n=t.attr("id");return n&&0===n.indexOf("tmpl-")?wp.template(n.slice(5)):null}}class Ke extends o{constructor(){super(...arguments),this.initEditorEvent=new n,this.projectLoadedEvent=new n}initialProperties(){this.app.packageRegister.set("Editor/Package",this),this.app.objectContainer.set("Editor/ProjectEntity",null),this.app.objectContainer.set("Editor/ProjectComponent",null),this.app.objectContainer.set("Editor/Components",new Map)}getInitialSubpackages(){return[new f,new v,new k,new S,new pe,new ye,new Pe]}getInitialComponents(){return[new ke,new xe,new Se]}}class Le extends X{get validator(){return jQuery.validator}attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(){this.validator.setDefaults({debug:!0,ignore:".control-inactive,*:not([name])",errorPlacement:a(this.errorPlacement,this)});let e={filterKeyText:"",filterKeyUniquer:"",requiredIfActiveControl:this.validator.messages.required};if(this.localizedMessages.hasOwnProperty("validatorErrors"))for(let t in this.localizedMessages.validatorErrors){let n=this.localizedMessages.validatorErrors[t];e[t]=this.validator.format(n)}this.validator.addMethod("requiredIfActiveControl",a(this.requiredIfActiveControlMethod,this),e.requiredIfActiveControl),this.validator.addMethod("requiredUnit",a(this.requiredUnit,this),this.validator.messages.required),this.validator.addMethod("filterKeyText",a(this.filterKeyTextMethod,this),e.filterKeyText),this.validator.addMethod("filterKeyUniquer",a(this.filterKeyUniquerMethod,this),e.filterKeyUniquer),this.validator.addMethod("filterKeyUniquerDepends",a(this.filterKeyUniquerDependsMethod,this),e.filterKeyUniquer)}requiredUnit(t,n){let o=e(n).parents("form.panel-form");return a(this.validator.methods.required,o.data("validator"))(t,n,(t=>e(t).parents(".control-inputs-container:first").find(".text-size").val().length>0))}errorPlacement(e,t){let n=t.parents(".control:first").find(".validation-errors-container:first");n.length?n.append(e):e.insertAfter(t.get(0))}requiredIfActiveControlMethod(t,n,o){let i=e(n),r=i.parents(".control:first"),s=i.parents("form.panel-form");return!(!r.hasClass("control-inactive")&&s.data("validator"))||a(this.validator.methods.required,s.data("validator"))(t,n,o)}filterKeyTextMethod(e,t){return/^[\w\d0-9\-\_]*$/.test(e)}filterKeyUniquerMethod(e,t,n){let o=this.panelManager.getCurrentPanel(),i=null;o.hasOwnProperty("editorComponent")&&(i=o.editorComponent.entityId);for(let[t,n]of this.register.components)if(i!=n.entityId&&"remove"!=n.entityStatus&&"getFilterKeys"in n&&-1!=n.getFilterKeys().indexOf(e))return!1;return!0}filterKeyUniquerDependsMethod(e,t,n){let o=this.panelManager.getCurrentPanel();if(Array.isArray(n))for(let t of n){let n=o.panelLayout.controls.get(t);if(n&&n.optionValue==e)return!1}return!0}}class Me extends o{getInitialComponents(){return[new Le]}}class He extends Ee{constructor(){super(),this.afterInitValidationEvent=new n,this.validateEvent=new n}attachEvents(e){super.attachEvents(e);for(let t of this.panelLayout.controls.values())e.addSystemHandler(t.valueChangedEvent,this.validate)}onLaunched(){let e=this.getValidatorOptions(),t=this.formElement.validate(e);t&&t.hasOwnProperty("settings")&&(t.settings=c(t.settings,e)),this.afterInitValidationEvent.trigger({panel:this,formElement:this.formElement,options:e})}onFormSubmit(e){super.onFormSubmit(e),this.saveValuesOfControls()}validate(){let e=this.formElement.valid();return this.validateEvent.trigger({isValid:e,panel:this}),e}saveValuesOfControls(){this.validate()&&super.saveValuesOfControls()}resetValuesOfControls(){let e=this.panelLayout.isControlsSaved;super.resetValuesOfControls(),e||this.validate()}getValidatorOptions(){return{}}}class Te extends He{createOptionsRepository(){return this.editorComponent.options}}class Ae extends Te{getValidatorOptions(){return{rules:{entityTitle:{required:!0,minlength:2},filteringStarts:{required:!0},productsContainerSelector:{requiredIfActiveControl:!0},paginationSelector:{requiredIfActiveControl:!0},resultCountSelector:{requiredIfActiveControl:!0},sortingSelector:{requiredIfActiveControl:!0}}}}}class Be extends X{constructor(){super(),this.options=new re,this.titleChangedEvent=new n,this.parentChangedEvent=new n,this.statusChangedEvent=new n,this.orderChangedEvent=new n}get entityId(){return this.entity.entityId}get entityKey(){return this.entity.entityKey}get entityTitle(){return this.entity.title}set entityTitle(e){let t=this.entity.title;this.entity.title=e,this.titleChangedEvent.trigger({title:e,oldTitle:t,entity:this.entity,editorComponent:this})}get entityParentId(){return this.entity.parentId}set entityParentId(e){let t=this.entity.parentId;this.entity.parentId=e,this.parentChangedEvent.trigger({parent:e,oldParent:t,entity:this.entity,editorComponent:this})}get entityStatus(){return this.entity.status}set entityStatus(e){let t=this.entity.status;this.entity.status=e,this.statusChangedEvent.trigger({status:e,oldStatus:t,entity:this.entity,editorComponent:this})}get entityOrder(){return this.entity.order}set entityOrder(e){let t=this.entity.order;this.entity.order=e,this.orderChangedEvent.trigger({order:e,oldOrder:t,entity:this.entity,editorComponent:this})}initialProperties(){this.options.container=this.entity.options}attachEvents(e){e.addSystemHandler(this.parentChangedEvent,this.moveEntityWhenParentChange)}moveEntityWhenParentChange(e){if(!this.register.components.has(e.oldParent)||!this.register.components.has(e.parent))return;let t=this.register.components.get(e.oldParent).entity,n=this.register.components.get(e.parent).entity;t.childEntities=t.childEntities.filter((e=>e.entityId!=this.entityId)),n.childEntities.push(this.entity)}}class $e extends Be{constructor(){super(...arguments),this.panels=new Set}attachEvents(e){super.attachEvents(e),e.addSystemHandler(this.titleChangedEvent,this.onTitleChanged)}onTitleChanged(e){this.app.bodyElement.find(".wp-heading-inline .project-name").html(e.title)}}class qe extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.panel.set("Project",Ae),e.component.set("Project",$e)}}class Fe extends o{getInitialComponents(){return[new qe]}}class De extends Te{getValidatorOptions(){return c(super.getValidatorOptions(),{rules:{entityTitle:{required:!0,minlength:2},optionKey:{required:!0,filterKeyText:!0,filterKeyUniquer:!0,minlength:2},itemsSource:{required:!0},itemsSourceAttribute:{requiredIfActiveControl:!0},itemsSourceCategory:{requiredIfActiveControl:!0},itemsSourceTaxonomy:{requiredIfActiveControl:!0},itemsDisplay:{requiredIfActiveControl:!0},queryType:{requiredIfActiveControl:!0},titleItemReset:{requiredIfActiveControl:!0,minlength:2}}})}}class Qe extends Be{constructor(){super(...arguments),this.panels=new Set,this.projection=null}}class _e extends Qe{getFilterKeys(){return[this.options.get("optionKey")]}}class ze extends P{constructor(){super(),this.moveProjectionEvent=new n}attachEvents(e){}initialProjection(){}get entity(){return this.editorComponent.entity}get entityOptions(){return this.editorComponent.options}getTemplateContext(){return{}}}class Ue extends ze{get titleElement(){return this.componentElement.find(".entity-title")}attachEvents(e){super.attachEvents(e),this.addElementHandler("click",".actions-wrapper .edit-action",this.onEditClick),this.addElementHandler("click",".actions-wrapper .remove-action",this.onRemoveClick),e.addSystemHandler(this.editorComponent.titleChangedEvent,this.onTitleChanged)}onRemoveClick(e){this.projectionManager.removeProjection(this.editorComponent,!0)}onEditClick(e){this.panelManager.openPanel(this.editorComponent.entityKey,{},this.editorComponent.entityId)}onTitleChanged(e){this.titleElement.html(e.title)}getTemplateContext(){return{entity:this.entity}}}class We extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("CheckBoxListField",_e),e.panel.set("CheckBoxListField",De),e.projection.set("CheckBoxListField",Ue)}}class Ge extends o{getInitialComponents(){return[new We]}}class Ne extends X{attachEvents(e){this.app.packageRegister.get("Editor/Package"),e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("RadioListField",_e),e.panel.set("RadioListField",De),e.projection.set("RadioListField",Ue)}}class Je extends o{getInitialComponents(){return[new Ne]}}class Ze extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("DropDownListField",_e),e.panel.set("DropDownListField",De),e.projection.set("DropDownListField",Ue)}}class Ye extends o{getInitialComponents(){return[new Ze]}}class Xe extends Te{getValidatorOptions(){return c(super.getValidatorOptions(),{rules:{entityTitle:{required:!0,minlength:2},action:{required:!0}}})}}class et extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("ButtonField",Qe),e.panel.set("ButtonField",Xe),e.projection.set("ButtonField",Ue)}}class tt extends o{getInitialComponents(){return[new et]}}class nt extends Te{getValidatorOptions(){return c(super.getValidatorOptions(),{rules:{entityTitle:{required:!0,minlength:2},optionKey:{requiredIfActiveControl:!0,filterKeyText:!0,filterKeyUniquer:!0,minlength:2},minPriceOptionKey:{requiredIfActiveControl:!0,filterKeyText:!0,filterKeyUniquer:!0,minlength:2},maxPriceOptionKey:{requiredIfActiveControl:!0,filterKeyText:!0,filterKeyUniquer:!0,filterKeyUniquerDepends:["minPriceOptionKey"],minlength:2}}})}}class ot extends Qe{getFilterKeys(){let e=[];return"dash"==this.options.get("optionKeyFormat")?e.push(this.options.get("optionKey")):"two"==this.options.get("optionKeyFormat")&&(e.push(this.options.get("minPriceOptionKey")),e.push(this.options.get("maxPriceOptionKey"))),e}}class it extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("PriceSliderField",ot),e.panel.set("PriceSliderField",nt),e.projection.set("PriceSliderField",Ue)}}class rt extends o{getInitialComponents(){return[new it]}}class st extends De{getValidatorOptions(){let e=super.getValidatorOptions();return e.rules=c(e.rules,{boxSize:{required:!0,number:!0,min:1},boxSizeUnit:{requiredUnit:!0}}),e}}class at extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("BoxListField",_e),e.panel.set("BoxListField",st),e.projection.set("BoxListField",Ue)}}class lt extends o{getInitialComponents(){return[new at]}}class pt extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("TextListField",_e),e.panel.set("TextListField",De),e.projection.set("TextListField",Ue)}}class ct extends o{getInitialComponents(){return[new pt]}}class dt extends De{getValidatorOptions(){let e=super.getValidatorOptions();return e.rules=c(e.rules,{colors:{repeaterItem:{type:{required:!0},term:{required:!0},markerStyle:{required:!0},color:{requiredIfActiveControl:!0}}}}),e}}class ht extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("ColorListField",_e),e.panel.set("ColorListField",dt),e.projection.set("ColorListField",Ue)}}class ut extends o{getInitialComponents(){return[new ht]}}class mt extends o{getInitialSubpackages(){return[new Ge,new Je,new Ye,new tt,new rt,new lt,new ct,new ut]}getInitialComponents(){return[]}}class gt extends Te{createOptionsRepository(){let e=this.editorComponent.entity.options.columns[this.panelContext.columnIndex].options;return new re(e)}getValidatorOptions(){return{rules:{width:{required:!0,number:!0,min:1},widthUnit:{requiredUnit:!0}}}}}class yt extends Be{constructor(){super(...arguments),this.panels=new Set,this.projection=null}}const Et=class extends ze{constructor(){super(),this.moveChildProjectionEvent=new n}},ft=class extends Et{attachEvents(e){super.attachEvents(e),this.addElementHandler("click",`.actions-wrapper.entity-id-${this.editorComponent.entityId} .remove-action`,this.onRemoveClick),this.addElementHandler("click",`.actions-wrapper.entity-id-${this.editorComponent.entityId} .edit-action`,this.onEditClick)}onRemoveClick(e){this.projectionManager.removeProjection(this.editorComponent,!0)}onEditClick(e){this.panelManager.openPanel(this.editorComponent.entityKey,{},this.editorComponent.entityId)}getTemplateContext(){return{entity:this.entity}}};class vt extends ft{get columns(){return this.entityOptions.get("columns")}set columns(e){this.entityOptions.set("columns",e)}initialProjection(){super.initialProjection(),Array.isArray(this.columns)||(this.columns=D(this.columns));for(let e=0;e<this.columns.length;e++)Array.isArray(this.columns[e].entities)||(this.columns[e].entities=D(this.columns[e].entities)),Array.isArray(this.columns[e].options)&&(this.columns[e].options=Object.assign({},this.columns[e].options)),this.createColumnElement(e)}attachEvents(e){super.attachEvents(e),e.addSystemHandler(this.moveChildProjectionEvent,this.onMoveChildProjection),this.addElementHandler("click",`.actions-wrapper.entity-id-${this.editorComponent.entityId} .add-column-action`,this.onAddColumnClick),this.addElementHandler("click",`.column-item .actions.entity-id-${this.editorComponent.entityId} .remove-action`,this.onRemoveColumnClick),this.addElementHandler("click",`.column-item .actions.entity-id-${this.editorComponent.entityId} .edit-action`,this.onEditColumnClick)}onEditColumnClick(e){let t=b(e).parents(".column-item:first").data("column-index");this.panelManager.openPanel("ColumnsLayoutItem",{columnIndex:t},this.editorComponent.entityId)}onRemoveColumnClick(e){let t=b(e).parents(".column-item:first").data("column-index");this.removeColumn(t)}onAddColumnClick(e){let t=this.createEmptyColumn();this.panelManager.openPanel("ColumnsLayoutItem",{columnIndex:t},this.editorComponent.entityId)}onMoveChildProjection(e){e.editorComponent.hasOwnProperty("projection")&&(e.direction==Re.same?(this.outsideChild(e.editorComponent),this.insideChild(e.editorComponent)):e.direction==Re.inside?this.insideChild(e.editorComponent):e.direction==Re.outside&&this.outsideChild(e.editorComponent))}insideChild(e){let t=e.projection.componentElement,n=`.column-item.entity-id-${this.editorComponent.entityId}`,o=t.parents(n).data("column-index"),i=this.columns;i[o].entities.push(e.entityId),this.columns=i}outsideChild(e){let t=0,n=this.columns;for(let o in n){let i=n[o];for(let n of i.entities)if(n==e.entityId){t=o;break}}n[t].entities=n[t].entities.filter((t=>t!=e.entityId)),this.columns=n}insertChildComponentElement(e,t){let n=this.columns,o=0;for(let e in n){let i=n[e];for(let n of i.entities)if(n==t.entityId){o=e;break}}this.getColumnContentElement(o).append(e)}createEmptyColumn(){let e=this.columns;e.push({entities:[],options:{width:"50%"}}),this.columns=e;let t=e.length-1;return this.createColumnElement(t),t}createColumnElement(t){let n=e(`\n            <div class="column-item column-item-${t} entity-id-${this.editorComponent.entityId}"\n                data-column-index="${t}">\n                <div class="column-header">\n                    <div class="column-title">\n                        <span class="text">${this.localizedMessages.columnsLayout.column} ${t}</span>\n                    </div>\n                    <div class="actions entity-id-${this.editorComponent.entityId}">\n                        <div class="button-link edit-action">\n                            <span class="text">${this.localizedMessages.columnsLayout.edit}</span>\n                        </div>\n                        <div class="button-link remove-action">\n                            <span class="text">${this.localizedMessages.columnsLayout.remove}</span>\n                        </div>\n                    </div>\n                </div>\n                <div class="sort-list column-content entity-id-${this.editorComponent.entityId}"></div>\n            </div>\n        `);return this.componentElement.find(".body-container:first").append(n),this.projectionManager.reloadSortable(),n}removeColumn(e){if(0==e)return;let t=this.columns;if(t.length>e&&0<=e){let n=t[e].entities;t.splice(e,1),this.columns=t;for(let e of n)this.register.components.has(e)&&this.projectionManager.moveProjection(this.register.components.get(e),this.editorComponent);this.removeColumnElement(e);for(let n=e+1;n<=t.length;n++){let e=n-1,t=this.getColumnElement(n);t.removeClass(`column-item-${n}`).addClass(`column-item-${e}`).attr("data-column-index",e),t.find("> .column-header .column-title .text").html(this.localizedMessages.columnsLayout.column+" "+e)}}}removeColumnElement(e){this.getColumnElement(e).remove(),this.projectionManager.reloadSortable()}getColumnElement(e){return this.componentElement.find(`.column-item.column-item-${e}.entity-id-${this.editorComponent.entityId}`)}getColumnContentElement(e){return this.componentElement.find(`.column-item.column-item-${e} .column-content.entity-id-${this.editorComponent.entityId}`)}}class Ct extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("ColumnsLayout",yt),e.panel.set("ColumnsLayoutItem",gt),e.projection.set("ColumnsLayout",vt)}}class Pt extends o{getInitialComponents(){return[new Ct]}}class wt extends ft{get titleElement(){return this.componentElement.find(`.title-container.entity-id-${this.editorComponent.entityId} .entity-title`)}get containerElement(){return this.componentElement.find(`.sort-list.entity-id-${this.editorComponent.entityId}`)}attachEvents(e){super.attachEvents(e),e.addSystemHandler(this.editorComponent.titleChangedEvent,this.onTitleChanged)}onTitleChanged(e){this.titleElement.html(e.title)}insertChildComponentElement(e,t){this.containerElement.append(e)}}class bt extends Te{getValidatorOptions(){return{rules:{entityTitle:{required:!0,minlength:2},defaultToggleState:{requiredIfActiveControl:!0}}}}}class jt extends X{attachEvents(e){e.addSystemHandler(this.editorPackage.initEditorEvent,this.initEditor)}initEditor(e){e.component.set("SimpleBoxLayout",yt),e.panel.set("SimpleBoxLayout",bt),e.projection.set("SimpleBoxLayout",wt)}}class Ot extends o{getInitialComponents(){return[new jt]}}class kt extends o{getInitialSubpackages(){return[new Pt,new Ot]}getInitialComponents(){return[]}}let St=new class extends t{initialization(){let e=new i,t=new r;this.objectContainer.set("ComponentBuilder",t),e.build(new E,this),e.build(new g,this),e.build(new Ke,this),e.build(new Me,this),e.build(new Fe,this),e.build(new mt,this),e.build(new kt,this)}};St.initialization(),window.wcpfAdminApp=St})();