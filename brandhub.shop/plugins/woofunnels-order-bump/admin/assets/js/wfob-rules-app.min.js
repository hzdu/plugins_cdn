"use strict";var wfob_app={Helpers:{},Views:{},Events:{}};_.extend(wfob_app.Events,Backbone.Events),wfob_app.Helpers.uniqid=function(e,t){var o;void 0===e&&(e="");var r=function(e,t){return t<(e=parseInt(e,10).toString(16)).length?e.slice(e.length-t):t>e.length?Array(t-e.length+1).join("0")+e:e};return this.php_js||(this.php_js={}),this.php_js.uniqidSeed||(this.php_js.uniqidSeed=Math.floor(123456789*Math.random())),this.php_js.uniqidSeed++,o=e,o+=r(parseInt((new Date).getTime()/1e3,10),8),o+=r(this.php_js.uniqidSeed,5),t&&(o+=(10*Math.random()).toFixed(8).toString()),o},jQuery(function(e){e("#wfob_settings_location").change(function(){"custom:custom"==e(this).val()?e(".wfob-settings-custom").show():e(".wfob-settings-custom").hide()}),e(".wfob_save_funnel_rules").on("click",function(){var t={data:e(".wfob_rules_form").serialize(),action:"wfob_save_rules_settings"},o=e("#wfob_funnel_rule_settings").find(".wfob_save_funnel_rules_ajax_loader");return o.addClass("ajax_loader_show"),e.post(wfob_secure.ajax_url,t,function(){o.removeClass("ajax_loader_show"),e(document).trigger("wfob_rules_updated")}),!1}),e("#wfob_settings_location").trigger("change");var t=function(){e(".wfob-date-picker-field").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0,beforeShow:function(t,o){e(o.dpDiv).addClass("xl-datepickers")}}),e(".wfob-time-picker-field").mask("99 : 99"),e("select.chosen_select").xlChosen(),e("select.ajax_chosen_select_products").xlAjaxChosen({method:"GET",url:ajaxurl,dataType:"json",afterTypeDelay:100,data:{action:"woocommerce_json_search_products_and_variations",security:wfob_secure.search_products_nonce}},function(t){var o={};return e.each(t,function(e,t){o[e]=t}),o}),e("select.ajax_chosen_select_users").xlAjaxChosen({method:"GET",url:ajaxurl,dataType:"json",afterTypeDelay:100,data:{action:"woocommerce_json_search_customers",security:wfob_secure.search_customers_nonce}},function(t){var o={};return e.each(t,function(e,t){o[e]=t}),o}),e("select.ajax_chosen_select").each(function(t){e(t).xlAjaxChosen({method:"GET",url:ajaxurl,dataType:"json",afterTypeDelay:100,data:{action:"wfob_json_search",method:e(t).data("method"),security:wfob_secure.ajax_chosen}},function(t){var o={};return e.each(t,function(e,t){o[e]=t}),o})})};t(),e(".wfob_rules_common").on("change","select.rule_type",function(){var o=e(this).closest("tr"),r=o.data("ruleid"),u=o.closest("table").data("groupid"),n={action:"wfob_change_rule_type",security:wfob_secure.nonce,rule_category:e(this).parents(".wfob-rules-builder").eq(0).attr("data-category"),group_id:u,rule_id:r,rule_type:e(this).val()};o.find("td.condition").html("").remove(),o.find("td.operator").html("").remove(),o.find("td.loading").show(),o.find("td.rule-type select").prop("disabled",!0),e.ajax({url:ajaxurl,data:n,type:"post",dataType:"html",success:function(e){o.find("td.loading").hide().before(e),o.find("td.rule-type select").prop("disabled",!1),t()}})});var o=Backbone.View.extend({groupCount:0,el:'.wfob-rules-builder[data-category="basic"]',events:{"click .wfob-add-rule-group":"addRuleGroup"},render:function(){var t=this;this.$target=this.$(".wfob-rule-group-target"),this.category="basic",wfob_app.Events.bind("wfob:remove-rule-group",this.removeRuleGroup,this),this.views={};var o=this.$("div.wfob-rule-group-container");_.each(o,function(o){t.groupCount++;var r=e(o).data("groupid"),n=new u({el:o,model:new Backbone.Model({groupId:r,groupCount:t.groupCount,headerText:t.groupCount>1?wfob_secure.text_or:wfob_secure.text_apply_when,removeText:wfob_secure.remove_text,category:t.category})});t.views[r]=n,n.bind("wfob:remove-rule-group",t.removeRuleGroup,t)},this),this.groupCount>0&&e(".rules_or").show()},addRuleGroup:function(o){o.preventDefault();var r="group"+wfob_app.Helpers.uniqid();this.groupCount++;var n=new u({model:new Backbone.Model({groupId:r,groupCount:this.groupCount,headerText:this.groupCount>1?wfob_secure.text_or:wfob_secure.text_apply_when,removeText:wfob_secure.remove_text,category:this.category})});return this.$target.append(n.render().el),this.views[r]=n,n.bind("wfob:remove-rule-group",this.removeRuleGroup,this),this.groupCount>0&&e(".rules_or").show(),t(),!1},removeRuleGroup:function(e){delete this.views[e.model.get("groupId")],e.remove()}}),r=Backbone.View.extend({groupCount:0,el:'.wfob-rules-builder[data-category="product"]',events:{"click .wfob-add-rule-group":"addRuleGroup"},render:function(){this.$target=this.$(".wfob-rule-group-target"),this.category="product",wfob_app.Events.bind("wfob:remove-rule-group",this.removeRuleGroup,this),this.views={};var t=this.$("div.wfob-rule-group-container");_.each(t,function(t){this.groupCount++;var o=e(t).data("groupid"),r=new u({el:t,model:new Backbone.Model({groupId:o,groupCount:this.groupCount,headerText:this.groupCount>1?wfob_secure.text_or:wfob_secure.text_apply_when,removeText:wfob_secure.remove_text,category:this.category})});this.views[o]=r,r.bind("wfob:remove-rule-group",this.removeRuleGroup,this)},this),this.groupCount>0&&e(".rules_or").show()},addRuleGroup:function(o){o.preventDefault();var r="group"+wfob_app.Helpers.uniqid();this.groupCount++;var n=new u({model:new Backbone.Model({groupId:r,groupCount:this.groupCount,headerText:this.groupCount>1?wfob_secure.text_or:wfob_secure.text_apply_when,removeText:wfob_secure.remove_text,category:this.category})});return this.$target.append(n.render().el),this.views[r]=n,n.bind("wfob:remove-rule-group",this.removeRuleGroup,this),this.groupCount>0&&e(".rules_or").show(),t(),!1},removeRuleGroup:function(e){delete this.views[e.model.get("groupId")],e.remove()}}),u=Backbone.View.extend({tagName:"div",className:"wfob-rule-group-container",template:_.template('<div class="wfob-rule-group-header"><h4 class="rules_or"><%= headerText %></h4><a href="#" class="wfob-remove-rule-group button"><%= removeText %></a></div><table class="wfob-rules" data-groupid="<%= groupId %>"><tbody></tbody></table>'),events:{"click .wfob-remove-rule-group":"onRemoveGroupClick"},initialize:function(){var t=this;this.views={},this.$rows=this.$el.find("table.wfob-rules tbody");var o=this.$("tr.wfob-rule");_.each(o,function(o){var r=e(o).data("ruleid"),u=new n({el:o,model:new Backbone.Model({groupId:t.model.get("groupId"),ruleId:r,category:t.model.get("category")})});u.delegateEvents(),u.bind("wfob:add-rule",t.onAddRule,t),u.bind("wfob:remove-rule",t.onRemoveRule,t),t.views.ruleId=u},this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$rows=this.$el.find("table.wfob-rules tbody"),this.$el.attr("data-groupid",this.model.get("groupId")),this.onAddRule(null),this},onAddRule:function(e){var o="rule"+wfob_app.Helpers.uniqid(),r=new n({model:new Backbone.Model({groupId:this.model.get("groupId"),ruleId:o,category:this.model.get("category")})});null==e?this.$rows.append(r.render().el):e.$el.after(r.render().el),r.bind("wfob:add-rule",this.onAddRule,this),r.bind("wfob:remove-rule",this.onRemoveRule,this),t(),this.views.ruleId=r},onRemoveRule:function(t){var o=t.model.get("ruleId"),r=(t.model.get("groupId"),t.model.get("category"));1!=e(".wfob-rules-builder[data-category='"+r+"'] .wfob_rules_common .wfob-rule-group-container table tr.wfob-rule").length&&(delete this.views[o],t.remove(),0==e("table[data-groupid='"+this.model.get("groupId")+"'] tbody tr").length&&(wfob_app.Events.trigger("wfob:removing-rule-group",this),this.trigger("wfob:remove-rule-group",this)))},onRemoveGroupClick:function(e){return e.preventDefault(),wfob_app.Events.trigger("wfob:removing-rule-group",this),this.trigger("wfob:remove-rule-group",this),!1}}),n=Backbone.View.extend({tagName:"tr",className:"wfob-rule",events:{"click .wfob-add-rule":"onAddClick","click .wfob-remove-rule":"onRemoveClick"},render:function(){var t=this.model.get("category"),o=e("#wfob-rule-template-"+t).html(),r=_.template(o);return this.$el.html(r(this.model.toJSON())),this.$el.attr("data-ruleid",this.model.get("ruleId")),this},onAddClick:function(e){return e.preventDefault(),wfob_app.Events.trigger("wfob:adding-rule",this),this.trigger("wfob:add-rule",this),!1},onRemoveClick:function(e){return e.preventDefault(),wfob_app.Events.trigger("wfob:removing-rule",this),this.trigger("wfob:remove-rule",this),!1}});(new o).render(),(new r).render()});