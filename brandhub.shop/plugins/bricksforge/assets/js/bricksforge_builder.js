var BRFBUILDER=BRFBUILDER||{};class BricksforgeBuilder{bricksPanelObserver=null;bricksStructureObserver=null;bricksRoot=null;bricksState=null;bricksContent=null;bricksActiveElement=null;bricksActiveElementObject=null;bricksforgeRoot=null;bricksforgeState=null;bricksforgeStores=null;bricksforgeStoreAi=null;createTerminalShortcut=null;constructor(){this.init()}init(){this.createVueWrapper(),this.initVueInstances(),this.initMutationObservers(),this.initFunctions(),this.addContextMenuItems()}createVueWrapper(){const e=document.createElement("div");e.id="bricksforge-builder";document.querySelector("#bricks-preview")&&document.querySelector("#bricks-preview").appendChild(e)}initVueInstances(){this.bricksRoot=document.querySelector(".brx-body").__vue_app__.config.globalProperties,this.bricksState=this.bricksRoot.$_state,this.bricksContent=this.bricksState.content,setTimeout((()=>{this.bricksforgeRoot=document.querySelector("#bricksforge-builder").__vue_app__?document.querySelector("#bricksforge-builder").__vue_app__.config.globalProperties:null,this.bricksforgeRoot&&(this.bricksforgeState=this.bricksforgeRoot.$pinia.state,this.bricksforgeStores=this.bricksforgeState._value,this.bricksforgeStoreAi=this.bricksforgeStores.ai)}),2500)}refreshState(){this.bricksState=this.bricksRoot.$_state,this.bricksContent=this.bricksState.content}initMutationObservers(){this.bricksPanelObserver=new MutationObserver((e=>{if(this.getActiveElement(),"brf-pro-forms"===this.bricksActiveElement)this.handleProForms()})),this.bricksPanelObserver.observe(document.querySelector("#bricks-panel-inner"),{childList:!0,subtree:!0}),this.bricksStructureObserver=new MutationObserver((e=>{this.handleProFormsDuplicatedIds()})),this.bricksStructureObserver.observe(document.querySelector("#bricks-structure"),{childList:!0,subtree:!0})}initFunctions(){this.createTerminalShortcut=this.runCreateTerminalShortcut.bind(this)}addContextMenuItems(){"undefined"!=typeof BRFTERMINAL&&(this.createContextMenuItem("Create Terminal Command","BRFBUILDER.createTerminalShortcut()"),this.createContextMenuSeparator())}createContextMenuItem(e,t){let r=document.querySelector("#bricks-builder-context-menu ul");const i=document.createElement("li");i.id="brfCreateTerminalShortcut",i.innerHTML='<span class="label">'+e+"</span>",i.setAttribute("onclick",t);let s=r.querySelectorAll("li[id*='brf']");s=s[s.length-1],s?r.insertBefore(i,s.nextSibling):r.insertBefore(i,r.firstChild)}createContextMenuSeparator(){let e=document.querySelector("#bricks-builder-context-menu ul");const t=document.createElement("li");t.classList.add("sep");let r=e.querySelectorAll("li[id*='brf']");r=r[r.length-1],r&&e.insertBefore(t,r.nextSibling)}getActiveElement(e=!1){return this.bricksState.activeElement?e?(this.bricksActiveElementObject=this.bricksState.activeElement,this.bricksState.activeElement):(this.bricksActiveElement=this.bricksState.activeElement.name,this.bricksState.activeElement.name):null}handleProForms(){}handleProFormsAi(){const e=document.querySelector(".bricks-panel-controls");if(e&&!e.querySelector(".bricksforge-button-ai")){const t=this.createButton("Bricksforge Assistant","block",{marginBottom:"-10px"},null,(()=>{this.bricksforgeStoreAi.showAiModal=!0}));e.prepend(t)}}handleProFormsDuplicatedIds(){this.refreshState();const e=this.bricksContent.filter((e=>e.name.includes("brf-pro-forms-field")));if(!e)return;const t=e.map((e=>[e.settings.id,e.parent])).filter(((e,t,r)=>r.indexOf(e[0])!==t));t&&t.forEach((t=>{let r=t[0],i=t[1],s=e.filter((e=>e.settings.id===r&&e.parent==i));if(s.length>1){const e=s[s.length-1];this.updateElementSetting(e.id,"id",this.bricksRoot.$_generateId())}}))}generateRandomId(){return Math.random().toString(36).substr(2,9)}createButton(e,t="block",r={},i={},s=null){const n=document.createElement("button"),o=document.createElement("div");if("block"===t)o.classList.add("bricksforge-button-wrapper"),n.classList.add("button"),n.classList.add("block"),n.classList.add("bricksforge-button"),n.classList.add("bricksforge-button-ai");if(n.innerText=e,r)for(const[e,t]of Object.entries(r))n.style[e]=t;if(i)for(const[e,t]of Object.entries(i))n.setAttribute(e,t);return s&&n.addEventListener("click",s),o.appendChild(n),o}updateElementSetting(e,t,r){this.refreshState();const i=this.bricksContent.find((t=>t.id===e));i&&i.settings&&(i.settings[t]=r)}hideMessages(){document.querySelectorAll("#bricks-message").forEach((e=>{e.setAttribute("data-hidden","true")}))}showMessages(){document.querySelectorAll("#bricks-message").forEach((e=>{e.removeAttribute("data-hidden")}))}async runCreateTerminalShortcut(){if(!this.getActiveElement(!0))return;let e=null;if(document.querySelectorAll("#bricks-builder-context-menu li").forEach((t=>{t.querySelector(".shortcut")&&"CMD + C"==t.querySelector(".shortcut").innerText&&(e=t)})),!e||!BRFTERMINAL)return;let t=BRFTERMINAL.commands;BRFTERMINAL.initTerminal(),BRFTERMINAL.setScope("basic");let r=await BRFTERMINAL.openTerminal({placeholder:"Enter Terminal Command. Example: new-command"});if(t.filter((e=>e.shortcut==r)).length>0)return alert("This name already exists!"),void BRFTERMINAL.finish();e.click();const i=await navigator.clipboard.readText();let s={id:this.generateRandomId(),shortcut:r,data:i,status:"active",tags:[]};"object"==typeof t&&t.push(s);try{if(200==(await fetch(BRFBUILDER.apiurl+"save_option",{method:"POST",headers:{"X-WP-Nonce":BRFBUILDER.nonce,"Content-Type":"application/json"},body:JSON.stringify(["brf_terminal_commands",t])})).status)return BRFTERMINAL.success("New Terminal Command Created!"),void BRFTERMINAL.finish({newCommand:s})}catch(e){console.log(e),BRFTERMINAL.finish()}BRFTERMINAL.finish()}}document.addEventListener("DOMContentLoaded",(()=>{!bricksIsFrontend&&document.querySelector("#bricks-toolbar")&&setTimeout((()=>{BRFBUILDER={...BRFBUILDER,...new BricksforgeBuilder}}),1e3)}));