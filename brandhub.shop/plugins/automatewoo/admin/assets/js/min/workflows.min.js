!function(t,e){AW.Workflow=Backbone.Model.extend({getAction(t){const e=AW.workflow.get("actions");if(e[t])return e[t]}}),AW.WorkflowView=Backbone.View.extend({el:t("form#post"),$triggerSelect:t(".js-trigger-select"),$triggerDescription:t(".js-trigger-description"),$manualTriggerSelect:t(".js-manual-trigger-select"),$typeSelect:t(".automatewoo-workflow-type-field"),initialize(){this.listenTo(this.model,"change:trigger",this.changeTrigger),this.model.set("prevTrigger",this.$triggerSelect.val()),this.model.set("prevManualTrigger",this.$manualTriggerSelect.val()),this.model.set("prevType",this.$typeSelect.val()),this.setTriggerOptions(),this.insertMetaboxHelpTips()},changeTrigger(){AW.rules.resetAvailableRules(),t(document.body).trigger("wc-enhanced-select-init"),AW.initTooltips(),AW.Validate.validateAllFields(),AutomateWoo.Workflows.trigger_compatibility_warning()&&AW.workflowView.completeTriggerChange()},completeTriggerChange(){AW.rules.clearIncompatibleRules(),AutomateWoo.Workflows.clearIncompatibleActions(),AutomateWoo.Modal.close(),AutomateWoo.Workflows.refine_variables(),AutomateWoo.Workflows.refine_action_selects(),AutomateWoo.Workflows.maybe_disable_queueing(),this.updateTriggerDescription(),this.model.set("prevTrigger",this.$triggerSelect.val()),this.model.set("prevManualTrigger",this.$manualTriggerSelect.val()),this.model.set("prevType",this.$typeSelect.val()),t(document.body).trigger("automatewoo_trigger_changed")},cancelTriggerChange(){this.$typeSelect.val()!==this.model.get("prevType")&&this.$typeSelect.val(this.model.get("prevType")).trigger("change"),this.$triggerSelect.val(this.model.get("prevTrigger")).trigger("change",!0),this.$manualTriggerSelect.val(this.model.get("prevManualTrigger")).trigger("change")},setTriggerOptions(){const e=[];t('[name^="aw_workflow_data[trigger_options]"]').each((function(){"checkbox"===t(this).attr("type")?e.push({name:t(this).attr("name"),value:t(this).is(":checked")}):e.push({name:t(this).attr("name"),text:t(this).text(),value:t(this).val()})})),this.model.set("prevTriggerOptions",e)},updateTriggerDescription(){const t=this.model.get("trigger");t&&t.description?this.$triggerDescription.html('<p class="aw-field-description">'+t.description+"</p>"):this.$triggerDescription.html("")},initAction(e,o){const a=this.model.getAction(e);a?(o.attr("data-automatewoo-action-name",e),o.attr("data-automatewoo-action-group",a.group),o.attr("data-automatewoo-action-can-be-previewed",a.can_be_previewed)):(o.removeAttr("data-automatewoo-action-name"),o.removeAttr("data-automatewoo-action-group"),o.removeAttr("data-automatewoo-action-can-be-previewed")),o.find("[data-automatewoo-dynamic-select]").each((function(e,a){AW.workflowView.initDynamicActionSelect(t(a),o)})),AW.initTooltips(),AutomateWoo.Workflows.action_dependent_fields(o),AutomateWoo.init_date_pickers(),o.find(".automatewoo-field").on("invalid",(function(){const e=t("#aw_actions_box"),o=t(this).parents(".automatewoo-action");e.hasClass("closed")&&e.find(".handlediv").trigger("click"),o.hasClass("js-open")||(AutomateWoo.Workflows.action_edit_open(o),this.scrollIntoView())}))},initDynamicActionSelect(t,e){const o=t.attr("data-automatewoo-dynamic-select-reference"),a=e.find('.automatewoo-field[data-name="'+o+'"]');a.on("change",(function(){AW.workflowView.updateDynamicActionSelect(t,a,e)}))},updateDynamicActionSelect(e,o,a){if(e.is(".automatewoo-field--loading"))return;if(e.find("option[value!='']").remove(),!o.val())return;const i=e.parents(".automatewoo-table__row");i.addClass("automatewoo-field-row--loading");const n={action:"aw_update_dynamic_action_select",action_name:a.data("automatewoo-action-name"),target_field_name:e.attr("data-name"),reference_field_value:o.val(),nonce:AW.workflow.get("nonces").aw_update_dynamic_action_select};t.post(ajaxurl,n,(function(o){i.removeClass("automatewoo-field-row--loading"),o.success&&t.each(o.data,(function(o,a){e.append(t("<option/>",{value:o,text:a}))}))}))},initTrigger(){const e=t("#aw_trigger_box");e.find("[data-automatewoo-dynamic-select]").each((function(o,a){AW.workflowView.initDynamicTriggerOptions(t(a),e)})),t('[name^="aw_workflow_data[trigger_options]"]').on("change",(()=>{this.setTriggerOptions()}))},initDynamicTriggerOptions(t,e){const o=t.attr("data-automatewoo-dynamic-select-reference"),a=e.find('.automatewoo-field[data-name="'+o+'"]');a.on("change",(function(){AW.workflowView.updateDynamicTriggerOptions(t,a)}))},updateDynamicTriggerOptions(e,o){if(e.is(".automatewoo-field--loading"))return;if(e.empty(),!o.val())return;const a=e.parents(".automatewoo-table__row");a.addClass("automatewoo-field-row--loading");const i={action:"aw_update_dynamic_trigger_options_select",trigger_name:t('#aw_trigger_box select[name="aw_workflow_data[trigger_name]"]').val(),target_field_name:e.attr("data-name"),reference_field_value:o.val(),nonce:AW.workflow.get("nonces").aw_update_dynamic_trigger_options_select};t.post(ajaxurl,i,(function(o){if(o.success){const a=t.map(o.data,(function(e,o){return t("<option/>",{value:o,text:e})}));a&&a.length&&e.append(a)}a.removeClass("automatewoo-field-row--loading")}))},insertMetaboxHelpTips(){const e=this.model.get("metaBoxHelpTips");_.each(e,(function(e,o){$metabox=t("#aw_"+o),$metabox.find("h2.hndle").append(e)}))}}),AW.TriggerCompatibilityModalView=Backbone.View.extend({className:"aw-view-trigger-compatibility-modal",template:wp.template("aw-trigger-compatibility-modal"),data:null,initialize(t){this.data=t,document.body.addEventListener("awmodal-close",(t=>{"dismiss"===t.detail.closedBy&&AW.workflowView.cancelTriggerChange()}),{once:!0}),this.$el.on("click",".js-confirm",(function(){AW.workflowView.completeTriggerChange()}))},render(){return this.$el.html(this.template(this.data)),this}}),AW.TriggerPresetActivationModalView=Backbone.View.extend({className:"aw-view-trigger-preset-activation-modal",template:wp.template("aw-trigger-preset-activation-modal"),data:null,initialize(e){this.data=e,this.$el.on("click",".js-confirm",(()=>{this.disableButtons(),e.action="confirm",AutomateWoo.Modal.close(),t(AW.workflowView.el).data("aw-preset-workflow-confirmed",!0).trigger("submit")})),this.$el.on("click",`.${AutomateWoo.Modal.triggerClasses.close}`,(()=>{e.action="cancel",this.disableButtons()}))},disableButtons(){this.$el.find(".automatewoo-modal__footer button").addClass("disabled")},render(){return this.$el.html(this.template(this.data)),this},open(){this.data.action="dismiss",AutomateWoo.Modal.open(),AutomateWoo.Modal.contents(this.render().el),AW.tracks.recordEvent("preset_activation_alert_rendered",{is_active:this.data.isActive}),document.body.addEventListener("awmodal-close",(()=>AW.tracks.recordEvent("preset_activation_alert_closed",{is_active:this.data.isActive,action:this.data.action})),{once:!0})}}),AW.workflow=new AW.Workflow(e),AW.workflowView=new AW.WorkflowView({model:AW.workflow}),AW.Validate.init()}(jQuery,automatewooWorkflowLocalizeScript),jQuery((function(t){function e(){const e=t('input[name="aw_workflow_data[trigger_options][days_since_last_purchase]"]'),o=t('input[name="aw_workflow_data[trigger_options][days_since_last_purchase_max]"]');e.on("change keyup",(function(){const t=e.val()?parseInt(e.val(),10):0;let a="";t&&(a=t+3),o.attr("min",t+1),o.attr("placeholder",a)})).trigger("change")}AutomateWoo.Workflows={$triggers_box:t("#aw_trigger_box"),$manual_workflow_box:t("#aw_manual_workflow_box"),$actions_box:t("#aw_actions_box"),$actions_container:t(".aw-actions-container"),$action_template:t(".aw-action-template"),$trigger_select:t(".js-trigger-select").first(),$manual_trigger_select:t(".js-manual-trigger-select").first(),init(){AutomateWoo.Workflows.init_triggers_box(),AutomateWoo.Workflows.init_actions_box(),AutomateWoo.Workflows.init_options_box(),AutomateWoo.Workflows.refine_variables()},init_triggers_box(){AutomateWoo.Workflows.$trigger_select.on("change",(function(e,o){AutomateWoo.Workflows.fill_trigger_fields(t(this).val(),o)})),AutomateWoo.Workflows.$manual_trigger_select.on("change",(function(){AutomateWoo.Workflows.fill_manual_workflow_trigger_fields(t(this).val())})),AW.workflowView.initTrigger()},init_actions_box(){t(".automatewoo-action.js-open").each((function(){AutomateWoo.Workflows.action_edit_open(t(this))})),t(".js-aw-add-action").on("click",(function(t){t.preventDefault(),AutomateWoo.Workflows.add_new_action()})),t(document).on("click",".js-edit-action",(function(e){e.preventDefault();const o=t(this).parents(".automatewoo-action").first();o.is(".js-open")?AutomateWoo.Workflows.action_edit_close(o):AutomateWoo.Workflows.action_edit_open(o)})),t(document).on("click",".js-delete-action",(function(e){e.preventDefault();const o=t(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.action_delete(o)})),t(document).on("change",".js-action-select",(function(){const e=t(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.fill_action_fields(e,t(this).val())})),t(document).on("click","[data-automatewoo-preview]",(function(e){e.preventDefault();const o=t(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.preview_action(o)})),AW.workflow.get("isNew")||(AutomateWoo.Workflows.refine_action_selects(),AutomateWoo.Workflows.refine_variables(),AutomateWoo.Workflows.maybe_disable_queueing(),t(".automatewoo-action").each((function(e,o){AW.workflowView.initAction(t(o).find(".js-action-select").val(),t(o))})))},init_options_box(){const e=t(".aw-checkbox-enable-click-tracking");AutomateWoo.Workflows.maybe_hide_tracking_options(),e.on("click",(function(){AutomateWoo.Workflows.maybe_hide_tracking_options()}))},maybe_hide_tracking_options(){t(".aw-checkbox-enable-click-tracking").is(":checked")?t(".js-require-email-tracking").show():t(".js-require-email-tracking").hide()},fill_trigger_fields(e,o=!1){AutomateWoo.Workflows.$triggers_box.find("tr.aw-trigger-option").remove(),e?(AutomateWoo.Workflows.$triggers_box.addClass("aw-loading"),this.fetch_trigger_data(e).done((function(e){if(e.success){if(AutomateWoo.Workflows.$triggers_box.find("tbody").append(e.data.fields),AutomateWoo.Workflows.$triggers_box.removeClass("aw-loading"),o){const e=AW.workflow.get("prevTriggerOptions");t.each(e,(function(e,o){const a=t(`[name="${o.name}"]`);switch(a.prop("type")){case"select-one":if(0===a.find("option").length){const e=t("<option />").attr("value",o.value).text(o.text);a.append(e)}else a.val(o.value);break;case"checkbox":a.prop("checked",o.value);break;default:a.val(o.value)}a.trigger("change")}))}AW.workflow.set("trigger",e.data.trigger),AW.workflowView.initTrigger()}}))):AW.workflow.set("trigger",!1)},fetch_trigger_data(e){return t.ajax({method:"GET",url:ajaxurl,data:{action:"aw_fill_trigger_fields",trigger_name:e,workflow_id:AW.workflow.get("id"),is_new_workflow:AW.workflow.get("isNew"),nonce:AW.workflow.get("nonces").aw_fill_trigger_fields}})},fill_manual_workflow_trigger_fields(t){const e=AutomateWoo.Workflows.$manual_workflow_box;e.find("tr.aw-trigger-option").remove(),t?(e.addClass("aw-loading"),this.fetch_trigger_data(t).done((function(t){t.success&&(e.find("tbody").append(t.data.fields),e.removeClass("aw-loading"),AW.workflow.set("trigger",t.data.trigger))}))):AW.workflow.set("trigger",!1)},add_new_action(){const e=AutomateWoo.Workflows.get_number_of_actions()+1;t(".js-aw-no-actions-message").hide();const o=AutomateWoo.Workflows.$action_template.clone();o.removeClass("aw-action-template"),o.addClass("automatewoo-action"),AutomateWoo.Workflows.$actions_container.append(o),o.attr("data-action-number",e),AutomateWoo.Workflows.action_edit_open(o)},get_editing_action_cookie_name(t){return`aw_editing_action_${AW.workflow.get("id")}_${t}`},action_edit_open(t){const e=t.data("action-number");t.addClass("js-open"),t.find(".automatewoo-action__fields").slideDown(150),AW.initTooltips(),Cookies.set(this.get_editing_action_cookie_name(e),1,{sameSite:"strict"})},action_dependent_fields(e){e.find("[data-hide-when-checked]").each((function(){const e=t(this),o=e.data("hideWhenChecked"),a=t(`[data-name="${o}"]`).find('input[type="checkbox"]');if(!a)return;const i=e.closest("tr.automatewoo-table__row");a.on("change",(function(){this.checked?i.hide():i.show()})).trigger("change")}))},action_edit_close(t){const e=t.data("action-number");t.removeClass("js-open"),t.find(".automatewoo-action__fields").slideUp(150),Cookies.remove(this.get_editing_action_cookie_name(e))},action_delete(t){t.remove()},fill_action_fields(e,o){const a=e.data("action-number"),i=e.find(".js-action-select");AutomateWoo.Workflows.$actions_box.addClass("aw-loading"),e.find('tr.automatewoo-table__row:not([data-name="action_name"])').remove(),t.ajax({method:"GET",url:ajaxurl,data:{action:"aw_fill_action_fields",action_name:o,action_number:a,workflow_id:AW.workflow.get("id"),nonce:AW.workflow.get("nonces").aw_fill_action_fields}}).done((function(t){e.find(".automatewoo-table tbody").append(t.data.fields),AutomateWoo.Workflows.$actions_box.removeClass("aw-loading"),i.attr("name","aw_workflow_data[actions]["+a+"][action_name]"),e.find(".action-title").text(t.data.title),e.find(".js-action-description").html(t.data.description),AW.workflowView.initAction(o,e)}))},get_number_of_actions(){return t(".automatewoo-action").length},refine_variables(){const e=AW.workflow.get("trigger");e?(t("#aw_variables_box").show(),t(".aw-variables-group").each((function(o,a){const i=t(a).data("automatewoo-variable-group");-1===t.inArray(i,e.supplied_data_items)?t(a).hide():t(a).show()}))):t("#aw_variables_box").hide()},refine_action_selects(){t(".js-action-select").each((function(){t(this).find("option").each((function(){t(this).prop("disabled",!AutomateWoo.Workflows.is_action_compatible_with_current_trigger(t(this).val()))}))}))},maybe_disable_queueing(){const e=AW.workflow.get("trigger");e&&e.allow_queueing?t("#aw_timing_box").show():t("#aw_timing_box").hide()},trigger_compatibility_warning(){let e=[],o=[];if(_.each(AW.rules.get("ruleOptions"),(function(t){_.each(t.get("rules"),(function(t){if(t.get("name")&&!AW.rules.isRuleAvailable(t.get("name"))){const o=t.get("object");e.push(o.title)}}))})),t(".js-action-select").each((function(){AutomateWoo.Workflows.is_action_compatible_with_current_trigger(t(this).val())||o.push(t(this).find("option:selected").text())})),e.length||o.length){o=_.uniq(o),e=_.uniq(e);const t=new AW.TriggerCompatibilityModalView({incompatibleRules:e,incompatibleActions:o});return AutomateWoo.Modal.open(),AutomateWoo.Modal.contents(t.render().el),!1}return!0},clearIncompatibleActions(){t(".js-action-select").each((function(){if(!AutomateWoo.Workflows.is_action_compatible_with_current_trigger(t(this).val())){const e=t(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.action_delete(e)}}))},is_action_compatible_with_current_trigger(e){let o=!0;const a=AW.workflow.getAction(e);if(!a)return!0;if(!a.required_data_items.length)return!0;const i=AW.workflow.get("trigger");return t.each(a.required_data_items,(function(e,a){-1===t.inArray(a,i.supplied_data_items)&&(o=!1)})),o},preview_action(e){const o=e.data("action-number"),a=AW.workflow.get("trigger"),i={};AutomateWoo.isEmailPreviewOpen()&&AutomateWoo.Workflows.$actions_box.addClass("aw-loading"),"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave();const n="aw_workflow_data[actions]["+o+"]";e.find('[name*="'+n+'"]').each((function(e,o){let a,r;a=t(o).attr("name");const s=/\[]$/.test(a);s&&(a=a.replace("[]",""));const l=a.replace(n,"").replace("[","").replace("]","");r="checkbox"===t(o).attr("type")?o.checked?"1":"":t(o).val(),s?(i.hasOwnProperty(l)||(i[l]=[]),i[l].push(r)):i[l]=r})),AutomateWoo.openLoadingEmailPreview(),t.ajax({method:"POST",url:ajaxurl,data:{action:"aw_save_preview_data",workflow_id:AW.workflow.get("id"),trigger_name:a?a.name:"",action_fields:i,nonce:AW.workflow.get("nonces").aw_save_preview_data},success(){AutomateWoo.open_email_preview("workflow_action",{workflow_id:AW.workflow.get("id"),action_number:o})},complete(){AutomateWoo.Workflows.$actions_box.removeClass("aw-loading")}})},init_ajax_wysiwyg(e){if("undefined"==typeof tinymce||void 0===tinyMCEPreInit.mceInit.automatewoo_editor)return;const o=t.extend({},tinyMCEPreInit.mceInit.automatewoo_editor),a=t.extend({},tinyMCEPreInit.qtInit.automatewoo_editor);if(o.selector="#"+e,o.id=e,o.wp_autoresize_on=!1,tinyMCEPreInit.mceInit[o.id]=o,a.id=e,tinymce.$("#wp-"+e+"-wrap").hasClass("tmce-active")||!tinyMCEPreInit.qtInit.hasOwnProperty(e))try{tinymce.init(o)}catch(t){}try{const t=quicktags(a);this.init_wysiwyg_buttons(t)}catch(t){}},init_wysiwyg_buttons(t){canvas=t.canvas,name=t.name,settings=t.settings,html="",theButtons={},use="",settings.buttons&&(use=","+settings.buttons+",");for(const t in edButtons){if(!edButtons[t])continue;const e=edButtons[t].id;use&&-1!==",strong,em,link,block,del,ins,img,ul,ol,li,code,more,close,".indexOf(","+e+",")&&-1===use.indexOf(","+e+",")||edButtons[t].instance&&edButtons[t].instance!==inst||(theButtons[e]=edButtons[t],edButtons[t].html&&(html+=edButtons[t].html(name+"_")))}use&&-1!==use.indexOf(",fullscreen,")&&(theButtons.fullscreen=new qt.FullscreenButton,html+=theButtons.fullscreen.html(name+"_")),"rtl"===document.getElementsByTagName("html")[0].dir&&(theButtons.textdirection=new qt.TextDirectionButton,html+=theButtons.textdirection.html(name+"_")),t.toolbar.innerHTML=html,t.theButtons=theButtons}},AutomateWoo.Workflows.init(),t(document.body).on("automatewoo_trigger_changed",(function(){e()})),t("#automatewoo-workflow-run-btn").on("click",(function(){return t('input[name="automatewoo_redirect_to_runner"]').val(1),t("#publish").trigger("click"),!1})),t("form#post").on("submit",(function(){const e=t(this),o="active"===t("select[name=workflow_status]",e).val(),a=e.data("aw-preset-workflow-confirmed");return!(/workflow-origin=preset/.test(window.location.href)&&!a)||(new AW.TriggerPresetActivationModalView({isActive:o}).open(),!1)})),e(),function(){const e=t(".automatewoo-workflow-type-field");function o(e,o){"manual"===e?(t("#aw_trigger_box, #automatewoo-workflow-status-field-row").hide(),t("#aw_manual_workflow_box").show(),t("#automatewoo-workflow-run-btn").show().css("display","inline-block")):(t("#automatewoo-workflow-run-btn, #aw_manual_workflow_box").hide(),t("#aw_trigger_box, #automatewoo-workflow-status-field-row").show()),o&&(AutomateWoo.Workflows.$manual_trigger_select[0].selectedIndex=0,AutomateWoo.Workflows.$trigger_select[0].selectedIndex=0,AutomateWoo.Workflows.$triggers_box.find("tr.aw-trigger-option").remove(),AW.workflow.set("trigger",!1))}e.on("change",(function(){o(e.val(),!0)})),o(e.val(),!1)}()}));
//# sourceMappingURL=workflows.min.js.map