!function(t){"use strict";t.AviaElementBehavior=t.AviaElementBehavior||{},t.AviaElementBehavior.history=function(i){if("undefined"==typeof Storage)return!1;this.options=t.extend({},{steps:40,monitor:"",editor:"",buttons:"",event:"avia-storage-update"},i),this.setUp()},t.AviaElementBehavior.history.prototype={setUp:function(){this.canvas=t(this.options.monitor),this.wrapper=this.canvas.parent(),this.buttons=t(this.options.buttons),this.editor=t(this.options.editor),this.key=this.create_array_key(),this.storage=this.get()||[],this.max=this.storage.length-1,this.index=this.get(this.key+"index"),void 0!==this.index&&null!=this.index||(this.index=this.storage.length-1),this.undoBtn=t('<a href="#undo" class="avia-undo-button " title="'+avia_history_L10n.undo_label+'"><-</a>').appendTo(this.buttons),this.redoBtn=t('<a href="#redo" class="avia-redo-button " title="'+avia_history_L10n.redo_label+'">-></a>').appendTo(this.buttons),this.clear(),this.bindEvents()},create_array_key:function(){var t="avia"+avia_globals.themename+avia_globals.themeversion+avia_globals.post_id+avia_globals.builderversion;return t=t.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()},bindEvents:function(){var t=this;this.canvas.on("avia-storage-update",(function(){t.do_snapshot()})),this.wrapper.on("click",".avia-undo-button",(function(){t.undo()})),this.wrapper.on("click",".avia-redo-button",(function(){t.redo()}))},set:function(t,i){var s=t||this.key,e=i||JSON.stringify(this.storage);try{sessionStorage.setItem(s,e)}catch(a){avia_log("Storage Limit reached. Your Browser does not offer enough session storage to save more steps for the undo/redo history."),avia_log(a),this.clear(),this.redoBtn.addClass("avia-inactive-step"),this.undoBtn.addClass("avia-inactive-step")}},get:function(t){var i=t||this.key;return JSON.parse(sessionStorage.getItem(i))},clear:function(){sessionStorage.removeItem(this.key),sessionStorage.removeItem(this.key+"index"),this.storage=[],this.index=null},redo:function(){return this.index+1<=this.max&&(this.index++,this.update_canvas(this.storage[this.index])),!1},undo:function(){return this.index-1>=0&&(this.index--,this.update_canvas(this.storage[this.index])),!1},update_canvas:function(t){void 0===this.tinyMCE&&(this.tinyMCE=void 0!==window.tinyMCE&&window.tinyMCE.get(this.options.editor.replace("#",""))),this.tinyMCE&&this.tinyMCE.setContent(window.switchEditors.wpautop(t[0]),{format:"html"}),this.editor.val(t[0]),this.canvas.html(t[1]),sessionStorage.setItem(this.key+"index",this.index),this.index+1>this.max?this.redoBtn.addClass("avia-inactive-step"):this.redoBtn.removeClass("avia-inactive-step"),this.index<=0?this.undoBtn.addClass("avia-inactive-step"):this.undoBtn.removeClass("avia-inactive-step"),this.canvas.trigger("avia-history-update")},do_snapshot:function(){this.canvas.find("textarea").each((function(){this.innerHTML=this.value})),this.storage=this.storage||this.get()||[],this.index=this.index||this.get(this.key+"index"),void 0!==this.index&&null!=this.index||(this.index=this.storage.length-1);var t=[this.editor.val(),this.canvas.html().replace(/avia_pop_class/g,"")],i=this.storage[this.index];void 0!==i&&i[0]===t[0]||(this.index++,this.storage=this.storage.slice(0,this.index),this.storage.push(t),this.options.steps<this.storage.length&&this.storage.shift(),this.set()),this.max=this.storage.length-1,1==this.storage.length||0==this.index?this.undoBtn.addClass("avia-inactive-step"):this.undoBtn.removeClass("avia-inactive-step"),this.storage.length-1==this.index?this.redoBtn.addClass("avia-inactive-step"):this.redoBtn.removeClass("avia-inactive-step")}}}(jQuery);