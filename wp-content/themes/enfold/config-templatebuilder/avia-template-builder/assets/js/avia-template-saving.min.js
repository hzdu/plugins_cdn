!function(a){"use strict";a.AviaElementBehavior=a.AviaElementBehavior||{},a.AviaElementBehavior.wp_save_template=function(){this.container=a(".avia-template-save-button-container"),this.toggle=this.container.find(".open-template-button"),this.dropdown=this.container.find(".avia-template-save-button-inner"),this.location=this.dropdown.find("select"),this.list=this.dropdown.find("ul"),this.save_btn=this.container.find(".save-template-button"),this.save_single_container=this.container.parents(".postbox"),this.savebox=!1,this.template_val="",this.bind_events()},a.AviaElementBehavior.wp_save_template.prototype={bind_events:function(){var e=this;this.list.on("click","span:not(.preloading)",(function(a){e.delete_template(a)})),this.list.on("click","a",(function(a){e.fetch_template(a)})),this.toggle.on("click",(function(){e.toggle_dropdown()})),this.save_btn.on("click",(function(){e.open_modal()})),this.save_single_container.on("click",".avia-save-element",(function(a){e.open_modal(a)})),a("body").on("click",(function(a){e.close_check(a)}))},toggle_dropdown:function(){return this.container.is(".avia-hidden-dropdown")?(this.container.removeClass("avia-hidden-dropdown"),this.toggle.removeClass("av-template-added-highlight")):this.container.addClass("avia-hidden-dropdown"),!1},close_check:function(e){this.container.is(".avia-hidden-dropdown")||0!=a(e.target).parents(".avia-template-save-button-container, .avia-modal").eq(0).length||this.toggle_dropdown()},open_modal:function(e){if(a.avia_builder.updateTextarea(),this.textarea_value(e),-1===this.template_val.indexOf("["))this.toggle_dropdown(),new a.AviaModalNotification({mode:"attention",msg:avia_template_save_L10n.no_content});else{var t=avia_template_save_L10n.chose_name,i="<input name = 'avia-builder-template' type='text' class='avia-template-name-ajax' value='' maxlength='40' /><span class='avia-template-save-msg'>"+avia_template_save_L10n.save_msg+"</span><span class='avia-template-save-chars'>"+avia_template_save_L10n.chars+", A-Z, 0-9, -_</span>";void 0!==e&&(t=avia_template_save_L10n.chose_save),this.savebox=new a.AviaModalNotification({mode:"attention",msg:i,modal_title:t,button:"save",scope:this,on_save:this.try_save,save_param:{event:e}})}return!1},textarea_value:function(e){return this.template_val="",void 0!==e&&"avia-save-element"==e.currentTarget.className?this.template_val=a(e.currentTarget).parent("div").next(".avia_inner_shortcode").children("textarea").val().trim():this.template_val=a("#content.wp-editor-area").val().trim(),this.template_val},update_entry_list:function(e){var t=this;this.list.find(".avia-no-template").slideUp(200,(function(){a(this).remove()}));var i=a("<li><a href='#'>"+e+"</a><span class='avia-delete-template'></span></li>").css("display","none").appendTo(this.list),n=this.list.children("li").get();n.sort((function(e,t){return a(e).text().toUpperCase().localeCompare(a(t).text().toUpperCase())})),a.each(n,(function(a,e){t.list.append(e)})),i.slideDown()},insert_template:function(e,t){a.avia_builder.sendToAdvancedEditor(e,t),a.avia_builder.updateTextarea(),a.avia_builder.do_history_snapshot()},fetch_template:function(e){e.preventDefault();var t=this,i=a(e.target),n=i.parent().find("span"),o=i.text(),l=t.location.val();a.ajax({type:"POST",url:ajaxurl,data:{action:"avia_ajax_fetch_builder_template",templateName:o,avia_request:!0,_ajax_nonce:a("#avia-loader-nonce").val()},beforeSend:function(){n.addClass("preloading")},error:function(){n.removeClass("preloading"),new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.ajax_error})},success:function(e){n.removeClass("preloading"),0==e?new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.login_error}):"-1"==e?new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.timeout}):-1!==e.indexOf("avia_fetching_error")?new a.AviaModalNotification({mode:"error",msg:avia_template_save_L10n.not_found}):(l="av-load-top"==l?"prepend":"append",t.insert_template(e,l))}})},delete_template:function(e){e.preventDefault();var t=a(e.target),i=t.prev("a"),n=i.parent(),o=i.text();a.ajax({type:"POST",url:ajaxurl,data:{action:"avia_ajax_delete_builder_template",post_id:avia_globals.post_id,templateName:o,avia_request:!0,"avia-save-nonce":a("#avia-save-nonce").val(),_ajax_nonce:a("#avia-loader-nonce").val()},beforeSend:function(){t.addClass("preloading")},error:function(){t.removeClass("preloading"),new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.ajax_error})},success:function(e){0==e?(new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.login_error}),t.removeClass("preloading")):"-1"==e?(new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.timeout}),t.removeClass("preloading")):-1!==e.indexOf("avia_template_deleted")&&n.slideUp(300,(function(){n.remove()}))}})},try_save:function(e,t){var i=this,n=e["avia-builder-template"],o=n.match(/[^a-zA-Z0-9-_ ]/),l=!1,s=this.savebox.modal.find(".avia-template-save-msg").text(avia_template_save_L10n.save_msg),r=this.savebox.modal.find(".avia-modal-inner-footer");return this.savebox.modal.find(".avia-template-save-error").removeClass("avia-template-save-error"),n.length<3&&(s.addClass("avia-template-save-error"),l=!0),null!=o&&(this.savebox.modal.find(".avia-template-save-chars").addClass("avia-template-save-error"),l=!0),l||(i.template_val=a.avia_builder.clear_av_uid(i.template_val),a.ajax({type:"POST",url:ajaxurl,data:{action:"avia_ajax_save_builder_template",post_id:avia_globals.post_id,templateName:n,avia_request:!0,templateValue:i.template_val,"avia-save-nonce":a("#avia-save-nonce").val(),_ajax_nonce:a("#avia-loader-nonce").val()},beforeSend:function(){r.addClass("preloading")},error:function(){r.removeClass("preloading"),a.AviaModal.openInstance[0].close(),new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.ajax_error})},success:function(e){r.removeClass("preloading"),0==e?(a.AviaModal.openInstance[0].close(),new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.login_error})):"-1"==e?(a.AviaModal.openInstance[0].close(),new a.AviaModalNotification({mode:"error",msg:avia_modal_L10n.timeout})):-1===e.indexOf("avia_template_saved")?s.addClass("avia-template-save-error").text(e):(i.update_entry_list(n),i.savebox.close(),void 0!==t&&i.toggle.addClass("av-template-added-highlight"))}})),!1}}}(jQuery);