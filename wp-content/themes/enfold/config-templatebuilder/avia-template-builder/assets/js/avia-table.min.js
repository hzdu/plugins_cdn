!function(a){"use strict";a.AviaModal.register_callback=a.AviaModal.register_callback||{},a.AviaModal.register_callback.modal_load_tablebuilder=function(e){var t=e||this.modal,l=a(t),i=a(t).find(".avia-table"),n=!1,o={init:function(){o.attachEvents(),o.on_load()},attachEvents:function(){t.on("change",".avia-table-data-container",o.update_textfield),t.on("click",".avia-table-cell:not(.avia-delete-row .avia-table-cell, .avia-table-col-style .avia-table-cell, .avia-button-row .avia-table-cell)",o.show_editor),t.on("click",".avia-button-row .avia-table-cell",o.add_button),t.on("click",".avia-attach-table-row",o.add_row),t.on("click",".avia-attach-table-col",o.add_col),t.on("click",".avia-delete-row .avia-table-cell",o.remove_col),t.on("click",".avia-attach-delete-table-row",o.remove_row),t.on("click",".avia_sorthandle .avia-delete",o.remove_element),t.on("click",".av-table-pos-button",o.change_order),t.on("change","select[name=column_style]",o.change_col_class),t.on("change","select[name=row_style]",o.change_row_class),t.on("click",o.close_editor),t.on("keyup",o.cell_tab),t.find(".avia-delete-row .avia-table-cell, .avia-table-builder-add-buttons a").disableSelection()},on_load:function(){i.find("textarea").attr("name","content")},cell_tab:function(a){if(9==a.keyCode&&n){var e=i.find(".avia-table-cell:not(.avia-table-cell-delete, .avia-delete-row .avia-table-cell, .avia-template-row .avia-table-cell, .avia-table-cell-style, .avia-table-col-style .avia-table-cell)"),t=e.index(n),l=a.shiftKey?-1:1,o=e.eq(t+l);o.length||(o=1==l?e.eq(0):e.last()),a.preventDefault(),a.stopPropagation(),o.trigger("click")}},show_editor:function(e){e.stopPropagation(),n!=this&&o.close_editor(),this.className+=" avia-show-editor ",a(this).parents(".avia-table-cell").eq(0).add(this).find(".avia-table-data-container").trigger("focus"),n=this},close_editor:function(){l.find(".avia-show-editor").removeClass("avia-show-editor").find(".avia-table-data-container").trigger("change")},update_textfield:function(){var e=this.value;a(this).prev(".avia-table-content").html(avia_nl2br(e))},add_row:function(){var a=l.find(".avia-template-row");a.clone().removeClass("avia-template-row").insertBefore(a)},add_col:function(){if(l.find(".avia-template-row .avia-table-cell").length<=21){var a=l.find(".avia-template-row .avia-table-cell").eq(1),e=l.find(".avia-table-row .avia-table-cell-delete"),t=(a.clone().attr("class","avia-table-cell").insertBefore(e),l.find(".avia-table-cell").eq(1).html());l.find(".avia-table-col-style .avia-table-cell:not(.avia-table-cell-delete)").last().html(t).find("select").val("").trigger("change")}},remove_row:function(){var e=i.find(".avia-table-row"),t=a(this).parents(".avia-table-row").eq(0);e.length>4?t.remove():t.find(".avia-table-data-container").val("").trigger("change")},remove_col:function(e){var t=a(this).parents(".avia-table-row").eq(0).find(".avia-table-cell"),l=t.index(this);t.length>3&&i.find(".avia-table-row .avia-table-cell:nth-child("+(l+1)+")").remove()},change_row_class:function(){var e=a(this),t=e.parents(".avia-table-cell").eq(0),l=e.parents(".avia-table-row").eq(0).find(".avia-table-cell").index(t),n=e.parents(".avia-table-row").eq(0),o=e.find("option").map((function(){return this.value})).get().join(" "),r=e.val();n.removeClass(o).addClass(r),"avia-button-row"==r?n.find("textarea").val("").trigger("change"):i.find(".avia-table-row .avia-table-cell:not(.avia-delete-row .avia-table-cell):nth-child("+(l+1)+")").removeClass(o).addClass(r)},change_col_class:function(){var e=a(this),t=e.parents(".avia-table-cell").eq(0),l=e.parents(".avia-table-row").eq(0).find(".avia-table-cell").index(t),n=e.find("option").map((function(){return this.value})).get().join(" "),o=e.val();i.find(".avia-table-row .avia-table-cell:not(.avia-delete-row .avia-table-cell):nth-child("+(l+1)+")").removeClass(n).addClass(o)},add_button:function(){var e=a("#avia-tmpl-avia_sc_button").html(),t=a(this);t.is(".avia-table-cell")||(t=t.parents(".avia-table-cell").eq(0)),0==t.find(".avia-edit-element, select").length&&(t.html(e),t.find("textarea").attr("name","content").trigger("click"))},remove_element:function(e){var t=a(this),i=l.find(".avia-template-row .avia-table-cell").eq(1);t.parents(".avia-table-cell").eq(0).html(i.html());e.stopImmediatePropagation()},change_order:function(e){var t=a(this),l=t.data("direction");return"up"==l||"down"==l?o.change_row_order(t,l):o.change_col_order(t,l),!1},change_row_order:function(a,e){var t=a.parents(".avia-table-row").eq(0),l="up"===e?t.prev():t.next();l.is(".avia-template-row")||l.is(".avia-attach-table-col-style")||("up"===e?t.insertBefore(l):t.insertAfter(l))},change_col_order:function(e,t){var l=e.parents(".avia-table-cell").eq(0),n=e.parents(".avia-table-row").eq(0).find(".avia-table-cell"),o=n.index(l),r=i.find(".avia-table-row .avia-table-cell:nth-child("+(o+1)+")");1===o&&"left"===t||o===n.length-2&&"right"===t||r.each((function(){var e=a(this);"left"===t?e.insertBefore(e.prev()):e.insertAfter(e.next())}))}};o.init()},a.AviaModal.register_callback.before_table_save=function(a,e){""==a.column_style.length&&(a.column_style=[""]),"string"==typeof a.column_style&&(a.column_style=[a.column_style]);var t=a.column_style.length,l=a.row_style.length-3,i="",n=0;for(var o in i+="[av_table",a)-1!=o.indexOf("aviaTB")&&(i+=" "+o.replace(/aviaTB/g,"")+"='"+a[o]+"'");i+="]\n";for(var r=0;r<l;r++){i+="[av_row row_style='"+a.row_style[r+1]+"']";for(var c=0;c<t;c++)i+="[av_cell col_style='"+a.column_style[c]+"']",i+=a.content[n],i+="[/av_cell]",n++;i+="[/av_row]\n"}return i+="[/av_table]\n\n"}}(jQuery);