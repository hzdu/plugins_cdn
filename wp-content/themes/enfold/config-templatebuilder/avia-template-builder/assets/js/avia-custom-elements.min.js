!function(e){"use strict";e.AviaElementTemplates=function(t){this.builder=t,this.body_container=e("body").eq(0),this.builder_mode=[],this.modalAutocloseTime=2e3,this.elements_container=e(".layout-builder-wrap .avia_layout_builder_custom_elements"),this.canvas_elements=e(".layout-builder-wrap #aviaALBCustomElements"),this.secureContent_elements=e(".layout-builder-wrap #aviaALBCleanDataCustomElements"),this.custom_element_toggle=e("#avia-select-shortcode-type-dropdown"),this.subitem_element_handling="one-element",this.body_container.hasClass("avia-subitem-individual-element")?this.subitem_element_handling="individual-element":this.body_container.hasClass("avia-subitem-no-element")&&(this.subitem_element_handling="no-element"),this.custom_elements_enabled=this.body_container.hasClass("avia-custom-elements-enabled"),this.tab_container=[],this.add_new_btn=[],this.edit_btn=[],this.end_edit_btn=[],this.custom_element_select=[]},e.AviaElementTemplates.prototype={init:function(){this.custom_element_toggle.length<=0||(this.tab_container=this.custom_element_toggle.closest(".avia-tab-container"),this.add_new_btn=this.tab_container.find(".element-button-add-new").first(),this.edit_btn=this.tab_container.find(".element-button-edit").first(),this.end_edit_btn=this.tab_container.find(".element-button-end-edit").first(),this.custom_element_select=this.tab_container.find(".av-custom-element-select-buttons select").first(),this.builder.save_modal_handler=this.save_element_modal,this.builder.close_modal_handler=this.close_element_modal,this.add_behaviour())},add_behaviour:function(){this.hookEvents(),this.toggleShortcodeButtonTypes(),this.toggleCondensedCustomElementTab(),this.createNewElementButton(),this.editElementsButton(),this.filterCustomEditScButtons(),this.bindShortcodeButtonActions()},hookEvents:function(){var e=this;this.tab_container.on("avia_shortcode_buttons_sorted",(function(t){e.bindShortcodeButtonActions.call(e,"reset")})),this.body_container.on("avia_builder_expanded",(function(t,a){var n=a.builder;e.builder.shortcode_wrap.hasClass("avia-edit-elements-clicked")&&(e.end_edit_btn.trigger("click"),n.find(".avia-fixed-controls .shortcode_button_wrap").removeClass("avia-edit-elements-clicked"))}))},clearEditingArea:function(){0==this.builder_mode.length&&(this.builder_mode=this.builder.canvas.closest(".layout-builder-wrap").first()),this.builder_mode.hasClass("avia_mode_debug")||(this.canvas_elements.empty(),this.secureContent_elements.val(""))},toggleShortcodeButtonTypes:function(){var t=this;t.custom_element_toggle.hasClass("avia-condensed")||(t.custom_element_toggle.on("click","a",(function(a){a.preventDefault(),t.custom_element_toggle.find("a").removeClass("shortcode-type-active");var n=e(this),i=n.closest(".avia-tab-title-container"),o=n.data("sc_type"),s=n.html();t.custom_element_toggle.find(".avia-sc-type-label").html(s),n.addClass("shortcode-type-active"),"custom"==o?(i.find(".avia-alb-tab").removeClass("active-tab").hide(),t.tab_container.find(".av-custom-element-buttons").show(),i.find(".avia-custom-element-tab").show().first().addClass("avia-needs-margin ").trigger("click")):(i.find(".avia-custom-element-tab").removeClass("active-tab").hide(),t.tab_container.find(".av-custom-element-buttons").hide(),i.find(".avia-alb-tab").show().first().addClass("avia-needs-margin").trigger("click"))})),setTimeout((function(){var e=t.custom_element_toggle.data("init_sc_type"),a=t.custom_element_toggle.find('a[data-sc_type="'+e+'"]');0==a.length&&(a=t.custom_element_toggle.find(".avia-shortcode-type-list-element a").first()),a.trigger("click")}),100))},toggleCondensedCustomElementTab:function(){var t=this;if(t.custom_element_toggle.hasClass("avia-condensed")){t.tab_container.addClass("avia-custom-elements-condensed");var a=t.tab_container.find("a.avia-alb-tab"),n=t.tab_container.find("a.avia-custom-element-tab");a.on("avia-tab-title-container-clicked",(function(a,n){t.tab_container.addClass("av-alb-tab-selected").removeClass("av-custom-tab-selected"),t.tab_container.find(".av-custom-element-buttons").hide(),e(".avia-fixed-controls .av-custom-element-buttons").hide().removeClass("av-custom-element-editing-disabled")})),n.on("avia-tab-title-container-clicked",(function(a,n){t.tab_container.addClass("av-custom-tab-selected").removeClass("av-alb-tab-selected"),t.tab_container.find(".av-custom-element-buttons").show(),e(".avia-fixed-controls .av-custom-element-buttons").show().addClass("av-custom-element-editing-disabled")}))}},createNewElementButton:function(){if(0!=this.add_new_btn.length){var t=this,a=e("#avia-tmpl-add-new-element-modal-content");0!=a.length?this.add_new_btn.on("click",(function(n){var i={};i.scope=t,i.modal_title=a.data("modal_title"),i.modal_class="avia-create-new-custom-element hide-save-button",i.modal_content=a.html(),i.on_load="modal_new_custom_element",i.on_save=t.newElementCreated,i.button='<a href="#create_element" class="avia-modal-create-new-element avia-modal-create-update-btn button button-primary button-large">'+a.data("modal_button")+"</a>";new e.AviaModal(i)})):alert("Missing script for creating a new template. Not able to create one.")}},editElementsButton:function(){if(0!=this.edit_btn.length&&0!=this.end_edit_btn.length){var e=this.builder.shortcode_wrap;this.edit_btn.on("click",(function(t){e.addClass("avia-edit-elements-clicked show-action-buttons"),setTimeout((function(){e.removeClass("show-action-buttons")}),1e3)})),this.end_edit_btn.on("click",(function(t){e.removeClass("avia-edit-elements-clicked")}))}},filterCustomEditScButtons:function(){if(0!=this.custom_element_select.length){var t=this;this.custom_element_select.on("change",(function(a){a.stopImmediatePropagation();var n=e(this).find("option:selected").val();t.tab_container.removeClass("av-sc-buttons-custom-base-only av-sc-buttons-custom-item-only"),"base_elements_only"==n?t.tab_container.addClass("av-sc-buttons-custom-base-only"):"item_elements_only"==n&&t.tab_container.addClass("av-sc-buttons-custom-item-only")}));var a=this.custom_element_select.data("initial_select");void 0===a&&(a=""),this.custom_element_select.val(a).trigger("change")}},newElementCreated:function(t,a){a=void 0!==a&&a;var n=this.builder.shortcode_wrap;e("#avia-loader-nonce").val(t._ajax_nonce);var i=n.find('.av-custom-element-tab[data-custom_content_name="'+t.tab+'"]');if(0==i.length&&(0==(i=n.find('.av-custom-element-tab[data-custom_content_name="'+t.default_tab+'"]')).length&&(i=n.find(".av-custom-element-tab").first()),0==i.length))return new e.AviaModalNotification({mode:"error",msg:t.no_tab_message}),!1;var o=null,s=t.icons;if(e.each(s,(function(t,a){var n=e(t);a=e(a),n.length>0?n.replaceWith(a):i.append(a),null===o&&(o=a)})),this.builder.replace_js_templates(t.js_templates),this.builder.activate_element_dragging(n,""),this.bindShortcodeButtonActions(),!1!==a)return!0;var l=o.find(".element-edit");return setTimeout((function(){l.trigger("click")}),300),!0},bindShortcodeButtonActions:function(t){var a=this,n=void 0!==t&&t;e.each([{selector:".element-edit",callback:"editSingleElement"},{selector:".element-delete",callback:"deleteSingleElement",nocheck:!0},{selector:".element-clone",callback:"cloneSingleElement"},{selector:".element-custom-action",callback:"customActionSingleElement"}],(function(t,i){!1!==n&&a.builder.shortcode_wrap.find(".avia-custom-element-button "+i.selector).removeClass("av-handler-attached");a.builder.shortcode_wrap.find(".avia-custom-element-button "+i.selector+":not(.av-handler-attached)").each((function(t,n){var o=e(n),s=o.closest(".avia-custom-elements-actions-overlay").data("el_template");!0===i.nocheck||void 0!==s&&0!=e("#avia-tmpl-"+s).length?(o.addClass("av-handler-attached"),o.on("click",{objElTemplate:a},a[i.callback])):o.remove()}))}))},editSingleElement:function(t){t.stopImmediatePropagation();var a=t.data.objElTemplate,n=e(t.target),i=n.closest(".avia-custom-elements-actions-overlay"),o=n.closest(".shortcode_insert_button "),s=i.data("el_template"),l=i.data("element_id"),d=e("#avia-tmpl-"+s),c=o.data("is_item");if(!0===c&&"individual-element"!=a.subitem_element_handling)return alert(avia_modal_L10n.noPermission),!1;if(0==d.length)return alert(avia_modal_L10n.noTemplate),!1;var m=e(d.html()),r=o.data("shortcode_handler");!0===c&&(r+=";"+o.data("base_shortcode")),m.data("custom_is_item",c),m.data("custom_modal_title",o.data("modal_title")),m.data("custom_modal_subitem_title",o.data("modal_subitem_title")),m.data("custom_element_title",o.data("element_title")),m.data("custom_element_tooltip",o.data("element_tooltip")),m.data("custom_element_shortcode_select",r),a.canvas_elements.html(m),a.builder.updateTextarea(!1,"#aviaALBCustomElements","#aviaALBCleanDataCustomElements"),a.secureContent_elements.data("element_id",l),a.canvas_elements.find(".avia-edit-element").first().trigger("click")},save_element_modal:function(e,t,a,n){var i="";"object"==typeof n&&n.hasOwnProperty("modal")&&n.modal.hasClass("avia-modal-edit-custom-element")&&n.modal.hasClass("avia-base-shortcode")&&(i="#aviaALBCustomElements,#aviaALBCleanDataCustomElements");var o=this.send_to_datastorage(e,t,a,i);return"return"==a||!n.modal.hasClass("avia-modal-edit-custom-element")||n.modal.hasClass("avia-modal-group-shortcode")?o:n.modal.hasClass("element_template_changed")||!0===n.options.template_changed?(n.options.template_changed=!1,o):(n.show_loading_icon(),n.disable_save_button(),this.element_templates.saveSingleElementToDB(n,this,e,o),!1)},close_element_modal:function(e){e.hasClass("avia-base-shortcode")&&e.hasClass("avia-modal-edit-custom-element")&&(e.hasClass("element_template_changed")||this.element_templates.clearEditingArea())},saveSingleElementToDB:function(t,a,n,i){var o=this,s=a,l=o.secureContent_elements.data("element_id"),d=!1,c={action:"avia_alb_element_template_update_content",element_id:l,shortcode:i,params:n,avia_request:!0,_ajax_nonce:e("#avia-loader-nonce").val()};e.ajax({type:"POST",url:ajaxurl,dataType:"json",cache:!1,data:c,success:function(t,a,n){1==t.success?(e("#avia-loader-nonce").val(t._ajax_nonce),s.replace_js_templates(t.js_templates),new e.AviaModalNotification({mode:"success",msg:t.message,autoclose:o.modalAutocloseTime}),d=!0):void 0!==t.expired_nonce&&""!=t.expired_nonce?new e.AviaModalNotification({mode:"error",msg:t.expired_nonce}):void 0!==t.message&&""!=t.message&&new e.AviaModalNotification({mode:"error",msg:t.message})},error:function(t){new e.AviaModalNotification({mode:"error",msg:avia_modal_L10n.connection_error})},complete:function(e){t.hide_loading_icon(),t.enable_save_button(),d&&t.close()}})},deleteSingleElement:function(t){t.stopImmediatePropagation();var a=t.data.objElTemplate,n=e(t.target),i=n.closest(".avia-custom-elements-actions-overlay"),o=n.closest(".shortcode_insert_button "),s=i.find(".avia-sc-button-loading"),l=i.data("template"),d=i.data("el_template"),c=i.data("element_id"),m=e("#avia-tmpl-"+l),r=e("#avia-tmpl-"+d),_=o.data("sort_name");if(!window.confirm(_+": "+avia_modal_L10n.deleteTemplate))return alert(_+": "+avia_modal_L10n.notDeletedTempl),!1;s.addClass("loading");var u=!1,h={action:"avia_alb_element_template_delete",element_id:c,title:_,shortcode:o.data("shortcode_handler"),baseShortcode:o.data("base_shortcode"),isItem:o.data("is_item"),avia_request:!0,_ajax_nonce:e("#avia-loader-nonce").val()};e.ajax({type:"POST",url:ajaxurl,dataType:"json",cache:!1,data:h,success:function(t,n,i){1==t.success?(e("#avia-loader-nonce").val(t._ajax_nonce),o.remove(),m.remove(),r.remove(),u=!0,new e.AviaModalNotification({mode:"success",msg:t.message,autoclose:a.modalAutocloseTime})):void 0!==t.expired_nonce&&""!=t.expired_nonce?new e.AviaModalNotification({mode:"error",msg:t.expired_nonce}):void 0!==t.message&&""!=t.message&&new e.AviaModalNotification({mode:"error",msg:t.message})},error:function(t){new e.AviaModalNotification({mode:"error",msg:avia_modal_L10n.connection_error})},complete:function(e){u||s.removeClass("loading")}})},customActionSingleElement:function(t){var a=e(t.target),n=(a.hasClass("element-sc-action-button")?a:a.closest(".element-sc-action-button")).data("external_link");if(void 0!==n)return t.stopImmediatePropagation(),window.open(n,"_blank","noopener,noreferrer"),!1},cloneSingleElement:function(e){e.stopImmediatePropagation(),alert("Currently not implemented: Clone Element")}},e.AviaModalElementTemplates=function(e){this.instance=this,this.objModal=e,this.templateSelect=[],this.edit_subelements=[],this.show_locked_options=[],this.select=null,this.title_input=null,this.save_btn=null,this.args=null,this.args_action="",this.set_title="",this.last_checked_title="",this.hide_loading_count=0},e.AviaModalElementTemplates.prototype={initTemplateSupport:function(){var e=this;this.objModal.body.on("avia_modal_finished",(function(t){e.bindTemplateSelectBox(),e.bindModalGroupSelectBox(),e.bindLockedOptionsVisibility()}))},bindTemplateSelectBox:function(){var t=this.objModal;if(!(this.templateSelect.length>0)&&(this.templateSelect=t.modal.find('select[data-template_selector="element"]'),this.templateSelect.length>0)){var a=parseInt(this.templateSelect.find("option:selected").val(),10);"number"==typeof a&&a>0?t.modal.addClass("av-element-template-selected").removeClass("av-no-element-template"):t.modal.addClass("av-no-element-template").removeClass("av-element-template-selected"),this.templateSelect.on("change"+t.namespace,(function(a){var n=e(this),i=parseInt(n.find("option:selected").val(),10);if("number"==typeof i&&i<0)return n.find('option[value="'+n.data("initial")+'"]').prop("selected","selected"),alert(avia_modal_L10n.alb_same_element),!1;t.modal.addClass("element_template_changed"),t.modal.find(".avia-modal-save").trigger("click"),null!=t.options.obj_clicked&&("function"==typeof t.options.save_param.addClass&&(t.options.save_param.addClass("element_template_changed"),"number"==typeof i&&i>0?t.options.save_param.addClass("element_template_selected").removeClass("no_element_template"):t.options.save_param.addClass("no_element_template").removeClass("element_template_selected")),t.options.obj_clicked.trigger("click"))}))}},bindModalGroupSelectBox:function(){var t=this.objModal;this.edit_subelements.length>0||(this.edit_subelements=t.modal.find(".av-elements-item-select select"),this.edit_subelements.length>0&&(this.edit_subelements.on("change"+t.namespace,(function(a){"item"==e(this).find("option:selected").val()?t.modal.addClass("avia-edit-item-template").removeClass("avia-edit-base-template"):t.modal.addClass("avia-edit-base-template").removeClass("avia-edit-item-template")})),t.body.hasClass("post-php")&&this.edit_subelements.prop("disabled","disabled"),this.edit_subelements.trigger("change"+t.namespace)))},bindLockedOptionsVisibility:function(){var t=this.objModal;this.show_locked_options.length>0||(this.show_locked_options=t.modal.find("input.avia-element-show-locked-options"),this.show_locked_options.length>0&&(t.modal.find("input.avia-element-show-locked-options").on("change"+t.namespace,(function(a){a.preventDefault(),e(this).prop("checked")?t.modal.addClass("show-locked-input-element"):t.modal.removeClass("show-locked-input-element")})),this.show_locked_options.trigger("change"+t.namespace)))},ManageCPTData:function(){var t=this.objModal,a=e('<div class="av-title-warning-message"></div>');this.args=e.extend({},{action:"new_custom_element"},t.options.args),this.args_action="string"==typeof this.args.action?this.args.action:"new_custom_element",this.select=t.modal.find("select.av_add_new_element_shortcode"),this.title_input=t.modal.find("input.avia-elements-check-title"),this.save_btn=t.modal.find(".avia-modal-create-update-btn"),this.set_title=this.args.title,this.last_checked_title="",this.hide_loading_count=0,this.title_input.after(a),this.select.on("change",{instance:this.instance},this.selected_element_changed),this.title_input.on("keyup change",{instance:this.instance},this.title_changed),this.save_btn.on("click",{instance:this.instance},this.save_element_data),this.select.trigger("change"),this.title_input.trigger("change")},show_loading:function(){this.hide_loading_count++,this.objModal.show_loading_icon(),this.save_button_visibility()},hide_loading:function(e){void 0===e&&(e=!1),this.hide_loading_count--,this.hide_loading_count<0&&this.hide_loading_count,(e||0==this.hide_loading_count)&&this.objModal.hide_loading_icon(),this.save_button_visibility()},save_button_visibility:function(){var e=this.select.find("option:selected").val(),t=this.title_input.val().trim();""==e||t.length<=3?this.objModal.modal.addClass("hide-save-button"):this.objModal.modal.removeClass("hide-save-button"),this.hide_loading_count>0?this.objModal.modal.addClass("disable-save-button"):this.objModal.modal.removeClass("disable-save-button")},selected_element_changed:function(e){e.preventDefault(),e.data.instance.save_button_visibility()},title_changed:function(t){t.preventDefault(),t.stopImmediatePropagation();var a=t.data.instance,n=e(this).val().trim();a.last_checked_title!=n&&(a.last_checked_title=n,a.save_button_visibility(),n.length>3&&a.ajax_check_title(n,a))},save_element_data:function(t){t.preventDefault();var a=t.data.instance,n=a.objModal;if(!n.canSaveModal())return!1;a.select.prop("disabled",!1);var i=n.get_final_values();switch(a.select.prop("disabled",!0),a.args_action){case"new_element_from_alb":break;case"update_element_post_data":i.element_id=a.args.element_id}var o=!1,s={action:"avia_alb_element_template_cpt_actions",subaction:a.args_action,modal_params:i,ajax_param:n.options.ajax_param,avia_request:!0,_ajax_nonce:e("#avia-loader-nonce").val()};a.show_loading(),e.ajax({type:"POST",url:ajaxurl,dataType:"json",cache:!1,data:s,success:function(t,a,i){1==t.success?("function"==typeof n.options.on_save&&n.options.on_save.call(n.options.scope,t),setTimeout((function(){var a=e.avia_builder.element_templates.modalAutocloseTime;new e.AviaModalNotification({mode:"success",msg:t.message,autoclose:a})}),400),o=!0):void 0!==t.expired_nonce&&""!=t.expired_nonce?new e.AviaModalNotification({mode:"error",msg:t.expired_nonce}):void 0!==t.message&&""!=t.message&&new e.AviaModalNotification({mode:"error",msg:t.message})},error:function(t){new e.AviaModalNotification({mode:"error",msg:avia_modal_L10n.connection_error})},complete:function(e){a.hide_loading(!0),o&&n.close()}})},ajax_check_title:function(t,a){var n=a.objModal.modal.find(".av-title-warning-message");if(""!==t&&t!==a.set_title){a.show_loading();var i={action:"avia_alb_element_check_title",title:t,avia_request:!0,_ajax_nonce:e("#avia-loader-nonce").val()};e.ajax({type:"POST",url:ajaxurl,dataType:"json",cache:!1,data:i,success:function(t,a,i){1==t.success&&(e("#avia-loader-nonce").val(t._ajax_nonce),n.html(t.message))},error:function(e){},complete:function(e){a.hide_loading()}})}else n.html("")}}}(jQuery);