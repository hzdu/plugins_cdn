/**
 * This file holds the main javascript functions needed for avia-media uploads
 *
 * @author		Christian "Kriesi" Budschedl
 * @copyright	Copyright ( c ) Christian Budschedl
 * @link		http://kriesi.at
 * @link		http://aviathemes.com
 * @since		Version 1.0
 * @package 	AviaFramework
 */
!function(a){var e={aviaUseCustomEditor:!1,aviaPostID:!1,insertContainer:!1,bind_click:function(){a("body").on("click",".avia_uploader",(function(){var i=this.title,t="";this.title="",e.aviaPostID=this.hash.substring(1),e.aviaUseCustomEditor=!0,e.insertContainer=a(this).parents(".avia_upload_container"),e.insertContainer.is(".avia_advanced_upload")&&(t="&amp;avia_idbased="+a(".avia_upload_input",e.insertContainer).attr("name"));var n=a(this).parents(".avia_upload_container").find(".avia_upload_insert_label").trigger("change").val(),r=a(this).parents(".avia_upload_container").find(".avia_gallery_mode"),l="";return r.length&&(l="&amp;avia_gallery_mode="+r.trigger("change").val()),tb_show(i,"media-upload.php?post_id="+e.aviaPostID+t+l+"&amp;avia_label="+encodeURI(n)+"&amp;TB_iframe=true"),!1}))},bind_remove:function(){a("body").on("click",".avia_remove_image",(function(){var e=a(this).parents(".avia_upload_container");return e.find(".avia_upload_input").val("").trigger("change"),e.find(".avia_preview_pic").hide(400,(function(){a(this).html("").css({display:"block"})})),!1}))},bind_blur:function(){a("body").on("blur change",".avia_upload_input",(function(){var e=a(this),i=e.val(),t='<img src ="'+i+'" alt="" />',n=e.parents(".avia_upload_container").eq(0).find(".avia_preview_pic");""!=i?n.html('<a href="#" class="avia_remove_image">×</a>'+t):n.html("")}))},change_label:function(){e.idBasedUpload();var i=a(".avia_insert_button_label").val();if(""!=i&&"string"==typeof i){var t=a(".savesend");t.length>0&&(a(".button",t).val(i),a(".wp-post-thumbnail",t).css("display","none"))}},hijack_uploader:function(){window.original_send_to_editor=window.send_to_editor,window.send_to_editor=function(i){if(e.aviaUseCustomEditor){var t=e.insertContainer,n=a(i),r=n.attr("src")||n.find("img").attr("src")||n.attr("href"),l="";t.find(".avia_upload_input").val(r).trigger("change"),l=r.match(/.jpg$|.jpeg$|.png$|.gif$/)?'<a href="#" class="avia_remove_image">×</a><img src="'+r+'" alt="" />':'<a href="#" class="avia_remove_image">×</a><img src="'+avia_framework_globals.frameworkUrl+'images/icons/video.png" alt="" />',t.find(".avia_preview_pic").html(l),tb_remove(),e.reset_uploader()}else window.original_send_to_editor(i)}},idBasedUpload:function(){var i=a(".avia_idbased");if(i.length>0){i=i.val();var t=a(".savesend"),n=a(".button",t).not(".del-attachment .button"),r=a("input[name="+i+"]",parent.document),l=r.parents(".avia_advanced_upload").eq(0).find(".avia_preview_pic"),o=a("#filter"),d=a(".avia_insert_button_label"),s=a(".avia_gallery_mode_active"),_=a("#gallery-form, #file-form");if(_.length){var v,p=_.find("input[name=_wp_http_referer]").val(),u=_.attr("action");p=p.replace(/.+media-upload\.php?/,""),v=(u=u.replace(/media-upload\.php?.+/,""))+"media-upload.php"+p,_.attr("action",v)}if(s.length){if(s=!0,a("#avia_update_gallery").length)m=a("#avia_update_gallery");else{var c=a("#save-all, #save").not(".hidden"),m=(a("#save"),a('<input type="submit" name="avia_update_gallery" id="avia_update_gallery" class="button savebutton" value="...then close the window and update gallery preview" />'));m.insertAfter(c)}a(".savesend .button").not(".del-attachment .button").remove(),n=a(".savesend .button, #insert-gallery, #avia_update_gallery").not(".del-attachment .button").attr("onmousedown",""),a("#gallery-settings").css({display:"none"})}else s=!1;if(o.length){var g=o.find("input[name=avia_idbased]"),h=o.find("input[name=avia_label]"),f=o.find("input[name=avia_gallery_mode]");g.length||o.prepend("<input type='hidden' name='avia_idbased' value='"+i+"'/>"),d.length&&!h.length&&o.prepend("<input type='hidden' name='avia_label' value='"+d.val()+"'/>"),s&&!f.length&&o.prepend("<input type='hidden' name='avia_gallery_mode' value='true'/>")}s?n.off("click").on("click",(function(){var i=post_id,t=r.parents(".avia_control").eq(0).find(".avia_thumbnail_container");return a.ajax({type:"POST",url:window.ajaxurl,data:"action=avia_ajax_get_gallery&attachment_id="+i,success:function(a){t.html(a),parent.tb_remove(),e.reset_uploader()}}),!1})):n.off("click").on("click",(function(){var i=this.name.replace(/send\[/,"").replace(/\]/,"");return a.ajax({type:"POST",url:window.ajaxurl,data:"action=avia_ajax_get_image&attachment_id="+i,success:function(a){(a=a.trim()).match(/^<img/)?(r.val(i),l.html('<a href="#" class="avia_remove_image">×</a>'+a)):(r.val(a),visualInsert='<a href="#" class="avia_remove_image">×</a><img src="'+avia_framework_globals.frameworkUrl+'images/icons/video.png" alt="" />',l.html(visualInsert)),parent.tb_remove(),e.reset_uploader()}}),!1}))}},reset_uploader:function(){e.aviaUseCustomEditor=!1,e.aviaPostID=!1,e.insertContainer=!1}};a((function(){a("#media-buttons a").on("click",e.reset_uploader),e.bind_click(),e.bind_blur(),e.bind_remove(),e.idBasedUpload(),e.hijack_uploader(),e.change_label(),a("body").on("mouseenter",".slidetoggle",e.change_label)}))}(jQuery);