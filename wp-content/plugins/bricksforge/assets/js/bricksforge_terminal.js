BRFTERMINAL=BRFTERMINAL||{};class BricksforgeTerminal{command="";history=[];bricksElements=[];bricksGlobalClasses=[];currentCommandIndex=0;currentStructureList=[];newCreatedElement=null;pendingElements=[];activeNode=null;parentActiveNode=null;parentSelected=!1;isEmptyStructure=!1;isStartingWithPlus=!1;isNoActiveElement=!1;scope="default";receivedData=!1;customCommands=[];successDuration=1e3;bricksVueRoot=null;bricksVueActiveElement=null;bricksVueContent=null;bricksVueGlobalClasses=[];bricksNewCreatedElements=[];openTerminal=null;setScope=null;initTerminal=null;finish=null;success=null;constructor(){this.init()}init(){this.prepare(),this.placeIcon(),this.getBricksElements(),this.getBricksGlobalClasses(),this.getVueData(),this.getHistory(),this.handleShortcuts(),this.listeners(),this.handleFunctions()}handleFunctions(){this.openTerminal=this.runOpenTerminal.bind(this),this.setScope=this.runSetScope.bind(this),this.initTerminal=this.runInitTerminal.bind(this),this.finish=this.runFinish.bind(this),this.success=this.runSuccess.bind(this)}runSetScope(e){if(e)if(this.scope=e,"basic"===this.scope)this.blockAutoComplete();else this.unblockAutoComplete()}async runOpenTerminal(e={placeholder:"Bricksforge Terminal"},t){let s=document.querySelector("#bricksforge-terminal"),i=document.querySelector("#bricksforge-terminal-input");return e.placeholder&&(i.placeholder=e.placeholder),"none"==s.style.display?(s.style.display="flex",i.focus()):s.style.display="none",new Promise(((e,t)=>{let s=0,i=setInterval((()=>{if(s++,!1!==this.receivedData)return clearInterval(i),e(this.receivedData),this.receivedData;s>9e3&&(clearInterval(i),this.receivedData=!1)}),100)}))}runInitTerminal(){document.body.classList.add("brf-terminal-running")}runFinish(e={newCommand:null}){this.receivedData=!1,this.scope="default",this.unblockAutoComplete(),document.querySelector("#bricksforge-terminal-input").placeholder="",e.newCommand&&(this.customCommands.some((t=>t.shortcut===e.newCommand.shortcut))||this.customCommands.push(e.newCommand)),setTimeout((()=>{document.body.classList.remove("brf-terminal-running"),document.body.classList.remove("brf-executing")}),5e3)}runSuccess(e="Success! 🙏"){document.querySelector("#bricksforge-terminal").classList.add("success"),document.querySelector("#bricksforge-terminal-input").value=e,setTimeout((()=>{document.querySelector("#bricksforge-terminal").classList.remove("success"),document.querySelector("#bricksforge-terminal-input").value=""}),this.successDuration)}blockAutoComplete(){document.querySelector("#bricksforge-terminal-autocomplete").classList.add("blocked")}unblockAutoComplete(){document.querySelector("#bricksforge-terminal-autocomplete").classList.remove("blocked")}async prepare(){let e=document.createElement("div");e.id="bricksforge-terminal";let t=document.createElement("input");t.id="bricksforge-terminal-input";let s=document.createElement("div");s.id="bricksforge-terminal-input-wrapper",s.appendChild(t),this.createAutoCompleteElements(s),e.appendChild(s),e.style.display="none",document.body.appendChild(e),document.addEventListener("keydown",(s=>{s.ctrlKey&&"t"===s.key&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none"),s.ctrlKey&&s.altKey&&("T"===s.key||"t"===s.key)&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none")})),setTimeout((()=>{document.querySelector("#bricks-builder-iframe").contentWindow.document.addEventListener("keydown",(s=>{s.ctrlKey&&"t"===s.key&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none"),s.ctrlKey&&s.altKey&&("T"===s.key||"t"===s.key)&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none")}))}),750),document.addEventListener("keydown",(t=>{"flex"==e.style.display&&"Escape"===t.key&&(e.style.display="none")})),e.addEventListener("keydown",(async s=>{"flex"==e.style.display&&"Enter"===s.key&&(this.command=t.value,await this.execute(this.command),"default"==this.scope?(t.value="",e.style.display="none",this.runFinish()):"basic"==this.scope&&setTimeout((()=>{e.style.display="none"}),this.successDuration))})),BRFTERMINAL.commands&&BRFTERMINAL.commands.length>0&&(this.customCommands=BRFTERMINAL.commands),e.addEventListener("keyup",(async e=>{if("ArrowDown"===e.key||"ArrowUp"===e.key||"Enter"===e.key)return;const s=e.target.value;(s.includes(">")||s.includes("+")||s.includes(".")||t)&&this.handleAutocomplete.call(this,s)}))}handleAutocomplete(e){const t=e.startsWith(">*"),s=e.split(/[>+~\s]/),i=s[s.length-1].trim();if(/(?<![>+~\s])\./.test(i)){const e=i.split("."),t=e[e.length-1].trim();this.autoComplete({completionFor:"globalClasses",value:t})}else t?this.autoComplete({completionFor:"customCommands",value:i.replace(">*","")}):this.autoComplete({completionFor:"elements",value:i})}placeIcon(){let e=document.querySelector("#bricks-toolbar ul.group-wrapper.left"),t=document.createElement("li");t.classList.add("brf-terminal"),t.setAttribute("data-balloon","Bricksforge Terminal (Shortcut: CTRL + T)"),t.setAttribute("data-balloon-pos","bottom");let s=document.createElement("span");s.classList.add("bricks-svg-wrapper"),t.appendChild(s),e&&e.appendChild(t);let i=document.querySelector("#bricksforge-terminal"),n=document.querySelector("#bricksforge-terminal-input");document.querySelector("#bricks-toolbar .brf-terminal").addEventListener("click",(e=>{"none"==i.style.display?(i.style.display="flex",n.focus()):i.style.display="none"}))}getBricksElements(){if(bricksData)for(let e in bricksData.elements)this.bricksElements.push(e)}getBricksGlobalClasses(){if(bricksData&&bricksData.loadData.globalClasses&&0!=bricksData.loadData.globalClasses.length)for(let e of bricksData.loadData.globalClasses)this.bricksGlobalClasses.push(e.name)}async getVueData(){this.bricksVueRoot=document.querySelector(".brx-body").__vue_app__.config.globalProperties,this.bricksVueState=this.bricksVueRoot.$_state,this.bricksVueContent=this.bricksVueState.content,this.bricksVueActiveElement=this.bricksVueState.activeElement,this.bricksVueGlobalClasses=this.bricksVueState.globalClasses}createAutoCompleteElements(e){let t=document.createElement("div");t.id="bricksforge-terminal-autocomplete";let s=document.createElement("div");s.classList.add("bricksforge-terminal-autocomplete-list"),t.appendChild(s),e.appendChild(t)}handleShortcuts(){this.navigateHistory()}async autoComplete({completionFor:e,value:t}){let s,i=document.querySelector(".bricksforge-terminal-autocomplete-list");if(i.innerHTML="",!t||0===t.length||" "===t||""===t)return void this.closeAutoCompletion();let n=document.querySelector("#bricksforge-terminal-input");switch(e){case"elements":s=this.bricksElements;break;case"globalClasses":s=this.bricksGlobalClasses;break;case"customCommands":s=this.customCommands.map((e=>`>*${e.shortcut}`))}if(s&&s.length>0){s.forEach((s=>{if("customCommands"==e&&s.includes(">*")&&(s=s.replace(">*","").trim()),"globalClasses"==e&&t.includes(".")&&(t=t.split(".")[1]),s.startsWith(t)){this.openAutoCompletion();let l=document.createElement("div");l.classList.add("bricksforge-terminal-autocomplete-item"),l.innerHTML=s,i.appendChild(l),l.addEventListener("click",(s=>{let i=n.value.split(" ").reverse(),l=-1;for(let e=0;e<i.length;e++)if(i[e].startsWith(t)||i[e].split(".")[i[e].split(".").length-1].startsWith(t)){l=e;break}l>-1&&("elements"==e?i[l]=s.target.innerHTML:"globalClasses"==e?i[l]=i[l].split(".").slice(0,-1).join(".")+"."+s.target.innerHTML:"customCommands"==e&&(i[l]=`${s.target.innerHTML}`)),n.value=i.reverse().join(" "),n.focus(),this.closeAutoCompletion()}))}}));let l=-1;document.querySelector("#bricksforge-terminal-input").addEventListener("keydown",(e=>{if("ArrowDown"===e.key){let e=document.querySelectorAll(".bricksforge-terminal-autocomplete-item");e.length>0&&(l++,l>=e.length&&(l=0),e.forEach(((e,t)=>{t!==l&&e.classList.remove("selected")})),e[l].classList.add("selected"),e[l].scrollIntoView({block:"center",behavior:"smooth",inline:"nearest",offsetTop:50}))}if("ArrowUp"===e.key){let e=document.querySelectorAll(".bricksforge-terminal-autocomplete-item");e.length>0&&(l--,l<0&&(l=e.length-1),e.forEach(((e,t)=>{t!==l&&e.classList.remove("selected")})),e[l].classList.add("selected"),e[l].focus(),e[l].scrollIntoView({block:"center",behavior:"smooth",inline:"nearest",offsetTop:50}))}}))}}autoCompletionListIsEmpty(){return document.querySelector(".bricksforge-terminal-autocomplete-item")}openAutoCompletion(){let e=document.querySelector("#bricksforge-terminal-autocomplete");e&&(e.style.display="block")}closeAutoCompletion(){let e=document.querySelector("#bricksforge-terminal-autocomplete");e&&(e.style.display="none")}navigateHistory(){this.historyIndex=this.history.length;let e=document.querySelector("#bricksforge-terminal-input");this.currentCommandIndex,e.addEventListener("keydown",(t=>{if(!document.querySelector("#bricksforge-terminal-autocomplete")||"none"==document.querySelector("#bricksforge-terminal-autocomplete").style.display)if("ArrowUp"===t.key){t.preventDefault(),this.historyIndex>0&&this.historyIndex--;let s=this.history[this.historyIndex];this.command=s,this.command&&(e.value=this.command)}else if("ArrowDown"==t.key){t.preventDefault(),this.historyIndex<this.history.length&&this.historyIndex++,this.historyIndex==this.history.length&&(this.command="",e.value=this.command);let s=this.history[this.historyIndex];this.command=s,this.command&&(e.value=this.command)}}))}async execute(e){return document.body.classList.add("brf-executing"),"basic"==this.scope?new Promise((async(t,s)=>{this.receivedData=e,t()})):new Promise((async(t,s)=>{let i;switch(e.startsWith(".")?i="addClasses":e.startsWith(">")&&(i="addElements"),this.addHistory(e),i){case"addClasses":await this.addClasses(e);break;case"addElements":await this.addElements(e),this.pendingElements=[],this.isEmptyStructure=!1,this.isStartingWithPlus=!1;break;default:console.warn("Unknown Terminal Method")}t()}))}async addClasses(e){return new Promise((async(t,s)=>{try{let s=e.split(".");s=s.filter((e=>e));for(let e=0;e<s.length;e++)s[e]=s[e].replace(/\s+/,""),this.addClass(s[e]),t()}catch(e){s()}}))}addClass(e){if(this.getVueData(),!this.bricksVueActiveElement)return void console.warn("Bricksforge Terminal: There is no active element. No class was added.");let t=this.createGlobalClassIfNotExists(e);this.bricksVueActiveElement.settings._cssGlobalClasses||(this.bricksVueActiveElement.settings._cssGlobalClasses=[]),this.bricksVueActiveElement.settings._cssGlobalClasses.push(t)}createGlobalClassIfNotExists(e){this.getVueData();let t=this.bricksVueRoot.$_generateId();return this.bricksVueGlobalClasses.find((t=>t.name==e))?t=this.bricksVueGlobalClasses.find((t=>t.name==e)).id:this.bricksVueGlobalClasses.push({name:e,id:t,settings:[]}),this.getVueData(),t}async checkForCustomCommands(e){let t=!1;if(e.includes(">*")&&(t=!0),!t)return!1;let s=e.split(">*")[1];return s=s.replace(/\s+/g,""),this.customCommands.forEach((async e=>{e.shortcut==s&&(await navigator.clipboard.writeText(e.data),this.bricksVueRoot.$_pasteElements(e.data))})),!0}async addElements(e){this.addElement(e)}async addElement(e){this.getVueData();if(await this.checkForCustomCommands(e))return;this.bricksNewCreatedElements=[];const t=this.bricksVueState.content,s=e=>{const[t,s]=e.split("*"),i=parseInt(s,10)||1;return Array.from({length:i},(()=>{const e=t.split(">").map((e=>o(e.trim())));return{name:e[0].name,settings:e[0].settings,children:e.slice(1)}}))},i=(e,t=0,l=[null])=>{if(t>=e.length)return;const r=e[t],o=s(r);let a=null;if(l.forEach((e=>{e&&o.forEach((t=>{a?r.includes(">")?(a.children.push(t),a=t):(e.children||(e.children=[]),e.children.push(t),a=t):(a=t,e.children||(e.children=[]),e.children.push(a))}))})),e[t]&&e[t].includes("+")){const s=e[t].split("+").map((e=>e.trim())).filter((e=>""!==e));n(s.join("+"),o),i(e,t+1,o)}if(e[t+1]&&e[t+1].includes("+")){const s=e[t+1].split("+").map((e=>e.trim())).filter((e=>""!==e));n(s.join("+"),o),i(e,t+2,o)}else i(e,t+1,o);return o[0]},n=(e,t)=>{const i=e.split("+").map((e=>e.trim())).filter((e=>""!==e)).flatMap((e=>s(e)));t.forEach((e=>{e&&i.forEach((t=>{e.children||(e.children=[]),e.children.push(t)}))}))},l=e=>{e.forEach((e=>{let t=[];if(e.includes(".")){let s=e.split(".");s.shift(),s.forEach((e=>{t.push(this.createGlobalClassIfNotExists(e))})),e=e.split(".")[0]}const s={id:this.bricksVueRoot.$_generateId(),name:e,parent:null,children:[],settings:{_cssGlobalClasses:t}};this.bricksVueContent.push(s)}))},r=e=>{const t=/\[(.*?)\]/g;let s,i=[];for(;null!==(s=t.exec(e));){const e=s[1].split(";").map((e=>{const[t,s]=e.split("=");return{id:this.bricksVueRoot.$_generateId(),name:t.trim(),value:s.trim()}}));i=[...i,...e]}return{elementStr:e=e.replace(t,"").trim(),attrs:i}},o=e=>{const{elementStr:t,attrs:s}=r(e);let[i,...n]=t.split(/([.#])/),l=null,o=[];for(let e=0;e<n.length;e+=2)"#"===n[e]?l=n[e+1]:"."===n[e]&&o.push(this.createGlobalClassIfNotExists(n[e+1]));return{name:i.trim(),settings:{_cssId:l,_cssGlobalClasses:o,_attributes:s},children:[]}},a=(e,t)=>{const s=this.bricksVueRoot.$_generateId(),i=e.children.map((e=>a(e,s)));let n=this.bricksVueContent.find((e=>e.id===t));var l;n&&"section"!==(l=n.name)&&"div"!==l&&"block"!==l&&"container"!==l&&(t=n.parent);const r={id:s,name:e.name,parent:t,children:i,settings:{...e.settings._cssGlobalClasses.length>0&&{_cssGlobalClasses:e.settings._cssGlobalClasses},...e.settings._attributes.length>0&&{_attributes:e.settings._attributes},...e.settings._cssId&&{_cssId:e.settings._cssId}}};if(d.push(r),0!=t){const e=this.bricksVueContent.findIndex((e=>e.id===t));this.bricksVueContent[e]&&this.bricksVueContent[e].children.push(s)}return s},c=e.split(">").map((e=>e.trim())).filter((e=>""!==e));if(c[0].includes("+")){return void l(c[0].split("+").map((e=>e.trim())).filter((e=>""!==e)))}const u=i(c,0,[null]);let d=[];if(c[0].includes("*")){const[e,t]=c[0].split("*"),s=o(e);for(let e=0;e<t-1;e++)a(s,this.bricksVueActiveElement?this.bricksVueActiveElement.id:0)}a(u,this.bricksVueActiveElement?this.bricksVueActiveElement.id:0),d=d.map((e=>("heading"==e.name&&(e.settings.text="I am a heading"),"text"!=e.name&&"text-basic"!=e.name||(e.settings.text="Here goes your text ... Select any part of your text to access the formatting toolbar."),e))),this.bricksVueContent.push(...d);const m=this.bricksVueState.content;this.bricksNewCreatedElements=this.findNewCreatedElements(t,m)}findNewCreatedElements(e,t){const s=t.filter((t=>!e.includes(t)));return s[s.length-1]}getHistory(){BRFTERMINAL.history&&"object"==typeof BRFTERMINAL.history&&BRFTERMINAL.history.length&&(this.history=BRFTERMINAL.history,this.historyIndex=this.history.length)}async addHistory(e){if(!e||0==e.trim().length)return;if(!this.history||"object"!=typeof this.history)return;this.history.push(e),this.history.length>50&&this.history.shift();await fetch(BRFTERMINAL.apiurl+"save_option",{method:"POST",headers:{"X-WP-Nonce":BRFTERMINAL.nonce,"Content-Type":"application/json"},body:JSON.stringify(["brf_terminal_history",this.history])});this.historyIndex=this.history.length}listeners(){document.querySelector("#bricksforge-terminal-input").addEventListener("keydown",(e=>{"none"!=document.querySelector("#bricksforge-terminal-autocomplete").style.display&&document.querySelector(".bricksforge-terminal-autocomplete-item.selected")&&"Enter"===e.key&&(e.stopPropagation(),e.preventDefault(),document.querySelector(".bricksforge-terminal-autocomplete-item.selected").click())}))}wait(e=10){return new Promise((t=>{setTimeout(t,e)}))}}document.addEventListener("DOMContentLoaded",(function(){BRFTERMINAL={...BRFTERMINAL,...new BricksforgeTerminal}}));