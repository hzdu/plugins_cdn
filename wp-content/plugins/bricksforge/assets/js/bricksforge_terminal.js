class BricksforgeTerminal{command="";history=[];bricksElements=[];bricksGlobalClasses=[];currentCommandIndex=0;currentStructureList=[];newCreatedElement=null;pendingElements=[];activeNode=null;parentActiveNode=null;parentSelected=!1;isEmptyStructure=!1;isStartingWithPlus=!1;isNoActiveElement=!1;constructor(){this.init()}init(){this.prepare(),this.placeIcon(),this.getBricksElements(),this.getBricksGlobalClasses(),this.getHistory(),this.handleShortcuts(),this.listeners()}async prepare(){let e=document.createElement("div");e.id="bricksforge-terminal";let t=document.createElement("input");t.id="bricksforge-terminal-input";let s=document.createElement("div");s.id="bricksforge-terminal-input-wrapper",s.appendChild(t),this.createAutoCompleteElements(s),e.appendChild(s),e.style.display="none",document.body.appendChild(e),document.addEventListener("keydown",(s=>{s.ctrlKey&&"t"===s.key&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none"),s.ctrlKey&&s.shiftKey&&("T"===s.key||"t"===s.key)&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none")})),document.addEventListener("keydown",(t=>{"flex"==e.style.display&&"Escape"===t.key&&(e.style.display="none")})),e.addEventListener("keydown",(async s=>{"flex"==e.style.display&&"Enter"===s.key&&(this.command=t.value,t.value="",await this.execute(this.command),e.style.display="none",document.body.classList.remove("brf-executing"))})),e.addEventListener("keyup",(async e=>{if("ArrowDown"!==e.key&&"ArrowUp"!==e.key&&"Enter"!==e.key){var s=e.target.value;if(-1!==s.indexOf("> ")&&"."!==s.charAt(s.indexOf("> ")-1)||t)if(-1===(i=(n=s.split("> "))[n.length-1].trim()).indexOf("."))this.autoComplete({completionFor:"elements",value:i});else{var i=(n=i.split("."))[n.length-1].trim();this.autoComplete({completionFor:"globalClasses",value:i})}if(-1!==s.indexOf(".")&&-1==s.indexOf(">")){var n;i=(n=s.split("."))[n.length-1].trim();this.autoComplete({completionFor:"globalClasses",value:i})}}}))}placeIcon(){let e=document.querySelector("#bricks-toolbar ul.group-wrapper.left"),t=document.createElement("li");t.classList.add("brf-terminal"),t.setAttribute("data-balloon","Bricksforge Terminal (Shortcut: CTRL + T)"),t.setAttribute("data-balloon-pos","bottom");let s=document.createElement("span");s.classList.add("bricks-svg-wrapper"),t.appendChild(s),e&&e.appendChild(t);let i=document.querySelector("#bricksforge-terminal"),n=document.querySelector("#bricksforge-terminal-input");document.querySelector("#bricks-toolbar .brf-terminal").addEventListener("click",(e=>{"none"==i.style.display?(i.style.display="flex",n.focus()):i.style.display="none"}))}getBricksElements(){if(bricksData)for(let e in bricksData.elements)this.bricksElements.push(e)}getBricksGlobalClasses(){if(bricksData)for(let e of bricksData.loadData.globalClasses)this.bricksGlobalClasses.push(e.name)}createAutoCompleteElements(e){let t=document.createElement("div");t.id="bricksforge-terminal-autocomplete";let s=document.createElement("div");s.classList.add("bricksforge-terminal-autocomplete-list"),t.appendChild(s),e.appendChild(t)}handleShortcuts(){this.navigateHistory()}async autoComplete({completionFor:e,value:t}){this.openAutoCompletion();let s,i=document.querySelector(".bricksforge-terminal-autocomplete-list");if(i.innerHTML="",!t||0===t.length||" "===t||""===t)return void this.closeAutoCompletion();let n=document.querySelector("#bricksforge-terminal-input");switch(e){case"elements":s=this.bricksElements;break;case"globalClasses":s=this.bricksGlobalClasses}if(s&&s.length>0){s.forEach((s=>{if("globalClasses"==e&&t.includes(".")&&(t=t.split(".")[1]),s.startsWith(t)){let l=document.createElement("div");l.classList.add("bricksforge-terminal-autocomplete-item"),l.innerHTML=s,i.appendChild(l),l.addEventListener("click",(s=>{let i=n.value.split(" ").reverse(),l=-1;for(let e=0;e<i.length;e++)if(i[e].startsWith(t)||i[e].split(".")[i[e].split(".").length-1].startsWith(t)){l=e;break}l>-1&&("elements"==e?i[l]=s.target.innerHTML:"globalClasses"==e&&(i[l]=i[l].split(".").slice(0,-1).join(".")+"."+s.target.innerHTML)),n.value=i.reverse().join(" "),n.focus(),this.closeAutoCompletion()}))}}));let l=-1;document.querySelector("#bricksforge-terminal-input").addEventListener("keydown",(e=>{if("ArrowDown"===e.key){let e=document.querySelectorAll(".bricksforge-terminal-autocomplete-item");e.length>0&&(l++,l>=e.length&&(l=0),e.forEach(((e,t)=>{t!==l&&e.classList.remove("selected")})),e[l].classList.add("selected"),e[l].scrollIntoView({block:"center",behavior:"smooth",inline:"nearest",offsetTop:50}))}if("ArrowUp"===e.key){let e=document.querySelectorAll(".bricksforge-terminal-autocomplete-item");e.length>0&&(l--,l<0&&(l=e.length-1),e.forEach(((e,t)=>{t!==l&&e.classList.remove("selected")})),e[l].classList.add("selected"),e[l].focus(),e[l].scrollIntoView({block:"center",behavior:"smooth",inline:"nearest",offsetTop:50}))}}))}}autoCompletionListIsEmpty(){return document.querySelector(".bricksforge-terminal-autocomplete-item")}openAutoCompletion(){let e=document.querySelector("#bricksforge-terminal-autocomplete");e&&(e.style.display="block")}closeAutoCompletion(){let e=document.querySelector("#bricksforge-terminal-autocomplete");e&&(e.style.display="none")}navigateHistory(){this.historyIndex=this.history.length;let e=document.querySelector("#bricksforge-terminal-input");this.currentCommandIndex,e.addEventListener("keydown",(t=>{if(!document.querySelector("#bricksforge-terminal-autocomplete")||"none"==document.querySelector("#bricksforge-terminal-autocomplete").style.display)if("ArrowUp"===t.key){t.preventDefault(),this.historyIndex>0&&this.historyIndex--;let s=this.history[this.historyIndex];this.command=s,this.command&&(e.value=this.command)}else if("ArrowDown"==t.key){t.preventDefault(),this.historyIndex<this.history.length&&this.historyIndex++,this.historyIndex==this.history.length&&(this.command="",e.value=this.command);let s=this.history[this.historyIndex];this.command=s,this.command&&(e.value=this.command)}}))}async execute(e){return document.body.classList.add("brf-executing"),new Promise((async(t,s)=>{let i;switch(e.startsWith(".")?i="addClasses":e.startsWith(">")&&(i="addElements"),this.addHistory(e),i){case"addClasses":await this.addClasses(e);break;case"addElements":await this.addElements(e),this.pendingElements=[],this.isEmptyStructure=!1,this.isStartingWithPlus=!1;break;default:console.warn("Unknown Terminal Method")}t()}))}async addClasses(e){return new Promise((async(t,s)=>{try{let s=e.split(".");s=s.filter((e=>e));for(let e=0;e<s.length;e++)s[e]=s[e].replace(/\s+/,""),await this.addClass(s[e]),t()}catch(e){console.log(e),s()}}))}async addClass(e){return new Promise((async(t,s)=>{for(;;){if(document.querySelector("#bricks-panel-element-classes .active-class input"))break;await new Promise((e=>setTimeout(e,0)))}for(document.querySelector("#bricks-panel-element-classes .active-class input").dispatchEvent(new Event("click",{bubbles:!0})),await this.wait();;){if(document.querySelector("#bricks-panel-element-classes .bricks-control-popup input"))break;await new Promise((e=>setTimeout(e,0)))}let i=document.querySelector("#bricks-panel-element-classes .bricks-control-popup input");for(i.value=e,i.dispatchEvent(new Event("input",{bubbles:!0}));;){if(document.querySelector("#bricks-panel-element-classes span.create"))break;await new Promise((e=>setTimeout(e,0)))}document.querySelector("#bricks-panel-element-classes span.create").dispatchEvent(new Event("click",{bubbles:!0})),this.wait(),t()}))}async addElements(e){try{let t=e.split(">");t=t.filter((e=>e)),t=t.map((e=>e.replace(/\s+/,""))),!t[0].includes("+")&&!t[0].includes("*")||this.getActiveNode()||t.unshift("wrapper");for(let e=0;e<t.length;e++)t[e]=t[e].replace(" ",""),await this.addElement({element:t[e],index:e,elementsArray:t})}catch(e){console.log(e)}}async addElement({element:e,elementsArray:t,index:s}){let i=!1;"wrapper"==e&&(e="div",i=!0),this.currentStructureList=this.getCurrentStructureList(),this.isEmptyStructure=0==this.currentStructureList.length,this.activeNode=this.getActiveNode(),e.includes("+")&&(0==s&&this.pendingElements.push({elements:null,currentIndex:s,nextIndex:null,node:this.activeNode}),this.parentActiveNode=this.activeNode?this.activeNode:"empty",!this.isEmptyStructure&&this.getActiveNode()||(this.isStartingWithPlus=!0),e=await this.handleNextElements({element:e,elementsArray:t,index:s})),e.includes("*")&&(this.parentActiveNode=this.activeNode?this.activeNode:"empty");let n=!1,l=e;if(e.includes(".")&&(n=!0),n&&(e=e.split(".")[0]),await this.createElement(e,l),i&&await this.modifyWrapper(),this.parentActiveNode&&this.pendingElements.length,this.newCreatedElement=await this.getNewCreatedElement(),!this.newCreatedElement||this.isStartingWithPlus||this.parentActiveNode||("section"==e?await this.selectElement(this.newCreatedElement[0].querySelector("ul li")):await this.selectElement(this.newCreatedElement[0]),this.parentSelected=!1),t[s+1]&&t[s+1].includes("+")&&this.pendingElements.push({elements:null,currentIndex:s,nextIndex:null,node:this.newCreatedElement[0]}),this.pendingElements)for(let e of this.pendingElements)if(e){if(e.elements)for(let[t,s]of e.elements.entries()){this.currentStructureList=this.getCurrentStructureList();let i=!1,n=s;if(s.includes(".")&&(i=!0),i&&(s=n.split(".")[0]),await this.createElement(s,n),this.newCreatedElement=await this.getNewCreatedElement(),t==e.elements.length-1&&await this.selectElement(this.newCreatedElement[0]),i){this.getActiveNode()}this.pendingElements=this.pendingElements.filter((t=>t!=e))}}else if(e.elements)for(let t of e.elements)await this.createElement(t,l);this.parentSelected=!1}async modifyWrapper(){return new Promise((async e=>{let t=(await this.getNewCreatedElement())[0].querySelector("input");t.removeAttribute("readonly");let s=new MouseEvent("dblclick",{view:window,bubbles:!0,cancelable:!0});t.dispatchEvent(s),t.value="Wrapper";let i=new InputEvent("input",{bubbles:!0});t.dispatchEvent(i);let n=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,view:window,bubbles:!0,cancelable:!0});t.dispatchEvent(n),e()}))}getCurrentStructureList(){return document.querySelectorAll(".bricks-structure-list li")}async getNewCreatedElement(){return new Promise((e=>{e([...this.getCurrentStructureList()].filter((e=>![...this.currentStructureList].includes(e))))}))}getActiveNode(){let e=document.querySelector(".bricks-structure-list li.active");return this.isNoActiveElement=!e,e}async removeSelection(){return new Promise((async e=>{document.querySelectorAll(".bricks-structure-list li").forEach((e=>{e.classList.remove("active")})),this.selectElement(document.querySelector("#bricks-builder-iframe")),e()}))}async handleElementClasses({element:e,node:t}){return new Promise((async t=>{let s=e.split(".");s=s.map((e=>e.replace(/\s+/,"")));s[0];let i=s.slice(1);i=i.map((e=>e.replace(".","")));for(let e of i)e.includes("*")&&(e=e.split("*")[0]),await this.addClass(e);t()}))}async handleNextElements({element:e,elementsArray:t,index:s}){return new Promise((async i=>{let n=e.split("+");n=n.map((e=>e.replace(/\s+/,"")));let l=t.findIndex((t=>t.includes("+")&&t!==e)),r=this.pendingElements.find((e=>0==s?0==e.currentIndex:e.currentIndex==s-1));r&&(r.elements=n.slice(1),r.nextIndex=l),i(n[0])}))}async selectElement(e){e.querySelector(".bricks-draggable-handle").dispatchEvent(new MouseEvent("click",{bubbles:!0}))}async createElement(e,t){let s=t.split(".").slice(1).map((e=>"."+e.replace(/\s+/,""))).join("");s.includes("*")&&(s=s.split("*")[0]),e=e.replace(/\s+/,""),await new Promise((async i=>{document.querySelector("#bricks-toolbar li.elements").dispatchEvent(new Event("click",{bubbles:!0})),await this.wait();let n=document.querySelector(`#bricks-panel-elements-categories [data-element-name="${e}"] .element-icon`);if(t.includes("*")){let e=t.split("*"),i=parseInt(e[1]),l=e[0];l.includes(".")&&(l=l.split(".")[0]),n=document.querySelector(`#bricks-panel-elements-categories [data-element-name="${l}"] .element-icon`);for(let e=0;e<i;e++)if(this.currentStructureList=this.getCurrentStructureList(),n.dispatchEvent(new Event("click",{bubbles:!0})),await this.wait(50),s.length){let e=await this.getNewCreatedElement();await this.selectElement(e[0]),await this.handleElementClasses({element:s,node:e[0]}),this.parentActiveNode&&"string"!=typeof this.parentActiveNode&&(await this.selectElement(this.parentActiveNode),this.parentSelected=!0)}}else if(n&&(this.currentStructureList=this.getCurrentStructureList(),n.dispatchEvent(new Event("click",{bubbles:!0}))),await this.wait(50),s.length){let e=await this.getNewCreatedElement();await this.selectElement(e[0]),await this.handleElementClasses({element:s,node:n}),this.parentActiveNode&&"string"!=typeof this.parentActiveNode&&(await this.selectElement(this.parentActiveNode),this.parentSelected=!0)}i()}))}getHistory(){BRFTERMINAL.history&&"object"==typeof BRFTERMINAL.history&&BRFTERMINAL.history.length&&(this.history=BRFTERMINAL.history,this.historyIndex=this.history.length)}async addHistory(e){if(!e||0==e.trim().length)return;if(!this.history||"object"!=typeof this.history)return;this.history.push(e),this.history.length>50&&this.history.shift();await fetch(BRFTERMINAL.apiurl+"save_option",{method:"POST",headers:{"X-WP-Nonce":BRFTERMINAL.nonce,"Content-Type":"application/json"},body:JSON.stringify(["brf_terminal_history",this.history])});this.historyIndex=this.history.length}listeners(){document.querySelector("#bricksforge-terminal-input").addEventListener("keydown",(e=>{"none"!=document.querySelector("#bricksforge-terminal-autocomplete").style.display&&document.querySelector(".bricksforge-terminal-autocomplete-item.selected")&&"Enter"===e.key&&(e.stopPropagation(),e.preventDefault(),document.querySelector(".bricksforge-terminal-autocomplete-item.selected").click())}))}wait(e=10){return new Promise((t=>{setTimeout(t,e)}))}}document.addEventListener("DOMContentLoaded",(function(){new BricksforgeTerminal}));