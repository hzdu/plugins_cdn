class BricksforgeTerminal{command="";history=[];bricksElements=[];bricksGlobalClasses=[];currentCommandIndex=0;currentStructureList=[];newCreatedElement=null;pendingElements=[];activeNode=null;parentActiveNode=null;parentSelected=!1;isEmptyStructure=!1;isStartingWithPlus=!1;isNoActiveElement=!1;bricksVueRoot=null;bricksVueActiveElement=null;bricksVueContent=null;bricksVueGlobalClasses=[];bricksNewCreatedElements=[];constructor(){this.init()}init(){this.prepare(),this.placeIcon(),this.getBricksElements(),this.getBricksGlobalClasses(),this.getVueData(),this.getHistory(),this.handleShortcuts(),this.listeners()}async prepare(){let e=document.createElement("div");e.id="bricksforge-terminal";let t=document.createElement("input");t.id="bricksforge-terminal-input";let s=document.createElement("div");s.id="bricksforge-terminal-input-wrapper",s.appendChild(t),this.createAutoCompleteElements(s),e.appendChild(s),e.style.display="none",document.body.appendChild(e),document.addEventListener("keydown",(s=>{s.ctrlKey&&"t"===s.key&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none"),s.ctrlKey&&s.shiftKey&&("T"===s.key||"t"===s.key)&&("none"==e.style.display?(e.style.display="flex",t.focus()):e.style.display="none")})),document.addEventListener("keydown",(t=>{"flex"==e.style.display&&"Escape"===t.key&&(e.style.display="none")})),e.addEventListener("keydown",(async s=>{"flex"==e.style.display&&"Enter"===s.key&&(this.command=t.value,t.value="",await this.execute(this.command),e.style.display="none",document.body.classList.remove("brf-executing"))})),e.addEventListener("keyup",(async e=>{if("ArrowDown"===e.key||"ArrowUp"===e.key||"Enter"===e.key)return;const s=e.target.value;(s.includes(">")||s.includes("+")||s.includes(".")||t)&&this.handleAutocomplete.call(this,s)}))}handleAutocomplete(e){const t=e.split(/[>+~\s]/),s=t[t.length-1].trim();if(/(?<![>+~\s])\./.test(s)){const e=s.split("."),t=e[e.length-1].trim();this.autoComplete({completionFor:"globalClasses",value:t})}else this.autoComplete({completionFor:"elements",value:s})}placeIcon(){let e=document.querySelector("#bricks-toolbar ul.group-wrapper.left"),t=document.createElement("li");t.classList.add("brf-terminal"),t.setAttribute("data-balloon","Bricksforge Terminal (Shortcut: CTRL + T)"),t.setAttribute("data-balloon-pos","bottom");let s=document.createElement("span");s.classList.add("bricks-svg-wrapper"),t.appendChild(s),e&&e.appendChild(t);let i=document.querySelector("#bricksforge-terminal"),l=document.querySelector("#bricksforge-terminal-input");document.querySelector("#bricks-toolbar .brf-terminal").addEventListener("click",(e=>{"none"==i.style.display?(i.style.display="flex",l.focus()):i.style.display="none"}))}getBricksElements(){if(bricksData)for(let e in bricksData.elements)this.bricksElements.push(e)}getBricksGlobalClasses(){if(bricksData&&bricksData.loadData.globalClasses&&0!=bricksData.loadData.globalClasses.length)for(let e of bricksData.loadData.globalClasses)this.bricksGlobalClasses.push(e.name)}async getVueData(){this.bricksVueRoot=document.querySelector(".brx-body").__vue_app__.config.globalProperties,this.bricksVueState=this.bricksVueRoot.$_state,this.bricksVueContent=this.bricksVueState.content,this.bricksVueActiveElement=this.bricksVueState.activeElement,this.bricksVueGlobalClasses=this.bricksVueState.globalClasses}createAutoCompleteElements(e){let t=document.createElement("div");t.id="bricksforge-terminal-autocomplete";let s=document.createElement("div");s.classList.add("bricksforge-terminal-autocomplete-list"),t.appendChild(s),e.appendChild(t)}handleShortcuts(){this.navigateHistory()}async autoComplete({completionFor:e,value:t}){let s,i=document.querySelector(".bricksforge-terminal-autocomplete-list");if(i.innerHTML="",!t||0===t.length||" "===t||""===t)return void this.closeAutoCompletion();let l=document.querySelector("#bricksforge-terminal-input");switch(e){case"elements":s=this.bricksElements;break;case"globalClasses":s=this.bricksGlobalClasses}if(s&&s.length>0){s.forEach((s=>{if("globalClasses"==e&&t.includes(".")&&(t=t.split(".")[1]),s.startsWith(t)){this.openAutoCompletion();let n=document.createElement("div");n.classList.add("bricksforge-terminal-autocomplete-item"),n.innerHTML=s,i.appendChild(n),n.addEventListener("click",(s=>{let i=l.value.split(" ").reverse(),n=-1;for(let e=0;e<i.length;e++)if(i[e].startsWith(t)||i[e].split(".")[i[e].split(".").length-1].startsWith(t)){n=e;break}n>-1&&("elements"==e?i[n]=s.target.innerHTML:"globalClasses"==e&&(i[n]=i[n].split(".").slice(0,-1).join(".")+"."+s.target.innerHTML)),l.value=i.reverse().join(" "),l.focus(),this.closeAutoCompletion()}))}}));let n=-1;document.querySelector("#bricksforge-terminal-input").addEventListener("keydown",(e=>{if("ArrowDown"===e.key){let e=document.querySelectorAll(".bricksforge-terminal-autocomplete-item");e.length>0&&(n++,n>=e.length&&(n=0),e.forEach(((e,t)=>{t!==n&&e.classList.remove("selected")})),e[n].classList.add("selected"),e[n].scrollIntoView({block:"center",behavior:"smooth",inline:"nearest",offsetTop:50}))}if("ArrowUp"===e.key){let e=document.querySelectorAll(".bricksforge-terminal-autocomplete-item");e.length>0&&(n--,n<0&&(n=e.length-1),e.forEach(((e,t)=>{t!==n&&e.classList.remove("selected")})),e[n].classList.add("selected"),e[n].focus(),e[n].scrollIntoView({block:"center",behavior:"smooth",inline:"nearest",offsetTop:50}))}}))}}autoCompletionListIsEmpty(){return document.querySelector(".bricksforge-terminal-autocomplete-item")}openAutoCompletion(){let e=document.querySelector("#bricksforge-terminal-autocomplete");e&&(e.style.display="block")}closeAutoCompletion(){let e=document.querySelector("#bricksforge-terminal-autocomplete");e&&(e.style.display="none")}navigateHistory(){this.historyIndex=this.history.length;let e=document.querySelector("#bricksforge-terminal-input");this.currentCommandIndex,e.addEventListener("keydown",(t=>{if(!document.querySelector("#bricksforge-terminal-autocomplete")||"none"==document.querySelector("#bricksforge-terminal-autocomplete").style.display)if("ArrowUp"===t.key){t.preventDefault(),this.historyIndex>0&&this.historyIndex--;let s=this.history[this.historyIndex];this.command=s,this.command&&(e.value=this.command)}else if("ArrowDown"==t.key){t.preventDefault(),this.historyIndex<this.history.length&&this.historyIndex++,this.historyIndex==this.history.length&&(this.command="",e.value=this.command);let s=this.history[this.historyIndex];this.command=s,this.command&&(e.value=this.command)}}))}async execute(e){return document.body.classList.add("brf-executing"),new Promise((async(t,s)=>{let i;switch(e.startsWith(".")?i="addClasses":e.startsWith(">")&&(i="addElements"),this.addHistory(e),i){case"addClasses":await this.addClasses(e);break;case"addElements":await this.addElements(e),this.pendingElements=[],this.isEmptyStructure=!1,this.isStartingWithPlus=!1;break;default:console.warn("Unknown Terminal Method")}t()}))}async addClasses(e){return new Promise((async(t,s)=>{try{let s=e.split(".");s=s.filter((e=>e));for(let e=0;e<s.length;e++)s[e]=s[e].replace(/\s+/,""),this.addClass(s[e]),t()}catch(e){console.log(e),s()}}))}addClass(e){if(this.getVueData(),!this.bricksVueActiveElement)return void console.warn("Bricksforge Terminal: There is no active element. No class was added.");let t=this.createGlobalClassIfNotExists(e);this.bricksVueActiveElement.settings._cssGlobalClasses||(this.bricksVueActiveElement.settings._cssGlobalClasses=[]),this.bricksVueActiveElement.settings._cssGlobalClasses.push(t)}createGlobalClassIfNotExists(e){this.getVueData();let t=this.bricksVueRoot.$_generateId();return this.bricksVueGlobalClasses.find((t=>t.name==e))?t=this.bricksVueGlobalClasses.find((t=>t.name==e)).id:this.bricksVueGlobalClasses.push({name:e,id:t,settings:[]}),this.getVueData(),t}async addElements(e){this.addElement(e)}async addElement(e){this.getVueData(),this.bricksNewCreatedElements=[];const t=this.bricksVueState.content,s=e=>{const[t,s]=e.split("*"),i=parseInt(s,10)||1;return Array.from({length:i},(()=>{const e=t.split(">").map((e=>o(e.trim())));return{name:e[0].name,settings:e[0].settings,children:e.slice(1)}}))},i=(e,t=0,n=[null])=>{if(t>=e.length)return;const r=e[t],o=s(r);let a=null;if(n.forEach((e=>{e&&o.forEach((t=>{a?r.includes(">")?(a.children.push(t),a=t):(e.children||(e.children=[]),e.children.push(t),a=t):(a=t,e.children||(e.children=[]),e.children.push(a))}))})),e[t]&&e[t].includes("+")){const s=e[t].split("+").map((e=>e.trim())).filter((e=>""!==e));l(s.join("+"),o),i(e,t+1,o)}if(e[t+1]&&e[t+1].includes("+")){const s=e[t+1].split("+").map((e=>e.trim())).filter((e=>""!==e));l(s.join("+"),o),i(e,t+2,o)}else i(e,t+1,o);return o[0]},l=(e,t)=>{const i=e.split("+").map((e=>e.trim())).filter((e=>""!==e)).flatMap((e=>s(e)));t.forEach((e=>{e&&i.forEach((t=>{e.children||(e.children=[]),e.children.push(t)}))}))},n=e=>{e.forEach((e=>{let t=[];if(e.includes(".")){let s=e.split(".");s.shift(),s.forEach((e=>{t.push(this.createGlobalClassIfNotExists(e))})),e=e.split(".")[0]}const s={id:this.bricksVueRoot.$_generateId(),name:e,parent:null,children:[],settings:{_cssGlobalClasses:t}};this.bricksVueContent.push(s)}))},r=e=>{const t=/\[(.*?)\]/g;let s,i=[];for(;null!==(s=t.exec(e));){const e=s[1].split(";").map((e=>{const[t,s]=e.split("=");return{id:this.bricksVueRoot.$_generateId(),name:t.trim(),value:s.trim()}}));i=[...i,...e]}return{elementStr:e=e.replace(t,"").trim(),attrs:i}},o=e=>{const{elementStr:t,attrs:s}=r(e);let[i,...l]=t.split(/([.#])/),n=null,o=[];for(let e=0;e<l.length;e+=2)"#"===l[e]?n=l[e+1]:"."===l[e]&&o.push(this.createGlobalClassIfNotExists(l[e+1]));return{name:i.trim(),settings:{_cssId:n,_cssGlobalClasses:o,_attributes:s},children:[]}},a=(e,t)=>{const s=this.bricksVueRoot.$_generateId(),i=e.children.map((e=>a(e,s)));let l=this.bricksVueContent.find((e=>e.id===t));var n;l&&"section"!==(n=l.name)&&"div"!==n&&"block"!==n&&"container"!==n&&(t=l.parent);const r={id:s,name:e.name,parent:t,children:i,settings:{...e.settings._cssGlobalClasses.length>0&&{_cssGlobalClasses:e.settings._cssGlobalClasses},...e.settings._attributes.length>0&&{_attributes:e.settings._attributes},...e.settings._cssId&&{_cssId:e.settings._cssId}}};if(u.push(r),0!=t){const e=this.bricksVueContent.findIndex((e=>e.id===t));this.bricksVueContent[e]&&this.bricksVueContent[e].children.push(s)}return s},c=e.split(">").map((e=>e.trim())).filter((e=>""!==e));if(c[0].includes("+")){return void n(c[0].split("+").map((e=>e.trim())).filter((e=>""!==e)))}const d=i(c,0,[null]),u=[];if(c[0].includes("*")){const[e,t]=c[0].split("*"),s=o(e);for(let e=0;e<t-1;e++)a(s,this.bricksVueActiveElement?this.bricksVueActiveElement.id:0)}a(d,this.bricksVueActiveElement?this.bricksVueActiveElement.id:0),this.bricksVueContent.push(...u);const h=this.bricksVueState.content;this.bricksNewCreatedElements=this.findNewCreatedElements(t,h)}findNewCreatedElements(e,t){const s=t.filter((t=>!e.includes(t)));return s[s.length-1]}getHistory(){BRFTERMINAL.history&&"object"==typeof BRFTERMINAL.history&&BRFTERMINAL.history.length&&(this.history=BRFTERMINAL.history,this.historyIndex=this.history.length)}async addHistory(e){if(!e||0==e.trim().length)return;if(!this.history||"object"!=typeof this.history)return;this.history.push(e),this.history.length>50&&this.history.shift();await fetch(BRFTERMINAL.apiurl+"save_option",{method:"POST",headers:{"X-WP-Nonce":BRFTERMINAL.nonce,"Content-Type":"application/json"},body:JSON.stringify(["brf_terminal_history",this.history])});this.historyIndex=this.history.length}listeners(){document.querySelector("#bricksforge-terminal-input").addEventListener("keydown",(e=>{"none"!=document.querySelector("#bricksforge-terminal-autocomplete").style.display&&document.querySelector(".bricksforge-terminal-autocomplete-item.selected")&&"Enter"===e.key&&(e.stopPropagation(),e.preventDefault(),document.querySelector(".bricksforge-terminal-autocomplete-item.selected").click())}))}wait(e=10){return new Promise((t=>{setTimeout(t,e)}))}}document.addEventListener("DOMContentLoaded",(function(){new BricksforgeTerminal}));