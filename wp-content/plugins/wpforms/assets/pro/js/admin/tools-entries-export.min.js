"use strict";var WPFormsEntriesExport=window.WPFormsEntriesExport||function(e,t,r){var i={$form:r("#wpforms-tools-entries-export"),$selectForm:r("#wpforms-tools-entries-export-selectform"),$selectFormSpinner:r("#wpforms-tools-entries-export-selectform-spinner"),$selectFormMsg:r("#wpforms-tools-entries-export-selectform-msg"),$expOptions:r("#wpforms-tools-entries-export-options"),$fieldsCheckboxes:r("#wpforms-tools-entries-export-options-fields-checkboxes"),$dateSection:r("#wpforms-tools-entries-export-options-date"),$dateFlatpickr:r("#wpforms-tools-entries-export-options-date-flatpickr"),$searchSection:r("#wpforms-tools-entries-export-options-search"),$searchField:r("#wpforms-tools-entries-export-options-search-field"),$submitButton:r("#wpforms-tools-entries-export-submit"),$cancelButton:r("#wpforms-tools-entries-export-cancel"),$processMsg:r("#wpforms-tools-entries-export-process-msg")},a=wpforms_tools_entries_export.i18n,n={},l={formsCache:{},init:function(){r(l.ready)},ready:function(){n.processing=!1,l.initDateRange(),l.initFormCont(),l.initSubmit(),l.events()},events:function(){i.$selectForm[0].addEventListener("choice",function(e){e.detail.choice.placeholder?i.$expOptions.addClass("hidden"):n.formID!==e.detail.choice.value&&(n.formID=e.detail.choice.value,void 0===l.formsCache[n.formID]?l.retrieveFormAndRenderFields():l.renderFields(l.formsCache[n.formID]))}),r(e).on("change","#wpforms-tools-entries-export-options .wpforms-toggle-all",function(){const e=r(this),o=e.find("input"),s=e.siblings().find("input");s.prop("checked",o.prop("checked"))}),r(e).on("change","#wpforms-tools-entries-export-options-fields-checkboxes label, #wpforms-tools-entries-export-options-additional-info label",function(){const e=r(this);if(!e.hasClass("wpforms-toggle-all")){const s=e.parent().find("label").not(".wpforms-toggle-all").find("input");var o=s.filter(function(e){return r(this).is(":checked")});const t=e.siblings(".wpforms-toggle-all").find("input");t.prop("checked",o.length===s.length)}}),r(e).on("csv_file_error",function(e,o){l.displaySubmitMsg(o,"error")})},retrieveFormAndRenderFields:function(){n.ajaxData={action:"wpforms_tools_entries_export_form_data",nonce:wpforms_tools_entries_export.nonce,form:n.formID},i.$selectFormSpinner.removeClass("hidden"),l.displayFormsMsg(""),r.get(ajaxurl,n.ajaxData).done(function(e){e.success?(l.renderFields(e.data.fields),l.formsCache[n.formID]=e.data.fields,i.$expOptions.removeClass("hidden")):(l.displayFormsMsg(e.data.error),i.$expOptions.addClass("hidden"))}).fail(function(e,o,s){l.displayFormsMsg(a.error_prefix+":<br>"+s),i.$expOptions.addClass("hidden")}).always(function(){i.$selectFormSpinner.addClass("hidden")})},exportAjaxStep:function(e){n.processing&&(e=l.getAjaxPostData(e),r.post(ajaxurl,e).done(function(e){var o;clearTimeout(n.timerId),e.success?0===e.data.count?l.displaySubmitMsg(a.prc_2_no_entries):(o=a.prc_3_done,o+="<br>"+a.prc_3_download+', <a href="#" class="wpforms-download-link">'+a.prc_3_click_here+"</a>.",l.displaySubmitMsg(o,"info"),l.triggerDownload(e.data.request_id)):l.displaySubmitMsg(e.data.error,"error")}).fail(function(e,o,s){clearTimeout(n.timerId),l.displaySubmitMsg(a.error_prefix+":<br>"+s,"error")}).always(function(){l.displaySubmitSpinner(!1)}))},getAjaxPostData:function(e){var o;return"first-step"===e?(o=i.$form.serializeArray().reduce(function(e,o){return e[o.name]=o.value,e},{}),i.$fieldsCheckboxes.find("input").length<1&&(o.date="",o["search[term]"]="")):o={action:"wpforms_tools_entries_export_step",nonce:wpforms_tools_entries_export.nonce,request_id:e},o},initSubmit:function(){i.$submitButton.on("click",function(e){e.preventDefault(),r(this).hasClass("wpforms-btn-spinner-on")||(i.$submitButton.blur(),l.displaySubmitSpinner(!0),l.displaySubmitMsg(""),n.timerId=setTimeout(function(){l.displaySubmitMsg(a.prc_1_filtering+"<br>"+a.prc_1_please_wait,"info")},3e3),l.exportAjaxStep("first-step"))}),i.$cancelButton.on("click",function(e){e.preventDefault(),i.$cancelButton.blur(),l.displaySubmitMsg(""),l.displaySubmitSpinner(!1)})},initFormCont:function(){0<wpforms_tools_entries_export.form_id&&(i.$expOptions.removeClass("hidden"),i.$fieldsCheckboxes.find("input").length<1&&(i.$dateSection.addClass("hidden"),i.$searchSection.addClass("hidden")))},initDateRange:function(){var e=wpforms_tools_entries_export.lang_code,o=t.flatpickr,s={rangeSeparator:" - "};"undefined"!==o&&o.hasOwnProperty("l10ns")&&o.l10ns.hasOwnProperty(e)&&((s=o.l10ns[e]).rangeSeparator=" - "),i.$dateFlatpickr.flatpickr({altInput:!0,altFormat:"M j, Y",dateFormat:"Y-m-d",locale:s,mode:"range",defaultDate:wpforms_tools_entries_export.dates})},renderFields:function(r){var n,e;"object"==typeof r&&(n={checkboxes:"",options:""},0===(e=Object.keys(r)).length?(n.checkboxes="<span>"+a.error_form_empty+"</span>",i.$dateSection.addClass("hidden"),i.$searchSection.addClass("hidden")):(n.checkboxes+='<label class="wpforms-toggle-all"><input type="checkbox" checked> '+a.label_select_all+"</label>",e.forEach(function(e,o){var s='<label><input type="checkbox" name="fields[{i}]" value="{id}" checked> {label}</label>',t=parseInt(r[e].id,10),o=(s=(s=(s=s.replace("{i}",parseInt(o,10))).replace("{id}",t)).replace("{label}",r[e].label),n.checkboxes+=s,'<option value="{id}">{label}</option>');o=(o=o.replace("{id}",t)).replace("{label}",r[e].label),n.options+=o}),i.$dateSection.removeClass("hidden"),i.$searchSection.removeClass("hidden")),i.$fieldsCheckboxes.html(n.checkboxes),i.$searchField.find("optgroup:first-child option:not(:first-child)").remove(),i.$searchField.find("optgroup:first-child").append(n.options))},displaySubmitSpinner:function(e){e?(i.$submitButton.addClass("wpforms-btn-spinner-on"),i.$cancelButton.removeClass("hidden"),n.processing=!0):(i.$submitButton.removeClass("wpforms-btn-spinner-on"),i.$cancelButton.addClass("hidden"),n.processing=!1)},displayFormsMsg:function(e){i.$selectFormMsg.html(e),0<e.length?i.$selectFormMsg.removeClass("hidden"):i.$selectFormMsg.addClass("hidden")},displaySubmitMsg:function(e,o){o&&"error"===o?i.$processMsg.addClass("wpforms-error"):i.$processMsg.removeClass("wpforms-error"),i.$processMsg.html(e),0<e.length?i.$processMsg.removeClass("hidden"):i.$processMsg.addClass("hidden")},triggerDownload:function(e){var o=wpforms_tools_entries_export.export_page,o=(o+="&action=wpforms_tools_entries_export_download")+("&nonce="+wpforms_tools_entries_export.nonce)+("&request_id="+e);i.$expOptions.find("iframe").remove(),i.$expOptions.append('<iframe src="'+o+'"></iframe>'),i.$processMsg.find(".wpforms-download-link").attr("href",o)}};return l}(document,window,jQuery);WPFormsEntriesExport.init();