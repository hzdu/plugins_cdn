!function(){var e={40610:function(e){e.exports=Backbone.Collection.extend({modelId:e=>`${e.id}-${e.key||"0"}`,isOptimized(){return this.models.every((e=>e.get("optimized")||e.get("failed")))},getItemToOptimize(){return this.find({optimized:!1,failed:!1})},resetOptimization(){this.each((e=>e.set({optimized:!1})))},getStatus(){let e;return e=this.findWhere({optimized:!1})?this.findWhere({loading:!0})?"running":this.findWhere({failed:!0})?"fail":"":"optimized",e}})},49466:function(e){var t;t=jQuery,e.exports={tpl(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.includes("lightspeed-")||(e=`lightspeed-${e}`);const n=t("script#"+e.replace(/\//g,"-")).html()||"";return _.template(n)(i)},secondsToTime(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;e=parseInt(e);const t=parseInt(e/3600),i=parseInt((e-3600*t)/60),n=e-3600*t-60*i;let o="";return t&&(o=`${t} hour${1===t?"":"s"}`),i&&(t&&(o+=", "),o+=`${i} minute${1===i?"":"s"} `),n&&((i||t)&&(o+=" and "),o+=`${n} second${1===n?"":"s"}`),o},getTotalItems:()=>Lightspeed.collections.reduce(((e,t)=>e+t.length),0),getOptimizedItems:()=>Lightspeed.collections.reduce(((e,t)=>e+t.where({optimized:!0}).length),0),getFailedItems:()=>Lightspeed.collections.reduce(((e,t)=>e+t.where({failed:!0}).length),0),ajax(e,i){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t.ajax({url:`${Lightspeed.CONST.route}/${e}`,headers:{"X-WP-Nonce":Lightspeed.CONST.nonce},type:i,data:n})},getOptimizationIframe(){const e=`lightspeed-optimization-iframe-${arguments.length>0&&void 0!==arguments[0]?arguments[0]:"all"}`;let i=t(`#${e}`);return 0===i.length&&(i=t(`<iframe id="${e}" class="tve-ls-optimization-frame">`).appendTo(t("body"))),i}}},11555:function(e,t,i){e.exports={optimization:{main:i(7022),analyze:i(48027),optimize:i(19791),finished:i(53934)},fonts:{main:i(12708)},advanced:{main:i(25763)}}},25763:function(e,t,i){function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const s=i(49466),r=i(59908),a=i(40610),l=i(19791);e.exports=Backbone.View.extend({initialize(){this.initializeOptimize(),this.$progressBar=new r,this.optimizedItems=0},initializeOptimize(){this.optimize=new l,this.optimize.updateProgress=()=>{const e=s.getOptimizedItems(),t=s.getTotalItems();this.$progressBar.updateProgress(100*e/t)},this.optimize.$el=this.$el,this.optimize.onFinished=()=>{s.getOptimizationIframe().remove(),window.location.href.includes("#advanced/main")&&(this.$progressBar.updateProgress(100),this.$(".ls-save-advanced-settings").removeClass("tvd-disabled").text("Save"),this.$(".progress-bar-wrapper").hide())}},events:{"click .ls-save-advanced-settings":"saveAdvancedSettings"},render(){this.$el.html(s.tpl("advanced-settings/main",function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){o(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},Lightspeed.CONST.options))),this.$(".progress-bar-wrapper").html(this.$progressBar.render())},saveAdvancedSettings(){const e=[];this.$el.find(".ls-advanced-setting-input").each(((t,i)=>{const n=i.dataset.key,o=i.checked?1:0;s.ajax("options","POST",{key:n,value:o}),Lightspeed.CONST.options[n]=o,i.checked&&e.push(i.dataset.key)})),this.advancedAssetsOptimize(e)},advancedAssetsOptimize:function(e){const t=[],i=e.some((e=>e.includes("woo"))),n=e.some((e=>e.includes("gutenberg")));if(e.some((e=>e.includes("lp")))&&t.push("lp"),e.length&&e.some((e=>!e.includes("lp")))&&t.push("ttb"),this.$(".ls-save-advanced-settings").addClass("tvd-disabled").text("Saving"),this.$(".progress-bar-wrapper").show(),t.length)s.ajax("analyze","GET",{to_analyze:t}).then((e=>{Lightspeed.collections=[],Lightspeed.groups=Object.values(e).map((e=>(e.collection=new a(e.items.map((e=>(e.failed=!1,e.optimized=!0,i&&!e.woo_optimized&&(e.optimized=!1),n&&!e.gutenberg_optimized&&(e.optimized=!1),e)))),Lightspeed.collections.push(e.collection),e))),this.optimize.optimizeItems()}));else{let e=0;const t=setInterval((()=>{e<=100?this.$progressBar.updateProgress(e):(this.optimize.onFinished(),clearInterval(t)),e+=2}),15)}},decodeUrl:e=>e.replace(/&#038;/g,"&")})},12708:function(e,t,i){function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function o(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){s(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const r=i(49466);e.exports=Backbone.View.extend({events:{"click .ls-setting-input":"toggleOption"},render(){this.$el.html(r.tpl("fonts/main",o(o({},Lightspeed.CONST.options),{},{canOptimizeFonts:!Lightspeed.CONST.options.tve_google_fonts_disable_api_call,canLoadFontsAsync:!Lightspeed.CONST.options.tve_google_fonts_disable_api_call&&Lightspeed.CONST.options._tve_enable_fonts_optimization})))},toggleOption(e){const t=e.currentTarget.dataset.key,i=e.currentTarget.checked?1:0;switch(t){case"tve_google_fonts_disable_api_call":i&&(this.updateOption("_tve_enable_fonts_optimization",0),this.updateOption("_tve_enable_fonts_async_load",0));break;case"_tve_enable_fonts_optimization":i||this.updateOption("_tve_enable_fonts_async_load",0)}this.updateOption(t,i)},updateOption(e,t){r.ajax("options","POST",{key:e,value:t}).then((()=>{Lightspeed.CONST.options[e]=t,"fonts/main"===Backbone.history.fragment&&this.render()}))}})},27264:function(e,t,i){function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function o(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){s(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const r=i(49466),a={optimization:{label:"Asset Optimization",url:"#optimization/main"},fonts:{label:"Font Settings",url:"#fonts/main"},advanced:{label:"Advanced Settings",url:"#advanced/main"}};e.exports=Backbone.View.extend({el:"#lightspeed-admin-wrapper",render(){this.$el.html(r.tpl("main")),Lightspeed.router.on("route",this.updateBreadcrumbs.bind(this))},updateBreadcrumbs(){const e=Backbone.history.getFragment().replace(/\/.*/g,""),t=this.$("#ls-menu-container").empty();Object.values(a).forEach((i=>{t.append(r.tpl("menu-item",o(o({},i),{},{currentRoute:e})))})),jQuery(".ls-breadcrumbs > span").html(a[e].label)}})},48027:function(e,t,i){const n=i(49466),o=i(54455);e.exports=Backbone.View.extend({events:{"click .lightspeed-optimize":"optimize","click .lightspeed-force-optimize":"forceOptimize"},initialize(){this.$toggle=new o},render(){const e={totalItems:n.getTotalItems(),optimizedItems:n.getOptimizedItems()},t=this.getState(e.optimizedItems,e.totalItems);return this.$el.html(n.tpl(`optimization/${t}-optimized`,e)),"not"!==t&&this.$(".page-footer").html(this.$toggle.render()),this},optimize(){Lightspeed.router.navigate("#optimization/optimize",{trigger:!0})},forceOptimize(){Lightspeed.collections.forEach((e=>e.resetOptimization())),this.optimize()},getState(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;switch(!0){case 0===t:e="not";break;case t===(arguments.length>1&&void 0!==arguments[1]?arguments[1]:0):e="all";break;default:e="partially"}return e}})},53934:function(e,t,i){const n=i(49466);e.exports=Backbone.View.extend({events:{"click .go-to-home":()=>Lightspeed.router.navigate("#optimization/analyze",{trigger:!0}),"click .show-failed":"showFailedItems"},render(){return this.$el.html(n.tpl("optimization/finished",{optimizationTime:n.secondsToTime((performance.now()-Lightspeed.startedTime)/1e3),optimizedItems:n.getOptimizedItems(),failedItems:n.getFailedItems()})),this.$failedItems=this.$(".failed-items").hide(),this},showFailedItems(){this.$failedItems.empty();let e=1;Lightspeed.collections.forEach((t=>{t.where({optimized:!1}).forEach((t=>{this.$failedItems.append(n.tpl("optimization/failed-item",{index:e,group:t.get("group"),name:t.get("name")})),e++}))})),this.$failedItems.slideDown()}})},94919:function(e,t,i){const n=i(49466);e.exports=Backbone.View.extend({className:"text-paragraph optimize-item",initialize(e){this.label=e.label,this.type=e.type,this.collection.each((e=>{e.set({failed:!1}),this.listenTo(e,"change",(e=>{e.get("failed")&&e.set({group:this.label},{silent:!0}),this.render()}))}))},render(){return this.$el.html(n.tpl("optimization/group",{label:this.label,items:this.collection,status:this.collection.getStatus()})),this.$el}})},7022:function(e,t,i){function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function o(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){s(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const r=i(49466),a=i(54455),l=i(40610);e.exports=Backbone.View.extend({events:{"click .lightspeed-analyze":"analyze"},initialize(){this.$toggle=new a},render(){return this.$el.html(r.tpl("optimization/analyze")),this.$(".page-footer").append(this.$toggle.render()),this},analyze(){this.inLoading||(this.setLoading(!0),r.ajax("analyze","GET").then((e=>{Lightspeed.collections=[],Lightspeed.groups=Object.values(e).map((e=>(e.collection=new l(e.items.map((e=>o(o({},e),{},{optimized:!!parseInt(e.optimized)})))),Lightspeed.collections.push(e.collection),e))),this.setLoading(!1),Lightspeed.router.navigate("#optimization/analyze",{trigger:!0})})))},setLoading(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.inLoading=e,this.$(".analyze-icon").toggleClass("loading",e)}})},54455:function(e,t,i){const n=i(49466);e.exports=Backbone.View.extend({events:{"click .toggle-lightspeed":"toggleLightspeed"},className:"page-optimization-toggle",render(){return this.$el.html(n.tpl("optimization/toggle",{isEnabled:Lightspeed.CONST.options.is_enabled})),this.$el},toggleLightspeed(e){const t=e.currentTarget.checked?1:0;n.ajax("options","POST",{key:"_tve_enable_lightspeed",value:t}).then((()=>{Lightspeed.CONST.options.is_enabled=t,this.trigger("toggle",t)}))}})},19791:function(e,t,i){const n=i(49466),o=i(59908),s=i(94919);e.exports=Backbone.View.extend({initialize(){this.$progressBar=new o,this.optimizedItems=0,window.addEventListener("message",(e=>{e.data&&"lightspeed-optimize"===e.data.from&&this.onOptimize(e.data)})),window.TVE_LS_API=this},resizeFrame(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all";return new Promise((i=>{n.getOptimizationIframe(t).css("width",e+"px"),requestAnimationFrame(i)}))},onOptimize(e){clearTimeout(this.waitingTimeout);let t=this.getOptimizingModel(e.id,e.key);this.optimizedItems++;const i={loading:!1,failed:void 0===t,optimized:void 0!==t};void 0===t&&Lightspeed.collections.find((e=>(t=e.findWhere({loading:!0}),!!t))),t&&t.set(i),this.optimizeItems()},render(){return this.$el.html(n.tpl("optimization/progress")),this.$(".progress-bar-wrapper").html(this.$progressBar.render()),Lightspeed.groups.forEach((e=>{const t=new s(e);this.$(".groups-to-optimize").append(t.render())})),setTimeout((()=>{Lightspeed.startedTime=performance.now(),this.optimizeItems()}),24),this},updateProgress(){const e=n.getOptimizedItems(),t=n.getTotalItems();this.$progressBar.updateProgress(100*e/t);const i=(performance.now()-Lightspeed.startedTime)/1e3;this.$(".optimization-time").html(n.secondsToTime(i/this.optimizedItems*(t-e))),this.$(".optimized-items").html(e),this.$(".total-items").html(t);const o=n.getFailedItems();this.$(".failed-optimization-wrapper").toggle(0!==o),0!==o&&this.$(".optimization-failed-items").html(o)},optimizeItems(){this.updateProgress();const e=Lightspeed.collections.find((e=>!e.isOptimized()));if(e){const t=e.getItemToOptimize();if(t){t.set("loading",!0),this.$(".item-in-progress").html(t.get("name"));const e=new URL(this.decodeUrl(t.get("url"))),i=["force-flat","force-all-js","tcb-lightspeed-optimize"];window.location.href.includes("#advanced/main")&&i.push("tcb-advanced-optimize"),i.forEach((t=>{e.searchParams.append(t,1)})),n.getOptimizationIframe().css("width","").attr("src",`${e.href}`),this.waitingTimeout=setTimeout((()=>{t.set({loading:!1,failed:!0,optimized:!1}),Lightspeed.startedTime-=Lightspeed.CONST.timeout,this.optimizeItems()}),Lightspeed.CONST.timeout)}}else this.onFinished()},onFinished(){n.getOptimizationIframe().remove(),Lightspeed.router.navigate("#optimization/finished",{trigger:!0})},getOptimizingModel(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=null;return Lightspeed.collections.find((n=>(i=n.findWhere({id:e,key:t}),!!i))),i||Lightspeed.collections.find((t=>(i=t.findWhere({id:e}),!!i))),i},decodeUrl:e=>e.replace(/&#038;/g,"&")})},59908:function(e,t,i){const n=i(49466);e.exports=Backbone.View.extend({initialize(){this.model=new Backbone.Model({progress:0}),this.listenTo(this.model,"change",this.render.bind(this))},render(){return this.$el.html(n.tpl("progress-bar",{progress:this.model.get("progress")})),this.$el},updateProgress(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;e=parseInt(e),(isNaN(e)||e<0)&&(e=0),e>100&&(e=100),this.model.set("progress",e)}})}},t={};function i(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},Backbone.emulateHTTP=!0,jQuery((()=>{const e="#optimization/main",t=i(11555);window.Lightspeed={CONST:window.lightspeed_localize,groups:[],collections:{},router:new(Backbone.Router.extend({view:null,routes:{":view/:step":"loadView"},loadView:function(e,i){this.view&&(this.view.undelegateEvents(),this.view.$el.empty());const n=new(t[e]&&t[e][i]?t[e][i]:t.optimization.home)({el:"#ls-view-container"});this.view=n.render()}})),view:new(i(27264))},Lightspeed.CONST.timeout=1e3*parseInt(Lightspeed.CONST.timeout),Lightspeed.view.render(),Backbone.history.stop(),Backbone.history.start({hashchange:!0,silent:window.location.hash!==e}),Lightspeed.router.navigate(e,{trigger:!0})}))}();