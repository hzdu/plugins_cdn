!function(e,t){AW.Rules=Backbone.Model.extend({initialize:function(){var e=this,t=[];this.get("rawRuleOptions")&&_.each(this.get("rawRuleOptions"),(function(i){var l=new AW.RuleGroup(e),s=[];_.each(i,(function(e){var t=new AW.Rule(l);t.set("name",e.name),t.resetOptions(),t.set("compare",e.compare),t.set("value",e.value),e.selected&&t.set("selected",e.selected),s.push(t)})),l.set("rules",s),t.push(l)})),this.set("ruleOptions",t),this.resetAvailableRules()},defaults:function(){return{allRules:{},availableRules:{},ruleOptions:[]}},resetAvailableRules:function(){var e=AW.workflow.get("trigger");this.set("availableRules",_.filter(this.get("allRules"),(function(t){return e&&-1!==e.supplied_data_items.indexOf(t.data_item)})));var t={};_.each(this.get("availableRules"),(function(e){t[e.group]||(t[e.group]=[]),t[e.group].push(e)})),this.set("groupedRules",t)},isRuleAvailable:function(e){var t=AW.rules.get("availableRules"),i=_.pluck(t,"name");return-1!==_.indexOf(i,e)},clearIncompatibleRules:function(){var e=[];_.each(AW.rules.get("ruleOptions"),(function(t){_.each(t.get("rules"),(function(t){t&&!AW.rules.isRuleAvailable(t.get("name"))&&e.push(t)}))})),_.each(e,(function(e){e.clear()}))},createGroup:function(){var e=this.get("ruleOptions"),t=new AW.RuleGroup(this);return t.createRule(),e.push(t),this.set("ruleOptions",e),this.trigger("ruleGroupChange"),t},removeGroup:function(e){var t=this.get("ruleOptions"),i=t.map((function(e){return e.id})).indexOf(e);t[i].destroy(),t.splice(i,1),this.set("ruleOptions",t),this.trigger("ruleGroupChange")}}),AW.Rule=Backbone.Model.extend({initialize:function(e){this.set("id",_.uniqueId("rule_")),this.set("group",e),this.resetOptions()},getRuleObject:function(){return t.allRules[this.get("name")]},resetOptions:function(){var e=this.get("name"),t=this.getRuleObject();return e?this.set("object",t):this.set("object",{}),this.set("compare",!1),this.set("value",!1),this.loadSelectOptions(),this},loadSelectOptions:function(){var t=this,i=this.getRuleObject();return!i||"select"!==i.type||i.select_choices||(t.set("isValueLoading",!0),e.getJSON(ajaxurl,{action:"aw_get_rule_select_choices",rule_name:i.name},(function(e){e.success&&(i.select_choices=e.data.select_choices,t.set("isValueLoading",!1),t.set("object",i),t.trigger("optionsLoaded"))}))),this},clear:function(){this.get("group").removeRule(this.id)},destroy:function(){this.trigger("destroy")}}),AW.RuleGroup=Backbone.Model.extend({initialize:function(e){this.set("id",_.uniqueId("rule_group_")),this.set("app",e),this.set("rules",[])},createRule:function(){var e=this.get("rules"),t=new AW.Rule(this);return e.push(t),this.set("rules",e),t},removeRule:function(e){var t=this.get("rules"),i=t.map((function(e){return e.id})).indexOf(e);t.length>1?(t[i].destroy(),t.splice(i,1),this.set("rules",t)):(t[i].destroy(),this.clear())},clear:function(){this.get("app").removeGroup(this.id)},destroy:function(){this.trigger("destroy")}}),AW.RuleView=Backbone.View.extend({className:"automatewoo-rule-container",template:wp.template("aw-rule"),events:{"change .js-rule-select":"updatedName","change .js-rule-compare-field":"updatedCompare","change .js-rule-value-field":"updatedValue","click .js-remove-rule":"clear","change .js-rule-value-from":"updateMinFromValueDate"},initialize:function(){this.listenTo(this.model,"change:id",this.render),this.listenTo(this.model,"change:group",this.render),this.listenTo(this.model,"optionsLoaded",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var t=this;return t.$el.html(t.template({rule:t.model.toJSON(),groupedRules:AW.rules.get("groupedRules"),fieldNameBase:t.getFieldNameBase()})),t.setName(),t.setCompare(),t.setValue(),t.maybeToggleValueDisplay(),t.initDatepicker(),e(document.body).trigger("wc-enhanced-select-init"),this},setName:function(){this.$el.find(".js-rule-select").val(this.model.get("name"))},setCompare:function(){var e=this.$el.find(".js-rule-compare-field"),t=this.model.get("compare");if(e.filter("select").length&&!t){var i=e.find("option:first-child"),l=e.find("option:first-child").prop("value");i.prop("selected",!0),e.val(l),this.model.set("compare",l)}t&&(e.val(t),e.find('option[value~="'+t+'"]').prop("selected",!0))},setValue:function(){var t,i=this.model.get("selected"),l=this.model.get("value");if(i&&((t=this.$el.find(".js-rule-value-field")).is("select")?_.isArray(l)?_.each(l,(function(l,s){t.append(e("<option>",{value:l,text:i[s]}))})):t.append(e("<option>",{value:l,text:i})):t.attr("data-selected",i)),l){var s=this.$el.find(".js-rule-value-field"),r=this;this.hasMultipleValueFields()?(_.isArray(l)&&s.each((function(t,i){e(i).val(l[t])})),_.isObject(l)&&Object.keys(l).forEach((function(t){e(".js-rule-value-"+t,r.$el).val(l[t])}))):s.val(l)}},updatedName:function(e){this.model.set("name",e.target.value).resetOptions(),this.render()},updatedCompare:function(e){this.model.set("compare",e.target.value),this.render()},updatedValue:function(t){var i;this.hasMultipleValueFields()?(i=[],this.$el.find(".js-rule-value-field").each((function(){i.push(e(this).val())}))):i=t.target.value,this.model.set("value",i)},getFieldNameBase:function(){var e=this.model.get("id");return"aw_workflow_data[rule_options]["+this.model.get("group").id+"]["+e+"]"},clear:function(){this.model.clear()},hasMultipleValueFields:function(){var e=this.model.get("object");return e&&e.has_multiple_value_fields},maybeToggleValueDisplay:function(){var e=this.model.get("compare"),t=this.$el.find("[data-aw-compare]");t.length&&(t.addClass("aw-hidden").prop("required",!1).find("select, input").prop("required",!1),t.filter('[data-aw-compare~="'+e+'"]').removeClass("aw-hidden").prop("required",!0).find("select, input").prop("required",!0))},initDatepicker:function(){this.$el.find(".js-date-picker").datepicker({dateFormat:"yy-mm-dd",showButtonPanel:!0})},updateMinFromValueDate:function(){var e=this.$el.find(".js-rule-value-from"),t=this.$el.find(".js-rule-value-to");e.length&&t.length&&t.datepicker("option","minDate",e.val())}}),AW.RuleGroupView=Backbone.View.extend({className:"aw-rule-group",template:wp.template("aw-rule-group"),events:{"click .js-add-rule":"addRule"},initialize:function(){this.listenTo(this.model,"refreshRules",this.refreshRules),this.listenTo(this.model,"change:id",this.refreshRules),this.listenTo(this.model,"destroy",this.remove)},render:function(){var t=this;return t.model.get("rules").length&&(t.$el.html(t.template(t.model.toJSON())),t.$el.find(".rules").empty(),_.each(t.model.get("rules"),(function(e){var i=new AW.RuleView({model:e});t.$el.find(".rules").append(i.render().el)}))),e(document.body).trigger("wc-enhanced-select-init"),this},addRule:function(){var t=this.model.createRule(),i=new AW.RuleView({model:t});return this.$el.find(".rules").append(i.render().el),e(document.body).trigger("wc-enhanced-select-init"),this},refreshRules:function(){_.each(this.model.get("rules"),(function(e){e.trigger("change:group")}))},clear:function(){this.undelegateEvents(),this.model.clear()}}),AW.RulesView=Backbone.View.extend({el:e("#aw-rules-container"),$meta_box:e("#aw_rules_box"),template:wp.template("aw-rules-container"),events:{"click .js-add-rule-group":"addGroup"},initialize:function(){this.listenTo(this.model,"ruleGroupChange",this.maybeShowEmptyMessage),this.listenTo(this.model,"change:groupedRules",this.refreshRules),this.render()},render:function(){var t=this,i=AW.workflow.get("trigger");t.$el.html(t.template({app:t,trigger:i}));var l=t.$el.find(".aw-rule-groups"),s=t.model.get("ruleOptions");return s.length?_.each(s,(function(e){var t=new AW.RuleGroupView({model:e});l.append(t.render().el)})):this.addEmptyMessage(),e(document.body).trigger("wc-enhanced-select-init"),this},addGroup:function(){var t=this.model.createGroup(),i=new AW.RuleGroupView({model:t});return this.$el.find(".aw-rule-groups").append(i.render().el),e(document.body).trigger("wc-enhanced-select-init"),this},maybeShowEmptyMessage:function(){this.model.get("ruleOptions").length?this.removeEmptyMessage():this.addEmptyMessage()},addEmptyMessage:function(){this.$el.find(".aw-rule-groups").html(wp.template("aw-rule-groups-empty"))},removeEmptyMessage:function(){this.$el.find(".aw-rules-empty-message").remove()},refreshRules:function(){_.each(this.model.get("ruleOptions"),(function(e){e.trigger("refreshRules")}))}}),e((function(){AW.rules=new AW.Rules({allRules:t.allRules,rawRuleOptions:t.ruleOptions}),AW.rulesView=new AW.RulesView({model:AW.rules})}))}(jQuery,automatewooWorkflowLocalizeScript);
//# sourceMappingURL=rules.min.js.map
