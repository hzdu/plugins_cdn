/*!
 * Nestable jQuery Plugin - Copyright (c) 2014 Ramon Smit - https://github.com/RamonSmit/Nestable
 */
!function($,window,document,undefined){var hasTouch="ontouchstart"in document,hasPointerEvents=function(){var el=document.createElement("div"),docEl=document.documentElement;if(!("pointerEvents"in el.style))return!1;el.style.pointerEvents="auto",el.style.pointerEvents="x",docEl.appendChild(el);var supports=window.getComputedStyle&&"auto"===window.getComputedStyle(el,"").pointerEvents;return docEl.removeChild(el),!!supports}(),defaults={contentCallback:function(item){return item.content?item.content:item.id},listNodeName:"ol",itemNodeName:"li",handleNodeName:"div",contentNodeName:"span",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",contentClass:"dd-content",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",noChildrenClass:"dd-nochildren",emptyClass:"dd-empty",expandBtnHTML:'<button class="dd-expand" data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button class="dd-collapse" data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,fixedDepth:!1,fixed:!1,includeContent:!1,scroll:!1,scrollSensitivity:1,scrollSpeed:5,scrollTriggers:{top:40,left:40,right:-40,bottom:-40},effect:{animation:"none",time:"slow"},callback:function(l,e,p){},onDragStart:function(l,e,p){},beforeDragStop:function(l,e,p){},listRenderer:function(children,options){var html="<"+options.listNodeName+' class="'+options.listClass+'">';return html+=children,html+="</"+options.listNodeName+">"},itemRenderer:function(item_attrs,content,children,options,item){var item_attrs_string=$.map(item_attrs,function(value,key){return" "+key+'="'+value+'"'}).join(" "),html="<"+options.itemNodeName+item_attrs_string+">";return html+="<"+options.handleNodeName+' class="'+options.handleClass+'">',html+="<"+options.contentNodeName+' class="'+options.contentClass+'">',html+=content,html+="</"+options.contentNodeName+">",html+="</"+options.handleNodeName+">",html+=children,html+="</"+options.itemNodeName+">"}};function Plugin(element,options){this.w=$(document),this.el=$(element),(options=options||defaults).rootClass!==undefined&&"dd"!==options.rootClass&&(options.listClass=options.listClass?options.listClass:options.rootClass+"-list",options.itemClass=options.itemClass?options.itemClass:options.rootClass+"-item",options.dragClass=options.dragClass?options.dragClass:options.rootClass+"-dragel",options.handleClass=options.handleClass?options.handleClass:options.rootClass+"-handle",options.collapsedClass=options.collapsedClass?options.collapsedClass:options.rootClass+"-collapsed",options.placeClass=options.placeClass?options.placeClass:options.rootClass+"-placeholder",options.noDragClass=options.noDragClass?options.noDragClass:options.rootClass+"-nodrag",options.noChildrenClass=options.noChildrenClass?options.noChildrenClass:options.rootClass+"-nochildren",options.emptyClass=options.emptyClass?options.emptyClass:options.rootClass+"-empty"),this.options=$.extend({},defaults,options),this.options.json!==undefined&&this._build(),this.init()}Plugin.prototype={init:function(){var list=this;list.reset(),list.el.data("nestable-group",this.options.group),list.placeEl=$('<div class="'+list.options.placeClass+'"/>');var items=this.el.find(list.options.itemNodeName);$.each(items,function(k,el){var item=$(el),parent=item.parent();list.setParent(item),parent.hasClass(list.options.collapsedClass)&&list.collapseItem(parent.parent())}),items.length||this.appendEmptyElement(this.el),list.el.on("click","button",function(e){if(!list.dragEl){var target=$(e.currentTarget),action=target.data("action"),item=target.parents(list.options.itemNodeName).eq(0);"collapse"===action&&list.collapseItem(item),"expand"===action&&list.expandItem(item)}});var onStartEvent=function(e){var handle=$(e.target);if(!handle.hasClass(list.options.handleClass)){if(handle.closest("."+list.options.noDragClass).length)return;handle=handle.closest("."+list.options.handleClass)}handle.length&&!list.dragEl&&(list.isTouch=/^touch/.test(e.type),list.isTouch&&1!==e.touches.length||(e.preventDefault(),list.dragStart(e.touches?e.touches[0]:e)))},onMoveEvent=function(e){list.dragEl&&(e.preventDefault(),list.dragMove(e.touches?e.touches[0]:e))},onEndEvent=function(e){list.dragEl&&(e.preventDefault(),list.dragStop(e.touches?e.changedTouches[0]:e))};hasTouch&&(list.el[0].addEventListener("touchstart",onStartEvent,!1),window.addEventListener("touchmove",onMoveEvent,!1),window.addEventListener("touchend",onEndEvent,!1),window.addEventListener("touchcancel",onEndEvent,!1)),list.el.on("mousedown",onStartEvent),list.w.on("mousemove",onMoveEvent),list.w.on("mouseup",onEndEvent);list.el.bind("destroy-nestable",function(){hasTouch&&(list.el[0].removeEventListener("touchstart",onStartEvent,!1),window.removeEventListener("touchmove",onMoveEvent,!1),window.removeEventListener("touchend",onEndEvent,!1),window.removeEventListener("touchcancel",onEndEvent,!1)),list.el.off("mousedown",onStartEvent),list.w.off("mousemove",onMoveEvent),list.w.off("mouseup",onEndEvent),list.el.off("click"),list.el.unbind("destroy-nestable"),list.el.data("nestable",null)})},destroy:function(){this.el.trigger("destroy-nestable")},add:function(item){var listClassSelector="."+this.options.listClass,tree=$(this.el).children(listClassSelector);item.parent_id!==undefined&&(tree=tree.find('[data-id="'+item.parent_id+'"]'),delete item.parent_id,0===tree.children(listClassSelector).length&&(tree=tree.append(this.options.listRenderer("",this.options))),tree=tree.find(listClassSelector+":first"),this.setParent(tree.parent())),tree.append(this._buildItem(item,this.options))},replace:function(item){var html=this._buildItem(item,this.options);this._getItemById(item.id).replaceWith(html)},removeItem:function(item){var opts=this.options,el=this.el;(item=item||this).remove();var emptyListsSelector="."+opts.listClass+" ."+opts.listClass+":not(:has(*))";$(el).find(emptyListsSelector).remove();$(el).find('[data-action="expand"], [data-action="collapse"]').each(function(){0===$(this).siblings("."+opts.listClass).length&&$(this).remove()})},remove:function(itemId,callback){var opts=this.options,list=this,item=this._getItemById(itemId),animation=opts.effect.animation||"fade",time=opts.effect.time||"slow";"fade"===animation?item.fadeOut(time,function(){list.removeItem(item)}):this.removeItem(item),callback&&callback()},removeAll:function(callback){var list=this,opts=this.options,node=list.el.find(opts.listNodeName).first(),items=node.children(opts.itemNodeName),animation=opts.effect.animation||"fade",time=opts.effect.time||"slow";function remove(){items.each(function(){list.removeItem($(this))}),node.show(),callback&&callback()}"fade"===animation?node.fadeOut(time,remove):remove()},_getItemById:function(itemId){return $(this.el).children("."+this.options.listClass).find('[data-id="'+itemId+'"]')},_build:function(){var json=this.options.json;"string"==typeof json&&(json=JSON.parse(json)),$(this.el).html(this._buildList(json,this.options))},_buildList:function(items,options){if(!items)return"";var children="",that=this;return $.each(items,function(index,sub){children+=that._buildItem(sub,options)}),options.listRenderer(children,options)},_buildItem:function(item,options){var item_attrs=function(attr){delete(attr=$.extend({},attr)).children,delete attr.classes,delete attr.content;var data_attrs={};return $.each(attr,function(key,value){var map;"object"==typeof value&&(value=JSON.stringify(value)),data_attrs["data-"+key]=(map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},value+"".replace(/[&<>"']/g,function(m){return map[m]}))}),data_attrs}(item);item_attrs["class"]=function(item,options){var classes=item.classes||{};"string"==typeof classes&&(classes=[classes]);var item_classes=function(classes){var new_classes={};for(var k in classes)new_classes[classes[k]]=classes[k];return new_classes}(classes);return item_classes[options.itemClass]=options.itemClass,$.map(item_classes,function(val){return val}).join(" ")}(item,options);var content=options.contentCallback(item),children=this._buildList(item.children,options),html=$(options.itemRenderer(item_attrs,content,children,options,item));return this.setParent(html),html[0].outerHTML},serialize:function(){var list=this,step=function(level){var array=[];return level.children(list.options.itemNodeName).each(function(){var li=$(this),item=$.extend({},li.data()),sub=li.children(list.options.listNodeName);if(list.options.includeContent){var content=li.find("."+list.options.contentClass).html();content&&(item.content=content)}sub.length&&(item.children=step(sub)),array.push(item)}),array};return step(list.el.find(list.options.listNodeName).first())},asNestedSet:function(){var o=this.options,ret=[],lft=1;return this.el.find(o.listNodeName).first().children(o.itemNodeName).each(function(){lft=function traverse(item,depth,lft){var id,pid,rgt=lft+1;$(item).children(o.listNodeName).children(o.itemNodeName).length>0&&(depth++,$(item).children(o.listNodeName).children(o.itemNodeName).each(function(){rgt=traverse($(this),depth,rgt)}),depth--);id=$(item).attr("data-id");isInt(id)&&(id=parseInt(id));pid=$(item).parent(o.listNodeName).parent(o.itemNodeName).attr("data-id")||"";isInt(pid)&&(pid=parseInt(pid));id&&ret.push({id:id,parent_id:pid,depth:depth,lft:lft,rgt:rgt});lft=rgt+1;return lft}(this,0,lft)}),ret=ret.sort(function(a,b){return a.lft-b.lft});function isInt(value){return $.isNumeric(value)&&Math.floor(value)==value}},returnOptions:function(){return this.options},serialise:function(){return this.serialize()},toHierarchy:function(options){var o=$.extend({},this.options,options),ret=[];return $(this.element).children(o.items).each(function(){var level=function _recursiveItems(item){var id=($(item).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);if(id){var currentItem={id:id[2]};return $(item).children(o.listType).children(o.items).length>0&&(currentItem.children=[],$(item).children(o.listType).children(o.items).each(function(){var level=_recursiveItems(this);currentItem.children.push(level)})),currentItem}}(this);ret.push(level)}),ret},toArray:function(){var o=$.extend({},this.options,this),sDepth=o.startDepthCount||0,ret=[],left=2;return this.el.find(this.options.listNodeName).first().children(this.options.itemNodeName).each(function(){left=function _recursiveArray(item,depth,left){var id,pid,right=left+1;item.children(o.options.listNodeName).children(o.options.itemNodeName).length>0&&(depth++,item.children(o.options.listNodeName).children(o.options.itemNodeName).each(function(){right=_recursiveArray($(this),depth,right)}),depth--);id=item.data().id;if(depth===sDepth+1)pid=o.rootID;else{var parentItem=item.parent(o.options.listNodeName).parent(o.options.itemNodeName).data();pid=parentItem.id}id&&ret.push({id:id,parent_id:pid,depth:depth,left:left,right:right});left=right+1;return left}($(this),sDepth+1,left)}),ret=ret.sort(function(a,b){return a.left-b.left})},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(li){li.removeClass(this.options.collapsedClass)},collapseItem:function(li){li.children(this.options.listNodeName).length&&li.addClass(this.options.collapsedClass)},expandAll:function(){var list=this;list.el.find(list.options.itemNodeName).each(function(){list.expandItem($(this))})},collapseAll:function(){var list=this;list.el.find(list.options.itemNodeName).each(function(){list.collapseItem($(this))})},setParent:function(li){li.is(this.options.itemNodeName)&&li.children(this.options.listNodeName).length&&(li.children("[data-action]").remove(),li.prepend($(this.options.expandBtnHTML)),li.prepend($(this.options.collapseBtnHTML)))},unsetParent:function(li){li.removeClass(this.options.collapsedClass),li.children("[data-action]").remove(),li.children(this.options.listNodeName).remove()},dragStart:function(e){var mouse=this.mouse,dragItem=$(e.target).closest(this.options.itemNodeName),position={top:e.pageY,left:e.pageX},continueExecution=this.options.onDragStart.call(this,this.el,dragItem,position);if(void 0===continueExecution||!1!==continueExecution){this.placeEl.css("height",dragItem.height()),mouse.offsetX=e.pageX-dragItem.offset().left,mouse.offsetY=e.pageY-dragItem.offset().top,mouse.startX=mouse.lastX=e.pageX,mouse.startY=mouse.lastY=e.pageY,this.dragRootEl=this.el,this.dragEl=$(document.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",dragItem.outerWidth()),this.setIndexOfItem(dragItem),dragItem.after(this.placeEl),dragItem[0].parentNode.removeChild(dragItem[0]),dragItem.appendTo(this.dragEl),$(document.body).append(this.dragEl),this.dragEl.css({left:e.pageX-mouse.offsetX,top:e.pageY-mouse.offsetY});var i,depth,items=this.dragEl.find(this.options.itemNodeName);for(i=0;i<items.length;i++)(depth=$(items[i]).parents(this.options.listNodeName).length)>this.dragDepth&&(this.dragDepth=depth)}},createSubLevel:function(element,item){var list=$("<"+this.options.listNodeName+"/>").addClass(this.options.listClass);return item&&list.append(item),element.append(list),this.setParent(element),list},setIndexOfItem:function(item,index){(index=index||[]).unshift(item.index()),$(item[0].parentNode)[0]!==this.dragRootEl[0]?this.setIndexOfItem($(item[0].parentNode),index):this.dragEl.data("indexOfItem",index)},restoreItemAtIndex:function(dragElement,indexArray){var currentEl=this.el,lastIndex=indexArray.length-1;function placeElement(currentEl,dragElement){0===indexArray[lastIndex]?$(currentEl).prepend(dragElement.clone(!0)):$(currentEl.children[indexArray[lastIndex]-1]).after(dragElement.clone(!0))}for(var i=0;i<indexArray.length;i++){if(lastIndex===parseInt(i))return void placeElement(currentEl,dragElement);var element=currentEl[0]?currentEl[0]:currentEl,nextEl=element.children[indexArray[i]];currentEl=nextEl||this.createSubLevel($(element))}},dragStop:function(e){var position={top:e.pageY,left:e.pageX},srcIndex=this.dragEl.data("indexOfItem"),el=this.dragEl.children(this.options.itemNodeName).first();el[0].parentNode.removeChild(el[0]),this.dragEl.remove();var continueExecution=this.options.beforeDragStop.call(this,this.el,el,this.placeEl.parent());if(void 0!==continueExecution&&!1===continueExecution){var parent=this.placeEl.parent();return this.placeEl.remove(),parent.children().length||this.unsetParent(parent.parent()),this.restoreItemAtIndex(el,srcIndex),void this.reset()}this.placeEl.replaceWith(el),this.hasNewRoot?(!0===this.options.fixed?this.restoreItemAtIndex(el,srcIndex):this.el.trigger("lostItem"),this.dragRootEl.trigger("gainedItem")):this.dragRootEl.trigger("change"),this.options.callback.call(this,this.dragRootEl,el,position),this.reset()},dragMove:function(e){var list,parent,prev,opt=this.options,mouse=this.mouse;this.dragEl.css({left:e.pageX-mouse.offsetX,top:e.pageY-mouse.offsetY}),mouse.lastX=mouse.nowX,mouse.lastY=mouse.nowY,mouse.nowX=e.pageX,mouse.nowY=e.pageY,mouse.distX=mouse.nowX-mouse.lastX,mouse.distY=mouse.nowY-mouse.lastY,mouse.lastDirX=mouse.dirX,mouse.lastDirY=mouse.dirY,mouse.dirX=0===mouse.distX?0:mouse.distX>0?1:-1,mouse.dirY=0===mouse.distY?0:mouse.distY>0?1:-1;var newAx=Math.abs(mouse.distX)>Math.abs(mouse.distY)?1:0;if(!mouse.moving)return mouse.dirAx=newAx,void(mouse.moving=!0);if(opt.scroll&&"undefined"!=typeof window.jQuery.fn.scrollParent){var scrolled=!1,scrollParent=this.el.scrollParent()[0];scrollParent!==document&&"HTML"!==scrollParent.tagName?(opt.scrollTriggers.bottom+scrollParent.offsetHeight-e.pageY<opt.scrollSensitivity?scrollParent.scrollTop=scrolled=scrollParent.scrollTop+opt.scrollSpeed:e.pageY-opt.scrollTriggers.top<opt.scrollSensitivity&&(scrollParent.scrollTop=scrolled=scrollParent.scrollTop-opt.scrollSpeed),opt.scrollTriggers.right+scrollParent.offsetWidth-e.pageX<opt.scrollSensitivity?scrollParent.scrollLeft=scrolled=scrollParent.scrollLeft+opt.scrollSpeed:e.pageX-opt.scrollTriggers.left<opt.scrollSensitivity&&(scrollParent.scrollLeft=scrolled=scrollParent.scrollLeft-opt.scrollSpeed)):(e.pageY-$(document).scrollTop()<opt.scrollSensitivity?scrolled=$(document).scrollTop($(document).scrollTop()-opt.scrollSpeed):$(window).height()-(e.pageY-$(document).scrollTop())<opt.scrollSensitivity&&(scrolled=$(document).scrollTop($(document).scrollTop()+opt.scrollSpeed)),e.pageX-$(document).scrollLeft()<opt.scrollSensitivity?scrolled=$(document).scrollLeft($(document).scrollLeft()-opt.scrollSpeed):$(window).width()-(e.pageX-$(document).scrollLeft())<opt.scrollSensitivity&&(scrolled=$(document).scrollLeft($(document).scrollLeft()+opt.scrollSpeed)))}this.scrollTimer&&clearTimeout(this.scrollTimer),opt.scroll&&scrolled&&(this.scrollTimer=setTimeout(function(){$(window).trigger(e)},10)),mouse.dirAx!==newAx?(mouse.distAxX=0,mouse.distAxY=0):(mouse.distAxX+=Math.abs(mouse.distX),0!==mouse.dirX&&mouse.dirX!==mouse.lastDirX&&(mouse.distAxX=0),mouse.distAxY+=Math.abs(mouse.distY),0!==mouse.dirY&&mouse.dirY!==mouse.lastDirY&&(mouse.distAxY=0)),mouse.dirAx=newAx,mouse.dirAx&&mouse.distAxX>=opt.threshold&&(mouse.distAxX=0,prev=this.placeEl.prev(opt.itemNodeName),mouse.distX>0&&prev.length&&!prev.hasClass(opt.collapsedClass)&&!prev.hasClass(opt.noChildrenClass)&&(list=prev.find(opt.listNodeName).last(),this.placeEl.parents(opt.listNodeName).length+this.dragDepth<=opt.maxDepth&&(list.length?(list=prev.children(opt.listNodeName).last()).append(this.placeEl):this.createSubLevel(prev,this.placeEl))),mouse.distX<0&&(this.placeEl.next(opt.itemNodeName).length||(parent=this.placeEl.parent(),this.placeEl.closest(opt.itemNodeName).after(this.placeEl),parent.children().length||this.unsetParent(parent.parent()))));var isEmpty=!1;if(hasPointerEvents||(this.dragEl[0].style.visibility="hidden"),this.pointEl=$(document.elementFromPoint(e.pageX-document.body.scrollLeft,e.pageY-(window.pageYOffset||document.documentElement.scrollTop))),hasPointerEvents||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(opt.handleClass)&&(this.pointEl=this.pointEl.closest(opt.itemNodeName)),this.pointEl.hasClass(opt.emptyClass))isEmpty=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(opt.itemClass))return;var pointElRoot=this.pointEl.closest("."+opt.rootClass),isNewRoot=this.dragRootEl.data("nestable-id")!==pointElRoot.data("nestable-id");if(!mouse.dirAx||isNewRoot||isEmpty){if(isNewRoot&&opt.group!==pointElRoot.data("nestable-group"))return;if(this.options.fixedDepth&&this.dragDepth+1!==this.pointEl.parents(opt.listNodeName).length)return;if(this.dragDepth-1+this.pointEl.parents(opt.listNodeName).length>opt.maxDepth)return;var before=e.pageY<this.pointEl.offset().top+this.pointEl.height()/2;parent=this.placeEl.parent(),isEmpty?((list=$(document.createElement(opt.listNodeName)).addClass(opt.listClass)).append(this.placeEl),this.pointEl.replaceWith(list)):before?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),parent.children().length||this.unsetParent(parent.parent()),this.dragRootEl.find(opt.itemNodeName).length||this.appendEmptyElement(this.dragRootEl),this.dragRootEl=pointElRoot,isNewRoot&&(this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}},appendEmptyElement:function(element){element.append('<div class="'+this.options.emptyClass+'"/>')}},$.fn.nestable=function(params){var retval=this,args=arguments;return"Nestable"in window||(window.Nestable={},Nestable.counter=0),this.each(function(){var plugin=$(this).data("nestable");if(plugin){if("string"==typeof params&&"function"==typeof plugin[params])if(args.length>1){for(var pluginArgs=[],i=1;i<args.length;i++)pluginArgs.push(args[i]);retval=plugin[params].apply(plugin,pluginArgs)}else retval=plugin[params]()}else Nestable.counter++,$(this).data("nestable",new Plugin(this,params)),$(this).data("nestable-id",Nestable.counter)}),retval||this}}(window.jQuery||window.Zepto,window,document);