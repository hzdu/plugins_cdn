document.addEventListener("DOMContentLoaded",()=>{tpscrollSeq(document)});function tpscrollSeq(a){let b=a.querySelectorAll(".tpgb-scroll-sequence");b&&b.forEach(a=>{let b=a.getAttribute("data-attr");b=JSON.parse(b);let c="",d="",e=b&&b.block_id?b.block_id:"";if(b.applyto)if("body"==b.applyto)d=document.querySelector("body"),c="body";else if("container"==b.applyto){d=a.closest(".tpgb-container-row");var f=d?.getAttribute("data-id");c=".tpgb-block-"+f}else if("innerContainer"==b.applyto){d=a.closest(".tpgb-container-col");var f=d?.getAttribute("data-id");c=".tpgb-block-"+f}else"none"==b.applyto&&(d=a,a.parentElement.classList.add("tpgb-scroll-seq-parent-"+e),c=".tpgb-scroll-seq-parent-"+e);if(d&&c&&b.scrollType&&"image"==b.scrollType){function a(){y={objArray:[],absoluteOrder:[],imageTotalNo:0,priorityCount:0,nonPriorityCount:0,priorityDone:!1,nonpriorityDone:!1,firstDrawEn:!1};let a=0;y.objArray=[],y.imageTotalNo+=g.length,y.objArray=[];for(let b=0;b<g.length;b++)y.objArray[b]=new Image,y.absoluteOrder[a]=[b],++a}function f(){x={},x.scStart=document.querySelector(c).getBoundingClientRect().top+window.scrollY+i,x.scEnd=x.scStart+document.querySelector(c).clientHeight-window.innerHeight+j,x.scBetween=document.querySelector(c).clientHeight-window.innerHeight+j}function k(a){let b;a>=x.scStart&&a<x.scEnd?(b="active",a>=x.scStart&&a<x.scEnd&&(B.pageProgress=(a-x.scStart)/x.scBetween,B.image=Math.round(B.pageProgress*(g.length-1)))):a<x.scStart?b="before":b="after",z!==b&&(z=b),"active"===b&&A!==B.image&&(A=B.image,p(B.image))}function l(a,b){"scroll"===b?k(a):"resize"===b?document.documentElement.clientWidth===H?document.documentElement.clientHeight!==I&&(I=document.documentElement.clientHeight,p(B.image)):(H=document.documentElement.clientWidth,f(),p(B.image)):"orientationchange"===b?(f(),p(B.image)):console.log("Sorry error not recognized.")}function m(a,b){D||(window.requestAnimationFrame(function(){l(a,b),D=!1}),D=!0)}function n(){f(),w(window.scrollY),k(window.scrollY),"before"===z?(k(x.scStart),k(window.scrollY)):"active"===z?k(window.scrollY):"after"===z?(k(x.scEnd-1),k(window.scrollY)):void 0,window.addEventListener("scroll",()=>{m(window.scrollY,"scroll")}),window.addEventListener("resize",()=>{m(window.scrollY,"resize")}),window.addEventListener("orientationchange",()=>{m(window.scrollY,"orientationchange")});let a=0;setInterval(function(){++a,f()},1e3)}function o(){C.aascr=window.scrollY,C.active={},C.active.pageProgress=B.pageProgress,C.active.image=B.image,C.active.pixel=B.pixel,C.active.isActive=B.isActive,C.active.isActive&&(C.active.curAbsImg=r(C.active.image)),C.notActive=[],window.scrollY<x.scStart&&C.notActive.push({type:"next",distance:Math.abs(window.scrollY-x.scStart),image:0,pageProgress:0}),window.scrollY>x.scEnd&&C.notActive.push({type:"prev",distance:Math.abs(window.scrollY-x.scEnd),image:g.length-1,pageProgress:1});let a=[];for(let b=0;b<C.notActive.length;b++)a[b]=C.notActive[b].distance;a.sort((c,a)=>c-a);for(let b=0;b<C.notActive.length;b++)if(a[0]===C.notActive[b].distance){C.notActive.nearAbsImg=r(C.notActive[b].image);break}C.inCurImage=null==C.active.curAbsImg?C.notActive.nearAbsImg:C.active.curAbsImg}function p(a){if(y.objArray[a].imageLoad){let b,c,d,e=E.querySelector(".tpgb-scroll-seq-inner");b=e.offsetWidth,c=e.offsetHeight,d=b/c,F.style.width=b+"px",F.style.height=c+"px",G.canvas.width=b*1,G.canvas.height=c*1,1<=d?q(y.objArray[a]):q(y.objArray[a])}else console.log("Image [image] was not loaded in time ")}function q(a){var b=Math.max(F.width/a.width,F.height/a.height),c=F.width/2-a.width/2*b,d=F.height/2-a.height/2*b;G.drawImage(a,Math.round(c),Math.round(d),Math.ceil(a.width*b),Math.ceil(a.height*b))}function r(a){for(let b=0;b<y.imageTotalNo;b++)if(y.absoluteOrder[b][0]===a){return b}}function s(){this.imageLoad=!0,t(this.aPriority)}function t(a){if(a?++y.priorityCount:++y.nonPriorityCount,y.priorityCount>=y.priorityImageArray.length&&(y.priorityDone=!0),y.nonPriorityCount>=y.nonPriorityImageCountRequired&&(y.nonpriorityDone=!0),y.priorityDone&&y.nonpriorityDone&&!y.firstDrawEn){y.firstDrawEn=!0,n();const a=document.createEvent("Event");a.initEvent("scrollPreloadPercentage",!0,!0),document.dispatchEvent(a)}}function u(){y.priorityImageArray=[];for(let b=0;b<C.notActive.length;b++){var a=C.notActive[b].image;y.priorityImageArray[b]=r(a),y.objArray[a].aPriority=!0,y.objArray[a].aImgInfo={image:a},y.objArray[a].onload=s,y.objArray[a].src=g[a]}y.nonPriorityImageArray=((a,b)=>a.filter(a=>!b.includes(a)))(y.dumbPreloadOrder,y.priorityImageArray);for(var a,b=0;b<y.nonPriorityImageArray.length;b++)a=y.absoluteOrder[y.nonPriorityImageArray[b]][0],y.objArray[a].aPriority=!1,y.objArray[a].aImgInfo={image:a},y.objArray[a].onload=s,y.objArray[a].src=g[a];y.nonPriorityImageCountRequired=Math.round((y.imageTotalNo-y.priorityImageArray.length)*h)}function v(a,b){for(var c=[],d=0;d<b/2;d++)c[d]=2*d+1;for(var e=[],d=0;d<(b-a)/2;d++)e[d]=Math.log((b-a)/c[d])/Math.log(2);for(var f=[],d=0;d<(b-a)/2;d++){f[d]=[];for(var g=0;g<e[d];g++)f[d][g]=Math.pow(2,[g])*c[d]+a}for(var h,k=[],l=f.length,d=0;d<l;d++){h=f[d].length;for(var g=0;g<h;g++)k.push(f[d][g])}for(var m=[],d=0;d<a/2;d++)m[d]=Math.log(a/c[d])/Math.log(2);for(var n=[],d=0;d<a/2;d++){n[d]=[];for(var g=0;g<=m[d];g++)n[d][g]=-Math.pow(2,[g])*c[d]+a}for(var o,p=[],q=n.length,d=0;d<q;d++){o=n[d].length;for(var g=0;g<o;g++)p.push(n[d][g])}for(var r=[a],s=Math.max(k.length,p.length),d=0;d<s;d++)void 0!==k[d]&&r.push(k[d]),void 0!==p[d]&&r.push(p[d]);y.dumbPreloadOrder=r}function w(a){B.isActive=!1,a>=x.scStart&&a<x.scEnd&&(B.isActive=!0,a>=x.scStart&&a<x.scEnd&&(B.pageProgress=(a-x.scStart)/x.scEnd,B.image=Math.round(B.pageProgress*(g.length-1)),B.pixel=a)),B.isActive||(B.isActive=!1,B.pageProgress,B.image,B.pixel=a)}var g=b.imgGallery?b.imgGallery:"",h=b.preloadImg?b.preloadImg/100:0,i=b.startOffset?+b.startOffset:0,j=b.endOffset?+b.endOffset:0;d.insertAdjacentHTML("afterbegin",`<div class="tpgb-scroll-sequence-canvas"><div class="tpgb-scroll-seq-inner tpgb-block-${e}-canvas"><canvas/></div></div>`);let x,y,z,A,B={},C={},D=!1,E=document.querySelector(c),F=E.querySelector("canvas"),G=F.getContext("2d");a();let H,I;setTimeout(()=>{y&&y.imageTotalNo&&(f(),w(window.scrollY),o(),v(C.inCurImage,y.imageTotalNo),u())},50)}})}